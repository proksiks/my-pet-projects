import{r as ci,i as sr,b as rr,h as it,o as nr}from"./entry.7ab0c61b.js";function ar(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var ns={exports:{}};(function(a,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,n=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(l,u,c){if(c=c||{},l=l.trim(),u=u.trim(),!u){if(!c.alwaysNormalize)return l;var d=o.parseURL(l);if(!d)throw new Error("Error trying to parse base URL.");return d.path=o.normalizePath(d.path),o.buildURLFromParts(d)}var h=o.parseURL(u);if(!h)throw new Error("Error trying to parse relative URL.");if(h.scheme)return c.alwaysNormalize?(h.path=o.normalizePath(h.path),o.buildURLFromParts(h)):u;var f=o.parseURL(l);if(!f)throw new Error("Error trying to parse base URL.");if(!f.netLoc&&f.path&&f.path[0]!=="/"){var m=s.exec(f.path);f.netLoc=m[1],f.path=m[2]}f.netLoc&&!f.path&&(f.path="/");var p={scheme:f.scheme,netLoc:h.netLoc,path:null,params:h.params,query:h.query,fragment:h.fragment};if(!h.netLoc&&(p.netLoc=f.netLoc,h.path[0]!=="/"))if(!h.path)p.path=f.path,h.params||(p.params=f.params,h.query||(p.query=f.query));else{var T=f.path,x=T.substring(0,T.lastIndexOf("/")+1)+h.path;p.path=o.normalizePath(x)}return p.path===null&&(p.path=c.alwaysNormalize?o.normalizePath(h.path):h.path),o.buildURLFromParts(p)},parseURL:function(l){var u=i.exec(l);return u?{scheme:u[1]||"",netLoc:u[2]||"",path:u[3]||"",params:u[4]||"",query:u[5]||"",fragment:u[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(r,"");l.length!==(l=l.replace(n,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};a.exports=o})()})(ns);var jt=ns.exports;function di(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(a);e&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(a,s).enumerable})),t.push.apply(t,i)}return t}function ue(a){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?di(Object(t),!0).forEach(function(i){or(a,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):di(Object(t)).forEach(function(i){Object.defineProperty(a,i,Object.getOwnPropertyDescriptor(t,i))})}return a}function or(a,e,t){return e=ur(e),e in a?Object.defineProperty(a,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):a[e]=t,a}function ee(){return ee=Object.assign?Object.assign.bind():function(a){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(a[i]=t[i])}return a},ee.apply(this,arguments)}function lr(a,e){if(typeof a!="object"||a===null)return a;var t=a[Symbol.toPrimitive];if(t!==void 0){var i=t.call(a,e||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(a)}function ur(a){var e=lr(a,"string");return typeof e=="symbol"?e:String(e)}const F=Number.isFinite||function(a){return typeof a=="number"&&isFinite(a)};let g=function(a){return a.MEDIA_ATTACHING="hlsMediaAttaching",a.MEDIA_ATTACHED="hlsMediaAttached",a.MEDIA_DETACHING="hlsMediaDetaching",a.MEDIA_DETACHED="hlsMediaDetached",a.BUFFER_RESET="hlsBufferReset",a.BUFFER_CODECS="hlsBufferCodecs",a.BUFFER_CREATED="hlsBufferCreated",a.BUFFER_APPENDING="hlsBufferAppending",a.BUFFER_APPENDED="hlsBufferAppended",a.BUFFER_EOS="hlsBufferEos",a.BUFFER_FLUSHING="hlsBufferFlushing",a.BUFFER_FLUSHED="hlsBufferFlushed",a.MANIFEST_LOADING="hlsManifestLoading",a.MANIFEST_LOADED="hlsManifestLoaded",a.MANIFEST_PARSED="hlsManifestParsed",a.LEVEL_SWITCHING="hlsLevelSwitching",a.LEVEL_SWITCHED="hlsLevelSwitched",a.LEVEL_LOADING="hlsLevelLoading",a.LEVEL_LOADED="hlsLevelLoaded",a.LEVEL_UPDATED="hlsLevelUpdated",a.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",a.LEVELS_UPDATED="hlsLevelsUpdated",a.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",a.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",a.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",a.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",a.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",a.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",a.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",a.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",a.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",a.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",a.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",a.CUES_PARSED="hlsCuesParsed",a.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",a.INIT_PTS_FOUND="hlsInitPtsFound",a.FRAG_LOADING="hlsFragLoading",a.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",a.FRAG_LOADED="hlsFragLoaded",a.FRAG_DECRYPTED="hlsFragDecrypted",a.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",a.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",a.FRAG_PARSING_METADATA="hlsFragParsingMetadata",a.FRAG_PARSED="hlsFragParsed",a.FRAG_BUFFERED="hlsFragBuffered",a.FRAG_CHANGED="hlsFragChanged",a.FPS_DROP="hlsFpsDrop",a.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",a.ERROR="hlsError",a.DESTROYING="hlsDestroying",a.KEY_LOADING="hlsKeyLoading",a.KEY_LOADED="hlsKeyLoaded",a.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",a.BACK_BUFFER_REACHED="hlsBackBufferReached",a}({}),N=function(a){return a.NETWORK_ERROR="networkError",a.MEDIA_ERROR="mediaError",a.KEY_SYSTEM_ERROR="keySystemError",a.MUX_ERROR="muxError",a.OTHER_ERROR="otherError",a}({}),L=function(a){return a.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",a.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",a.KEY_SYSTEM_NO_SESSION="keySystemNoSession",a.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",a.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",a.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",a.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",a.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",a.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",a.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",a.MANIFEST_LOAD_ERROR="manifestLoadError",a.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",a.MANIFEST_PARSING_ERROR="manifestParsingError",a.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",a.LEVEL_EMPTY_ERROR="levelEmptyError",a.LEVEL_LOAD_ERROR="levelLoadError",a.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",a.LEVEL_PARSING_ERROR="levelParsingError",a.LEVEL_SWITCH_ERROR="levelSwitchError",a.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",a.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",a.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",a.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",a.FRAG_LOAD_ERROR="fragLoadError",a.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",a.FRAG_DECRYPT_ERROR="fragDecryptError",a.FRAG_PARSING_ERROR="fragParsingError",a.FRAG_GAP="fragGap",a.REMUX_ALLOC_ERROR="remuxAllocError",a.KEY_LOAD_ERROR="keyLoadError",a.KEY_LOAD_TIMEOUT="keyLoadTimeOut",a.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",a.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",a.BUFFER_APPEND_ERROR="bufferAppendError",a.BUFFER_APPENDING_ERROR="bufferAppendingError",a.BUFFER_STALLED_ERROR="bufferStalledError",a.BUFFER_FULL_ERROR="bufferFullError",a.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",a.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",a.INTERNAL_EXCEPTION="internalException",a.INTERNAL_ABORTED="aborted",a.UNKNOWN="unknown",a}({});const _e=function(){},Ut={trace:_e,debug:_e,log:_e,warn:_e,info:_e,error:_e};let Ge=Ut;function cr(a){const e=self.console[a];return e?e.bind(self.console,`[${a}] >`):_e}function dr(a,...e){e.forEach(function(t){Ge[t]=a[t]?a[t].bind(a):cr(t)})}function hr(a,e){if(self.console&&a===!0||typeof a=="object"){dr(a,"debug","log","info","warn","error");try{Ge.log(`Debug logs enabled for "${e}" in hls.js version 1.4.5`)}catch{Ge=Ut}}else Ge=Ut}const y=Ge,fr=/^(\d+)x(\d+)$/,hi=/(.+?)=(".*?"|.*?)(?:,|$)/g;class Q{constructor(e){typeof e=="string"&&(e=Q.parseAttrList(e));for(const t in e)e.hasOwnProperty(t)&&(t.substring(0,2)==="X-"&&(this.clientAttrs=this.clientAttrs||[],this.clientAttrs.push(t)),this[t]=e[t])}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let s=0;s<t.length/2;s++)i[s]=parseInt(t.slice(s*2,s*2+2),16);return i}else return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}bool(e){return this[e]==="YES"}decimalResolution(e){const t=fr.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t;const i={},s='"';for(hi.lastIndex=0;(t=hi.exec(e))!==null;){let r=t[2];r.indexOf(s)===0&&r.lastIndexOf(s)===r.length-1&&(r=r.slice(1,-1));const n=t[1].trim();i[n]=r}return i}}function mr(a){return a!=="ID"&&a!=="CLASS"&&a!=="START-DATE"&&a!=="DURATION"&&a!=="END-DATE"&&a!=="END-ON-NEXT"}function gr(a){return a==="SCTE35-OUT"||a==="SCTE35-IN"}class as{constructor(e,t){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,t){const i=t.attr;for(const s in i)if(Object.prototype.hasOwnProperty.call(e,s)&&e[s]!==i[s]){y.warn(`DATERANGE tag attribute: "${s}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=s;break}e=ee(new Q({}),i,e)}if(this.attr=e,this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const i=new Date(this.attr["END-DATE"]);F(i.getTime())&&(this._endDate=i)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const e=this.duration;return e!==null?new Date(this._startDate.getTime()+e*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(F(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&F(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class ct{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var K={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class os{constructor(e){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[K.AUDIO]:null,[K.VIDEO]:null,[K.AUDIOVIDEO]:null},this.baseurl=e}setByteRange(e,t){const i=e.split("@",2),s=[];i.length===1?s[0]=t?t.byteRangeEndOffset:0:s[0]=parseInt(i[1]),s[1]=parseInt(i[0])+s[0],this._byteRange=s}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=jt.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}}class mt extends os{constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new ct,this.urlId=0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.type=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{const i=Object.keys(this.levelkeys);if(i.length===1)return this._decryptdata=this.levelkeys[i[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null||!F(this.programDateTime))return null;const e=F(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){const t=Object.keys(this.levelkeys),i=t.length;if(i>1||i===1&&this.levelkeys[t[0]].encrypted)return!0}return!1}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,s,r,n=!1){const{elementaryStreams:o}=this,l=o[e];if(!l){o[e]={startPTS:t,endPTS:i,startDTS:s,endDTS:r,partial:n};return}l.startPTS=Math.min(l.startPTS,t),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,s),l.endDTS=Math.max(l.endDTS,r)}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[K.AUDIO]=null,e[K.VIDEO]=null,e[K.AUDIOVIDEO]=null}}class pr extends os{constructor(e,t,i,s,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new ct,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=s;const n=e.enumeratedString("BYTERANGE");n&&this.setByteRange(n,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}const Tr=10;class xr{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return this.fragments.length?F(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||Tr}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function Xt(a){return Uint8Array.from(atob(a),e=>e.charCodeAt(0))}function yr(a){const e=ls(a).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function Er(a){const e=function(i,s,r){const n=i[s];i[s]=i[r],i[r]=n};e(a,0,3),e(a,1,2),e(a,4,5),e(a,6,7)}function vr(a){const e=a.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),s=i[i.length-1].split(",");if(s.length===2){const r=s[0]==="base64",n=s[1];r?(i.splice(-1,1),t=Xt(n)):t=yr(n)}}return t}function ls(a){return Uint8Array.from(unescape(encodeURIComponent(a)),e=>e.charCodeAt(0))}var J={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},le={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function fi(a){switch(a){case le.FAIRPLAY:return J.FAIRPLAY;case le.PLAYREADY:return J.PLAYREADY;case le.WIDEVINE:return J.WIDEVINE;case le.CLEARKEY:return J.CLEARKEY}}var us={WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function Sr(a){if(a===us.WIDEVINE)return J.WIDEVINE}function mi(a){switch(a){case J.FAIRPLAY:return le.FAIRPLAY;case J.PLAYREADY:return le.PLAYREADY;case J.WIDEVINE:return le.WIDEVINE;case J.CLEARKEY:return le.CLEARKEY}}function gt(a){const{drmSystems:e,widevineLicenseUrl:t}=a,i=e?[J.FAIRPLAY,J.WIDEVINE,J.PLAYREADY,J.CLEARKEY].filter(s=>!!e[s]):[];return!i[J.WIDEVINE]&&t&&i.push(J.WIDEVINE),i}const cs=function(){return typeof self<"u"&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function Ar(a,e,t,i){let s;switch(a){case J.FAIRPLAY:s=["cenc","sinf"];break;case J.WIDEVINE:case J.PLAYREADY:s=["cenc"];break;case J.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${a}`)}return Lr(s,e,t,i)}function Lr(a,e,t,i){return[{initDataTypes:a,persistentState:i.persistentState||"not-allowed",distinctiveIdentifier:i.distinctiveIdentifier||"not-allowed",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(r=>({contentType:`audio/mp4; codecs="${r}"`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(r=>({contentType:`video/mp4; codecs="${r}"`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function we(a,e,t){return Uint8Array.prototype.slice?a.slice(e,t):new Uint8Array(Array.prototype.slice.call(a,e,t))}const zt=(a,e)=>e+10<=a.length&&a[e]===73&&a[e+1]===68&&a[e+2]===51&&a[e+3]<255&&a[e+4]<255&&a[e+6]<128&&a[e+7]<128&&a[e+8]<128&&a[e+9]<128,ds=(a,e)=>e+10<=a.length&&a[e]===51&&a[e+1]===68&&a[e+2]===73&&a[e+3]<255&&a[e+4]<255&&a[e+6]<128&&a[e+7]<128&&a[e+8]<128&&a[e+9]<128,rt=(a,e)=>{const t=e;let i=0;for(;zt(a,e);){i+=10;const s=dt(a,e+6);i+=s,ds(a,e+10)&&(i+=10),e+=i}if(i>0)return a.subarray(t,t+i)},dt=(a,e)=>{let t=0;return t=(a[e]&127)<<21,t|=(a[e+1]&127)<<14,t|=(a[e+2]&127)<<7,t|=a[e+3]&127,t},Rr=(a,e)=>zt(a,e)&&dt(a,e+6)+10<=a.length-e,Ir=a=>{const e=fs(a);for(let t=0;t<e.length;t++){const i=e[t];if(hs(i))return wr(i)}},hs=a=>a&&a.key==="PRIV"&&a.info==="com.apple.streaming.transportStreamTimestamp",br=a=>{const e=String.fromCharCode(a[0],a[1],a[2],a[3]),t=dt(a,4),i=10;return{type:e,size:t,data:a.subarray(i,i+t)}},fs=a=>{let e=0;const t=[];for(;zt(a,e);){const i=dt(a,e+6);e+=10;const s=e+i;for(;e+8<s;){const r=br(a.subarray(e)),n=Dr(r);n&&t.push(n),e+=r.size+10}ds(a,e)&&(e+=10)}return t},Dr=a=>a.type==="PRIV"?Cr(a):a.type[0]==="W"?_r(a):kr(a),Cr=a=>{if(a.size<2)return;const e=ve(a.data,!0),t=new Uint8Array(a.data.subarray(e.length+1));return{key:a.type,info:e,data:t.buffer}},kr=a=>{if(a.size<2)return;if(a.type==="TXXX"){let t=1;const i=ve(a.data.subarray(t),!0);t+=i.length+1;const s=ve(a.data.subarray(t));return{key:a.type,info:i,data:s}}const e=ve(a.data.subarray(1));return{key:a.type,data:e}},_r=a=>{if(a.type==="WXXX"){if(a.size<2)return;let t=1;const i=ve(a.data.subarray(t),!0);t+=i.length+1;const s=ve(a.data.subarray(t));return{key:a.type,info:i,data:s}}const e=ve(a.data);return{key:a.type,data:e}},wr=a=>{if(a.data.byteLength===8){const e=new Uint8Array(a.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}},ve=(a,e=!1)=>{const t=Pr();if(t){const u=t.decode(a);if(e){const c=u.indexOf("\0");return c!==-1?u.substring(0,c):u}return u.replace(/\0/g,"")}const i=a.length;let s,r,n,o="",l=0;for(;l<i;){if(s=a[l++],s===0&&e)return o;if(s===0||s===3)continue;switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(s);break;case 12:case 13:r=a[l++],o+=String.fromCharCode((s&31)<<6|r&63);break;case 14:r=a[l++],n=a[l++],o+=String.fromCharCode((s&15)<<12|(r&63)<<6|(n&63)<<0);break}}return o};let pt;function Pr(){return!pt&&typeof self.TextDecoder<"u"&&(pt=new self.TextDecoder("utf-8")),pt}const ye={hexDump:function(a){let e="";for(let t=0;t<a.length;t++){let i=a[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}},nt=Math.pow(2,32)-1,Fr=[].push,ms={video:1,audio:2,id3:3,text:4};function te(a){return String.fromCharCode.apply(null,a)}function gs(a,e){const t=a[e]<<8|a[e+1];return t<0?65536+t:t}function B(a,e){const t=ps(a,e);return t<0?4294967296+t:t}function ps(a,e){return a[e]<<24|a[e+1]<<16|a[e+2]<<8|a[e+3]}function Tt(a,e,t){a[e]=t>>24,a[e+1]=t>>16&255,a[e+2]=t>>8&255,a[e+3]=t&255}function $(a,e){const t=[];if(!e.length)return t;const i=a.byteLength;for(let s=0;s<i;){const r=B(a,s),n=te(a.subarray(s+4,s+8)),o=r>1?s+r:i;if(n===e[0])if(e.length===1)t.push(a.subarray(s+8,o));else{const l=$(a.subarray(s+8,o),e.slice(1));l.length&&Fr.apply(t,l)}s=o}return t}function Or(a){const e=[],t=a[0];let i=8;const s=B(a,i);i+=4;const r=0,n=0;t===0?i+=8:i+=16,i+=2;let o=a.length+n;const l=gs(a,i);i+=2;for(let u=0;u<l;u++){let c=i;const d=B(a,c);c+=4;const h=d&2147483647;if((d&2147483648)>>>31===1)return y.warn("SIDX has hierarchical references (not supported)"),null;const m=B(a,c);c+=4,e.push({referenceSize:h,subsegmentDuration:m,info:{duration:m/s,start:o,end:o+h-1}}),o+=h,c+=4,i=c}return{earliestPresentationTime:r,timescale:s,version:t,referencesCount:l,references:e}}function Ts(a){const e=[],t=$(a,["moov","trak"]);for(let s=0;s<t.length;s++){const r=t[s],n=$(r,["tkhd"])[0];if(n){let o=n[0],l=o===0?12:20;const u=B(n,l),c=$(r,["mdia","mdhd"])[0];if(c){o=c[0],l=o===0?12:20;const d=B(c,l),h=$(r,["mdia","hdlr"])[0];if(h){const f=te(h.subarray(8,12)),m={soun:K.AUDIO,vide:K.VIDEO}[f];if(m){const p=$(r,["mdia","minf","stbl","stsd"])[0];let T;p&&(T=te(p.subarray(12,16))),e[u]={timescale:d,type:m},e[m]={timescale:d,id:u,codec:T}}}}}}return $(a,["moov","mvex","trex"]).forEach(s=>{const r=B(s,4),n=e[r];n&&(n.default={duration:B(s,12),flags:B(s,20)})}),e}function Mr(a,e){if(!a||!e)return a;const t=e.keyId;return t&&e.isCommonEncryption&&$(a,["moov","trak"]).forEach(s=>{const n=$(s,["mdia","minf","stbl","stsd"])[0].subarray(8);let o=$(n,["enca"]);const l=o.length>0;l||(o=$(n,["encv"])),o.forEach(u=>{const c=l?u.subarray(28):u.subarray(78);$(c,["sinf"]).forEach(h=>{const f=xs(h);if(f){const m=f.subarray(8,24);m.some(p=>p!==0)||(y.log(`[eme] Patching keyId in 'enc${l?"a":"v"}>sinf>>tenc' box: ${ye.hexDump(m)} -> ${ye.hexDump(t)}`),f.set(t,8))}})})}),a}function xs(a){const e=$(a,["schm"])[0];if(e){const t=te(e.subarray(4,8));if(t==="cbcs"||t==="cenc")return $(a,["schi","tenc"])[0]}return y.error("[eme] missing 'schm' box"),null}function Nr(a,e){return $(e,["moof","traf"]).reduce((t,i)=>{const s=$(i,["tfdt"])[0],r=s[0],n=$(i,["tfhd"]).reduce((o,l)=>{const u=B(l,4),c=a[u];if(c){let d=B(s,4);if(r===1){if(d===nt)return y.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),o;d*=nt+1,d+=B(s,8)}const h=c.timescale||9e4,f=d/h;if(isFinite(f)&&(o===null||f<o))return f}return o},null);return n!==null&&isFinite(n)&&(t===null||n<t)?n:t},null)}function Ur(a,e){let t=0,i=0,s=0;const r=$(a,["moof","traf"]);for(let n=0;n<r.length;n++){const o=r[n],l=$(o,["tfhd"])[0],u=B(l,4),c=e[u];if(!c)continue;const d=c.default,h=B(l,0)|(d==null?void 0:d.flags);let f=d==null?void 0:d.duration;h&8&&(h&2?f=B(l,12):f=B(l,8));const m=c.timescale||9e4,p=$(o,["trun"]);for(let T=0;T<p.length;T++){if(t=Br(p[T]),!t&&f){const x=B(p[T],4);t=f*x}c.type===K.VIDEO?i+=t/m:c.type===K.AUDIO&&(s+=t/m)}}if(i===0&&s===0){let n=0;const o=$(a,["sidx"]);for(let l=0;l<o.length;l++){const u=Or(o[l]);u!=null&&u.references&&(n+=u.references.reduce((c,d)=>c+d.info.duration||0,0))}return n}return i||s}function Br(a){const e=B(a,0);let t=8;e&1&&(t+=4),e&4&&(t+=4);let i=0;const s=B(a,4);for(let r=0;r<s;r++){if(e&256){const n=B(a,t);i+=n,t+=4}e&512&&(t+=4),e&1024&&(t+=4),e&2048&&(t+=4)}return i}function $r(a,e,t){$(e,["moof","traf"]).forEach(i=>{$(i,["tfhd"]).forEach(s=>{const r=B(s,4),n=a[r];if(!n)return;const o=n.timescale||9e4;$(i,["tfdt"]).forEach(l=>{const u=l[0];let c=B(l,4);if(u===0)c-=t*o,c=Math.max(c,0),Tt(l,4,c);else{c*=Math.pow(2,32),c+=B(l,8),c-=t*o,c=Math.max(c,0);const d=Math.floor(c/(nt+1)),h=Math.floor(c%(nt+1));Tt(l,4,d),Tt(l,8,h)}})})})}function Gr(a){const e={valid:null,remainder:null},t=$(a,["moof"]);if(t){if(t.length<2)return e.remainder=a,e}else return e;const i=t[t.length-1];return e.valid=we(a,0,i.byteOffset-8),e.remainder=we(a,i.byteOffset-8),e}function Pe(a,e){const t=new Uint8Array(a.length+e.length);return t.set(a),t.set(e,a.length),t}function gi(a,e){const t=[],i=e.samples,s=e.timescale,r=e.id;let n=!1;return $(i,["moof"]).map(l=>{const u=l.byteOffset-8;$(l,["traf"]).map(d=>{const h=$(d,["tfdt"]).map(f=>{const m=f[0];let p=B(f,4);return m===1&&(p*=Math.pow(2,32),p+=B(f,8)),p/s})[0];return h!==void 0&&(a=h),$(d,["tfhd"]).map(f=>{const m=B(f,4),p=B(f,0)&16777215,T=(p&1)!==0,x=(p&2)!==0,v=(p&8)!==0;let E=0;const R=(p&16)!==0;let A=0;const k=(p&32)!==0;let D=8;m===r&&(T&&(D+=8),x&&(D+=4),v&&(E=B(f,D),D+=4),R&&(A=B(f,D),D+=4),k&&(D+=4),e.type==="video"&&(n=qr(e.codec)),$(d,["trun"]).map(C=>{const _=C[0],I=B(C,0)&16777215,O=(I&1)!==0;let w=0;const V=(I&4)!==0,re=(I&256)!==0;let j=0;const z=(I&512)!==0;let X=0;const P=(I&1024)!==0,M=(I&2048)!==0;let H=0;const W=B(C,4);let q=8;O&&(w=B(C,q),q+=4),V&&(q+=4);let Z=w+u;for(let ce=0;ce<W;ce++){if(re?(j=B(C,q),q+=4):j=E,z?(X=B(C,q),q+=4):X=A,P&&(q+=4),M&&(_===0?H=B(C,q):H=ps(C,q),q+=4),e.type===K.VIDEO){let me=0;for(;me<X;){const de=B(i,Z);if(Z+=4,Kr(n,i[Z])){const Ce=i.subarray(Z,Z+de);ys(Ce,n?2:1,a+H/s,t)}Z+=de,me+=de+4}}a+=j/s}}))})})}),t}function qr(a){if(!a)return!1;const e=a.indexOf("."),t=e<0?a:a.substring(0,e);return t==="hvc1"||t==="hev1"||t==="dvh1"||t==="dvhe"}function Kr(a,e){if(a){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function ys(a,e,t,i){const s=Es(a);let r=0;r+=e;let n=0,o=0,l=!1,u=0;for(;r<s.length;){n=0;do{if(r>=s.length)break;u=s[r++],n+=u}while(u===255);o=0;do{if(r>=s.length)break;u=s[r++],o+=u}while(u===255);const c=s.length-r;if(!l&&n===4&&r<s.length){if(l=!0,s[r++]===181){const h=gs(s,r);if(r+=2,h===49){const f=B(s,r);if(r+=4,f===1195456820){const m=s[r++];if(m===3){const p=s[r++],T=31&p,x=64&p,v=x?2+T*3:0,E=new Uint8Array(v);if(x){E[0]=p;for(let R=1;R<v;R++)E[R]=s[r++]}i.push({type:m,payloadType:n,pts:t,bytes:E})}}}}}else if(n===5&&o<c){if(l=!0,o>16){const d=[];for(let m=0;m<16;m++){const p=s[r++].toString(16);d.push(p.length==1?"0"+p:p),(m===3||m===5||m===7||m===9)&&d.push("-")}const h=o-16,f=new Uint8Array(h);for(let m=0;m<h;m++)f[m]=s[r++];i.push({payloadType:n,pts:t,uuid:d.join(""),userData:ve(f),userDataBytes:f})}}else if(o<c)r+=o;else if(o>c)break}}function Es(a){const e=a.byteLength,t=[];let i=1;for(;i<e-2;)a[i]===0&&a[i+1]===0&&a[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return a;const s=e-t.length,r=new Uint8Array(s);let n=0;for(i=0;i<s;n++,i++)n===t[0]&&(n++,t.shift()),r[i]=a[n];return r}function Vr(a){const e=a[0];let t="",i="",s=0,r=0,n=0,o=0,l=0,u=0;if(e===0){for(;te(a.subarray(u,u+1))!=="\0";)t+=te(a.subarray(u,u+1)),u+=1;for(t+=te(a.subarray(u,u+1)),u+=1;te(a.subarray(u,u+1))!=="\0";)i+=te(a.subarray(u,u+1)),u+=1;i+=te(a.subarray(u,u+1)),u+=1,s=B(a,12),r=B(a,16),o=B(a,20),l=B(a,24),u=28}else if(e===1){u+=4,s=B(a,u),u+=4;const d=B(a,u);u+=4;const h=B(a,u);for(u+=4,n=2**32*d+h,Number.isSafeInteger(n)||(n=Number.MAX_SAFE_INTEGER,y.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=B(a,u),u+=4,l=B(a,u),u+=4;te(a.subarray(u,u+1))!=="\0";)t+=te(a.subarray(u,u+1)),u+=1;for(t+=te(a.subarray(u,u+1)),u+=1;te(a.subarray(u,u+1))!=="\0";)i+=te(a.subarray(u,u+1)),u+=1;i+=te(a.subarray(u,u+1)),u+=1}const c=a.subarray(u,a.byteLength);return{schemeIdUri:t,value:i,timeScale:s,presentationTime:n,presentationTimeDelta:r,eventDuration:o,id:l,payload:c}}function Hr(a,...e){const t=e.length;let i=8,s=t;for(;s--;)i+=e[s].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(a,4),s=0,i=8;s<t;s++)r.set(e[s],i),i+=e[s].byteLength;return r}function Wr(a,e,t){if(a.byteLength!==16)throw new RangeError("Invalid system id");let i,s;if(e){i=1,s=new Uint8Array(e.length*16);for(let o=0;o<e.length;o++){const l=e[o];if(l.byteLength!==16)throw new RangeError("Invalid key");s.set(l,o*16)}}else i=0,s=new Uint8Array;let r;i>0?(r=new Uint8Array(4),e.length>0&&new DataView(r.buffer).setUint32(0,e.length,!1)):r=new Uint8Array;const n=new Uint8Array(4);return t&&t.byteLength>0&&new DataView(n.buffer).setUint32(0,t.byteLength,!1),Hr([112,115,115,104],new Uint8Array([i,0,0,0]),a,r,s,n,t||new Uint8Array)}function Yr(a){if(!(a instanceof ArrayBuffer)||a.byteLength<32)return null;const e={version:0,systemId:"",kids:null,data:null},t=new DataView(a),i=t.getUint32(0);if(a.byteLength!==i&&i>44||t.getUint32(4)!==1886614376||(e.version=t.getUint32(8)>>>24,e.version>1))return null;e.systemId=ye.hexDump(new Uint8Array(a,12,16));const r=t.getUint32(28);if(e.version===0){if(i-32<r)return null;e.data=new Uint8Array(a,32,r)}else if(e.version===1){e.kids=[];for(let n=0;n<r;n++)e.kids.push(new Uint8Array(a,32+n*16,16))}return e}let We={};class Ke{static clearKeyUriToKeyIdMap(){We={}}constructor(e,t,i,s=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=s,this.iv=r,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&e!=="AES-128"}isSupported(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case le.FAIRPLAY:case le.WIDEVINE:case le.PLAYREADY:case le.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){typeof e!="number"&&(this.method==="AES-128"&&!this.iv&&y.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const i=jr(e);return new Ke(this.method,this.uri,"identity",this.keyFormatVersions,i)}const t=vr(this.uri);if(t)switch(this.keyFormat){case le.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case le.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Wr(i,null,t);const s=new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2),r=String.fromCharCode.apply(null,Array.from(s)),n=r.substring(r.indexOf("<"),r.length),u=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("KID")[0];if(u){const c=u.childNodes[0]?u.childNodes[0].nodeValue:u.getAttribute("VALUE");if(c){const d=Xt(c).subarray(0,16);Er(d),this.keyId=d}}break}default:{let i=t.subarray(0,16);if(i.length!==16){const s=new Uint8Array(16);s.set(i,16-i.length),i=s}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=We[this.uri];if(!i){const s=Object.keys(We).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,s),We[this.uri]=i}this.keyId=i}return this}}function jr(a){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=a>>8*(15-t)&255;return e}const vs=/\{\$([a-zA-Z0-9-_]+)\}/g;function pi(a){return vs.test(a)}function ae(a,e,t){if(a.variableList!==null||a.hasVariableRefs)for(let i=t.length;i--;){const s=t[i],r=e[s];r&&(e[s]=Bt(a,r))}}function Bt(a,e){if(a.variableList!==null||a.hasVariableRefs){const t=a.variableList;return e.replace(vs,i=>{const s=i.substring(2,i.length-1),r=t==null?void 0:t[s];return r===void 0?(a.playlistParsingError||(a.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${s}"`)),i):r})}return e}function Ti(a,e,t){let i=a.variableList;i||(a.variableList=i={});let s,r;if("QUERYPARAM"in e){s=e.QUERYPARAM;try{const n=new self.URL(t).searchParams;if(n.has(s))r=n.get(s);else throw new Error(`"${s}" does not match any query parameter in URI: "${t}"`)}catch(n){a.playlistParsingError||(a.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${n.message}`))}}else s=e.NAME,r=e.VALUE;s in i?a.playlistParsingError||(a.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${s}"`)):i[s]=r||""}function Xr(a,e,t){const i=e.IMPORT;if(t&&i in t){let s=a.variableList;s||(a.variableList=s={}),s[i]=t[i]}else a.playlistParsingError||(a.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}function ht(){if(!(typeof self>"u"))return self.MediaSource||self.WebKitMediaSource}const zr={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dva1:!0,dvav:!0,dvh1:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}},xi=ht();function Qr(a,e){const t=zr[e];return!!t&&t[a.slice(0,4)]===!0}function xt(a,e){var t;return(t=xi==null?void 0:xi.isTypeSupported(`${e||"video"}/mp4;codecs="${a}"`))!=null?t:!1}const yi=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,Ei=/#EXT-X-MEDIA:(.*)/g,Jr=/^#EXT(?:INF|-X-TARGETDURATION):/m,vi=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),Zr=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class xe{static findGroup(e,t){for(let i=0;i<e.length;i++){const s=e[i];if(s.id===t)return s}}static convertAVC1ToAVCOTI(e){const t=e.split(".");if(t.length>2){let i=t.shift()+".";return i+=parseInt(t.shift()).toString(16),i+=("000"+parseInt(t.shift()).toString(16)).slice(-4),i}return e}static resolve(e,t){return jt.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return Jr.test(e)}static parseMasterPlaylist(e,t){const i=pi(e),s={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},r=[];yi.lastIndex=0;let n;for(;(n=yi.exec(e))!=null;)if(n[1]){var o;const u=new Q(n[1]);ae(s,u,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const c=Bt(s,n[2]),d={attrs:u,bitrate:u.decimalInteger("AVERAGE-BANDWIDTH")||u.decimalInteger("BANDWIDTH"),name:u.NAME,url:xe.resolve(c,t)},h=u.decimalResolution("RESOLUTION");h&&(d.width=h.width,d.height=h.height),en((u.CODECS||"").split(/[ ,]+/).filter(f=>f),d),d.videoCodec&&d.videoCodec.indexOf("avc1")!==-1&&(d.videoCodec=xe.convertAVC1ToAVCOTI(d.videoCodec)),(o=d.unknownCodecs)!=null&&o.length||r.push(d),s.levels.push(d)}else if(n[3]){const u=n[3],c=n[4];switch(u){case"SESSION-DATA":{const d=new Q(c);ae(s,d,["DATA-ID","LANGUAGE","VALUE","URI"]);const h=d["DATA-ID"];h&&(s.sessionData===null&&(s.sessionData={}),s.sessionData[h]=d);break}case"SESSION-KEY":{const d=Si(c,t,s);d.encrypted&&d.isSupported()?(s.sessionKeys===null&&(s.sessionKeys=[]),s.sessionKeys.push(d)):y.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${c}"`);break}case"DEFINE":{{const d=new Q(c);ae(s,d,["NAME","VALUE","QUERYPARAM"]),Ti(s,d,t)}break}case"CONTENT-STEERING":{const d=new Q(c);ae(s,d,["SERVER-URI","PATHWAY-ID"]),s.contentSteering={uri:xe.resolve(d["SERVER-URI"],t),pathwayId:d["PATHWAY-ID"]||"."};break}case"START":{s.startTimeOffset=Ai(c);break}}}const l=r.length>0&&r.length<s.levels.length;return s.levels=l?r:s.levels,s.levels.length===0&&(s.playlistParsingError=new Error("no levels found in manifest")),s}static parseMasterPlaylistMedia(e,t,i){let s;const r={},n=i.levels,o={AUDIO:n.map(u=>({id:u.attrs.AUDIO,audioCodec:u.audioCodec})),SUBTITLES:n.map(u=>({id:u.attrs.SUBTITLES,textCodec:u.textCodec})),"CLOSED-CAPTIONS":[]};let l=0;for(Ei.lastIndex=0;(s=Ei.exec(e))!==null;){const u=new Q(s[1]),c=u.TYPE;if(c){const d=o[c],h=r[c]||[];r[c]=h,ae(i,u,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const f={attrs:u,bitrate:0,id:l++,groupId:u["GROUP-ID"]||"",instreamId:u["INSTREAM-ID"],name:u.NAME||u.LANGUAGE||"",type:c,default:u.bool("DEFAULT"),autoselect:u.bool("AUTOSELECT"),forced:u.bool("FORCED"),lang:u.LANGUAGE,url:u.URI?xe.resolve(u.URI,t):""};if(d!=null&&d.length){const m=xe.findGroup(d,f.groupId)||d[0];Li(f,m,"audioCodec"),Li(f,m,"textCodec")}h.push(f)}}return r}static parseLevelPlaylist(e,t,i,s,r,n){const o=new xr(t),l=o.fragments;let u=null,c=0,d=0,h=0,f=0,m=null,p=new mt(s,t),T,x,v,E=-1,R=!1;for(vi.lastIndex=0,o.m3u8=e,o.hasVariableRefs=pi(e);(T=vi.exec(e))!==null;){R&&(R=!1,p=new mt(s,t),p.start=h,p.sn=c,p.cc=f,p.level=i,u&&(p.initSegment=u,p.rawProgramDateTime=u.rawProgramDateTime,u.rawProgramDateTime=null));const C=T[1];if(C){p.duration=parseFloat(C);const _=(" "+T[2]).slice(1);p.title=_||null,p.tagList.push(_?["INF",C,_]:["INF",C])}else if(T[3]){if(F(p.duration)){p.start=h,v&&bi(p,v,o),p.sn=c,p.level=i,p.cc=f,p.urlId=r,l.push(p);const _=(" "+T[3]).slice(1);p.relurl=Bt(o,_),Ri(p,m),m=p,h+=p.duration,c++,d=0,R=!0}}else if(T[4]){const _=(" "+T[4]).slice(1);m?p.setByteRange(_,m):p.setByteRange(_)}else if(T[5])p.rawProgramDateTime=(" "+T[5]).slice(1),p.tagList.push(["PROGRAM-DATE-TIME",p.rawProgramDateTime]),E===-1&&(E=l.length);else{if(T=T[0].match(Zr),!T){y.warn("No matches on slow regex match for level playlist!");continue}for(x=1;x<T.length&&!(typeof T[x]<"u");x++);const _=(" "+T[x]).slice(1),I=(" "+T[x+1]).slice(1),O=T[x+2]?(" "+T[x+2]).slice(1):"";switch(_){case"PLAYLIST-TYPE":o.type=I.toUpperCase();break;case"MEDIA-SEQUENCE":c=o.startSN=parseInt(I);break;case"SKIP":{const w=new Q(I);ae(o,w,["RECENTLY-REMOVED-DATERANGES"]);const V=w.decimalInteger("SKIPPED-SEGMENTS");if(F(V)){o.skippedSegments=V;for(let j=V;j--;)l.unshift(null);c+=V}const re=w.enumeratedString("RECENTLY-REMOVED-DATERANGES");re&&(o.recentlyRemovedDateranges=re.split("	"));break}case"TARGETDURATION":o.targetduration=Math.max(parseInt(I),1);break;case"VERSION":o.version=parseInt(I);break;case"EXTM3U":break;case"ENDLIST":o.live=!1;break;case"#":(I||O)&&p.tagList.push(O?[I,O]:[I]);break;case"DISCONTINUITY":f++,p.tagList.push(["DIS"]);break;case"GAP":p.gap=!0,p.tagList.push([_]);break;case"BITRATE":p.tagList.push([_,I]);break;case"DATERANGE":{const w=new Q(I);ae(o,w,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),ae(o,w,w.clientAttrs);const V=new as(w,o.dateRanges[w.ID]);V.isValid||o.skippedSegments?o.dateRanges[V.id]=V:y.warn(`Ignoring invalid DATERANGE tag: "${I}"`),p.tagList.push(["EXT-X-DATERANGE",I]);break}case"DEFINE":{{const w=new Q(I);ae(o,w,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in w?Xr(o,w,n):Ti(o,w,t)}break}case"DISCONTINUITY-SEQUENCE":f=parseInt(I);break;case"KEY":{const w=Si(I,t,o);if(w.isSupported()){if(w.method==="NONE"){v=void 0;break}v||(v={}),v[w.keyFormat]&&(v=ee({},v)),v[w.keyFormat]=w}else y.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${I}"`);break}case"START":o.startTimeOffset=Ai(I);break;case"MAP":{const w=new Q(I);if(ae(o,w,["BYTERANGE","URI"]),p.duration){const V=new mt(s,t);Ii(V,w,i,v),u=V,p.initSegment=u,u.rawProgramDateTime&&!p.rawProgramDateTime&&(p.rawProgramDateTime=u.rawProgramDateTime)}else Ii(p,w,i,v),u=p,R=!0;break}case"SERVER-CONTROL":{const w=new Q(I);o.canBlockReload=w.bool("CAN-BLOCK-RELOAD"),o.canSkipUntil=w.optionalFloat("CAN-SKIP-UNTIL",0),o.canSkipDateRanges=o.canSkipUntil>0&&w.bool("CAN-SKIP-DATERANGES"),o.partHoldBack=w.optionalFloat("PART-HOLD-BACK",0),o.holdBack=w.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const w=new Q(I);o.partTarget=w.decimalFloatingPoint("PART-TARGET");break}case"PART":{let w=o.partList;w||(w=o.partList=[]);const V=d>0?w[w.length-1]:void 0,re=d++,j=new Q(I);ae(o,j,["BYTERANGE","URI"]);const z=new pr(j,p,t,re,V);w.push(z),p.duration+=z.duration;break}case"PRELOAD-HINT":{const w=new Q(I);ae(o,w,["URI"]),o.preloadHint=w;break}case"RENDITION-REPORT":{const w=new Q(I);ae(o,w,["URI"]),o.renditionReports=o.renditionReports||[],o.renditionReports.push(w);break}default:y.warn(`line parsed but not handled: ${T}`);break}}}m&&!m.relurl?(l.pop(),h-=m.duration,o.partList&&(o.fragmentHint=m)):o.partList&&(Ri(p,m),p.cc=f,o.fragmentHint=p,v&&bi(p,v,o));const A=l.length,k=l[0],D=l[A-1];if(h+=o.skippedSegments*o.targetduration,h>0&&A&&D){o.averagetargetduration=h/A;const C=D.sn;o.endSN=C!=="initSegment"?C:0,o.live||(D.endList=!0),k&&(o.startCC=k.cc)}else o.endSN=0,o.startCC=0;return o.fragmentHint&&(h+=o.fragmentHint.duration),o.totalduration=h,o.endCC=f,E>0&&tn(l,E),o}}function Si(a,e,t){var i,s;const r=new Q(a);ae(t,r,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const n=(i=r.METHOD)!=null?i:"",o=r.URI,l=r.hexadecimalInteger("IV"),u=r.KEYFORMATVERSIONS,c=(s=r.KEYFORMAT)!=null?s:"identity";o&&r.IV&&!l&&y.error(`Invalid IV: ${r.IV}`);const d=o?xe.resolve(o,e):"",h=(u||"1").split("/").map(Number).filter(Number.isFinite);return new Ke(n,d,c,h,l)}function Ai(a){const t=new Q(a).decimalFloatingPoint("TIME-OFFSET");return F(t)?t:null}function en(a,e){["video","audio","text"].forEach(t=>{const i=a.filter(s=>Qr(s,t));if(i.length){const s=i.filter(r=>r.lastIndexOf("avc1",0)===0||r.lastIndexOf("mp4a",0)===0);e[`${t}Codec`]=s.length>0?s[0]:i[0],a=a.filter(r=>i.indexOf(r)===-1)}}),e.unknownCodecs=a}function Li(a,e,t){const i=e[t];i&&(a[t]=i)}function tn(a,e){let t=a[e];for(let i=e;i--;){const s=a[i];if(!s)return;s.programDateTime=t.programDateTime-s.duration*1e3,t=s}}function Ri(a,e){a.rawProgramDateTime?a.programDateTime=Date.parse(a.rawProgramDateTime):e!=null&&e.programDateTime&&(a.programDateTime=e.endProgramDateTime),F(a.programDateTime)||(a.programDateTime=null,a.rawProgramDateTime=null)}function Ii(a,e,t,i){a.relurl=e.URI,e.BYTERANGE&&a.setByteRange(e.BYTERANGE),a.level=t,a.sn="initSegment",i&&(a.levelkeys=i),a.initSegment=null}function bi(a,e,t){a.levelkeys=e;const{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(s=>e[s].isCommonEncryption)&&i.push(a)}var G={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},U={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function Di(a){const{type:e}=a;switch(e){case G.AUDIO_TRACK:return U.AUDIO;case G.SUBTITLE_TRACK:return U.SUBTITLE;default:return U.MAIN}}function yt(a,e){let t=a.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class sn{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.LEVEL_LOADING,this.onLevelLoading,this),e.on(g.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(g.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:e}=this;e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.LEVEL_LOADING,this.onLevelLoading,this),e.off(g.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(g.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,s=t.loader,r=i||s,n=new r(t);return this.loaders[e.type]=n,n}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:G.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(e,t){const{id:i,level:s,url:r,deliveryDirectives:n}=t;this.load({id:i,level:s,responseType:"text",type:G.LEVEL,url:r,deliveryDirectives:n})}onAudioTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:n}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:G.AUDIO_TRACK,url:r,deliveryDirectives:n})}onSubtitleTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:n}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:G.SUBTITLE_TRACK,url:r,deliveryDirectives:n})}load(e){var t;const i=this.hls.config;let s=this.getInternalLoader(e);if(s){const u=s.context;if(u&&u.url===e.url){y.trace("[playlist-loader]: playlist request ongoing");return}y.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),s.abort()}let r;if(e.type===G.MANIFEST?r=i.manifestLoadPolicy.default:r=ee({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(e),(t=e.deliveryDirectives)!=null&&t.part){let u;if(e.type===G.LEVEL&&e.level!==null?u=this.hls.levels[e.level].details:e.type===G.AUDIO_TRACK&&e.id!==null?u=this.hls.audioTracks[e.id].details:e.type===G.SUBTITLE_TRACK&&e.id!==null&&(u=this.hls.subtitleTracks[e.id].details),u){const c=u.partTarget,d=u.targetduration;if(c&&d){const h=Math.max(c*3,d*.8)*1e3;r=ee({},r,{maxTimeToFirstByteMs:Math.min(h,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(h,r.maxTimeToFirstByteMs)})}}}const n=r.errorRetry||r.timeoutRetry||{},o={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:n.maxNumRetry||0,retryDelay:n.retryDelayMs||0,maxRetryDelay:n.maxRetryDelayMs||0},l={onSuccess:(u,c,d,h)=>{const f=this.getInternalLoader(d);this.resetInternalLoader(d.type);const m=u.data;if(m.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(u,d,new Error("no EXTM3U delimiter"),h||null,c);return}c.parsing.start=performance.now(),xe.isMediaPlaylist(m)?this.handleTrackOrLevelPlaylist(u,c,d,h||null,f):this.handleMasterPlaylist(u,c,d,h)},onError:(u,c,d,h)=>{this.handleNetworkError(c,d,!1,u,h)},onTimeout:(u,c,d)=>{this.handleNetworkError(c,d,!0,void 0,u)}};s.load(e,o,l)}handleMasterPlaylist(e,t,i,s){const r=this.hls,n=e.data,o=yt(e,i),l=xe.parseMasterPlaylist(n,o);if(l.playlistParsingError){this.handleManifestParsingError(e,i,l.playlistParsingError,s,t);return}const{contentSteering:u,levels:c,sessionData:d,sessionKeys:h,startTimeOffset:f,variableList:m}=l;this.variableList=m;const{AUDIO:p=[],SUBTITLES:T,"CLOSED-CAPTIONS":x}=xe.parseMasterPlaylistMedia(n,o,l);p.length&&!p.some(E=>!E.url)&&c[0].audioCodec&&!c[0].attrs.AUDIO&&(y.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),p.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new Q({}),bitrate:0,url:""})),r.trigger(g.MANIFEST_LOADED,{levels:c,audioTracks:p,subtitles:T,captions:x,contentSteering:u,url:o,stats:t,networkDetails:s,sessionData:d,sessionKeys:h,startTimeOffset:f,variableList:m})}handleTrackOrLevelPlaylist(e,t,i,s,r){const n=this.hls,{id:o,level:l,type:u}=i,c=yt(e,i),d=F(o)?o:0,h=F(l)?l:d,f=Di(i),m=xe.parseLevelPlaylist(e.data,c,h,f,d,this.variableList);if(u===G.MANIFEST){const p={attrs:new Q({}),bitrate:0,details:m,name:"",url:c};n.trigger(g.MANIFEST_LOADED,{levels:[p],audioTracks:[],url:c,stats:t,networkDetails:s,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=m,this.handlePlaylistLoaded(m,e,t,i,s,r)}handleManifestParsingError(e,t,i,s,r){this.hls.trigger(g.ERROR,{type:N.NETWORK_ERROR,details:L.MANIFEST_PARSING_ERROR,fatal:t.type===G.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:s,stats:r})}handleNetworkError(e,t,i=!1,s,r){let n=`A network ${i?"timeout":"error"+(s?" (status "+s.code+")":"")} occurred while loading ${e.type}`;e.type===G.LEVEL?n+=`: ${e.level} id: ${e.id}`:(e.type===G.AUDIO_TRACK||e.type===G.SUBTITLE_TRACK)&&(n+=` id: ${e.id} group-id: "${e.groupId}"`);const o=new Error(n);y.warn(`[playlist-loader]: ${n}`);let l=L.UNKNOWN,u=!1;const c=this.getInternalLoader(e);switch(e.type){case G.MANIFEST:l=i?L.MANIFEST_LOAD_TIMEOUT:L.MANIFEST_LOAD_ERROR,u=!0;break;case G.LEVEL:l=i?L.LEVEL_LOAD_TIMEOUT:L.LEVEL_LOAD_ERROR,u=!1;break;case G.AUDIO_TRACK:l=i?L.AUDIO_TRACK_LOAD_TIMEOUT:L.AUDIO_TRACK_LOAD_ERROR,u=!1;break;case G.SUBTITLE_TRACK:l=i?L.SUBTITLE_TRACK_LOAD_TIMEOUT:L.SUBTITLE_LOAD_ERROR,u=!1;break}c&&this.resetInternalLoader(e.type);const d={type:N.NETWORK_ERROR,details:l,fatal:u,url:e.url,loader:c,context:e,error:o,networkDetails:t,stats:r};if(s){const h=(t==null?void 0:t.url)||e.url;d.response=ue({url:h,data:void 0},s)}this.hls.trigger(g.ERROR,d)}handlePlaylistLoaded(e,t,i,s,r,n){const o=this.hls,{type:l,level:u,id:c,groupId:d,deliveryDirectives:h}=s,f=yt(t,s),m=Di(s),p=typeof s.level=="number"&&m===U.MAIN?u:void 0;if(!e.fragments.length){const x=new Error("No Segments found in Playlist");o.trigger(g.ERROR,{type:N.NETWORK_ERROR,details:L.LEVEL_EMPTY_ERROR,fatal:!1,url:f,error:x,reason:x.message,response:t,context:s,level:p,parent:m,networkDetails:r,stats:i});return}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const T=e.playlistParsingError;if(T){o.trigger(g.ERROR,{type:N.NETWORK_ERROR,details:L.LEVEL_PARSING_ERROR,fatal:!1,url:f,error:T,reason:T.message,response:t,context:s,level:p,parent:m,networkDetails:r,stats:i});return}switch(e.live&&n&&(n.getCacheAge&&(e.ageHeader=n.getCacheAge()||0),(!n.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),l){case G.MANIFEST:case G.LEVEL:o.trigger(g.LEVEL_LOADED,{details:e,level:p||0,id:c||0,stats:i,networkDetails:r,deliveryDirectives:h});break;case G.AUDIO_TRACK:o.trigger(g.AUDIO_TRACK_LOADED,{details:e,id:c||0,groupId:d||"",stats:i,networkDetails:r,deliveryDirectives:h});break;case G.SUBTITLE_TRACK:o.trigger(g.SUBTITLE_TRACK_LOADED,{details:e,id:c||0,groupId:d||"",stats:i,networkDetails:r,deliveryDirectives:h});break}}}function Ss(a,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=a,e.dispatchEvent(t)}function As(a,e){const t=a.mode;if(t==="disabled"&&(a.mode="hidden"),a.cues&&!a.cues.getCueById(e.id))try{if(a.addCue(e),!a.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){y.debug(`[texttrack-utils]: ${i}`);const s=new self.TextTrackCue(e.startTime,e.endTime,e.text);s.id=e.id,a.addCue(s)}t==="disabled"&&(a.mode=t)}function Ue(a){const e=a.mode;if(e==="disabled"&&(a.mode="hidden"),a.cues)for(let t=a.cues.length;t--;)a.removeCue(a.cues[t]);e==="disabled"&&(a.mode=e)}function $t(a,e,t,i){const s=a.mode;if(s==="disabled"&&(a.mode="hidden"),a.cues&&a.cues.length>0){const r=nn(a.cues,e,t);for(let n=0;n<r.length;n++)(!i||i(r[n]))&&a.removeCue(r[n])}s==="disabled"&&(a.mode=s)}function rn(a,e){if(e<a[0].startTime)return 0;const t=a.length-1;if(e>a[t].endTime)return-1;let i=0,s=t;for(;i<=s;){const r=Math.floor((s+i)/2);if(e<a[r].startTime)s=r-1;else if(e>a[r].startTime&&i<t)i=r+1;else return r}return a[i].startTime-e<e-a[s].startTime?i:s}function nn(a,e,t){const i=[],s=rn(a,e);if(s>-1)for(let r=s,n=a.length;r<n;r++){const o=a[r];if(o.startTime>=e&&o.endTime<=t)i.push(o);else if(o.startTime>t)return i}return i}var Te={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};const an=.25;function Gt(){if(!(typeof self>"u"))return self.WebKitDataCue||self.VTTCue||self.TextTrackCue}const Ye=(()=>{const a=Gt();try{new a(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function Et(a,e){return a.getTime()/1e3-e}function on(a){return Uint8Array.from(a.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class ln{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:e}=this;e.on(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(g.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(g.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(g.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(g.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(Ue(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if(i.kind==="metadata"&&i.label==="id3")return Ss(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:s}}}=this;if(!i&&!s)return;const{samples:r}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const n=Gt();for(let o=0;o<r.length;o++){const l=r[o].type;if(l===Te.emsg&&!i||!s)continue;const u=fs(r[o].data);if(u){const c=r[o].pts;let d=c+r[o].duration;d>Ye&&(d=Ye),d-c<=0&&(d=c+an);for(let f=0;f<u.length;f++){const m=u[f];if(!hs(m)){this.updateId3CueEnds(c,l);const p=new n(c,d,"");p.value=m,l&&(p.type=l),this.id3Track.addCue(p)}}}}}updateId3CueEnds(e,t){var i;const s=(i=this.id3Track)==null?void 0:i.cues;if(s)for(let r=s.length;r--;){const n=s[r];n.type===t&&n.startTime<e&&n.endTime===Ye&&(n.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:s}){const{id3Track:r,hls:n}=this;if(!n)return;const{config:{enableEmsgMetadataCues:o,enableID3MetadataCues:l}}=n;if(r&&(o||l)){let u;s==="audio"?u=c=>c.type===Te.audioId3&&l:s==="video"?u=c=>c.type===Te.emsg&&o:u=c=>c.type===Te.audioId3&&l||c.type===Te.emsg&&o,$t(r,t,i,u)}}onLevelUpdated(e,{details:t}){if(!this.media||!t.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:i,id3Track:s}=this,{dateRanges:r}=t,n=Object.keys(r);if(s){const c=Object.keys(i).filter(d=>!n.includes(d));for(let d=c.length;d--;){const h=c[d];Object.keys(i[h].cues).forEach(f=>{s.removeCue(i[h].cues[f])}),delete i[h]}}const o=t.fragments[t.fragments.length-1];if(n.length===0||!F(o==null?void 0:o.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const l=o.programDateTime/1e3-o.start,u=Gt();for(let c=0;c<n.length;c++){const d=n[c],h=r[d],f=i[d],m=(f==null?void 0:f.cues)||{};let p=(f==null?void 0:f.durationKnown)||!1;const T=Et(h.startDate,l);let x=Ye;const v=h.endDate;if(v)x=Et(v,l),p=!0;else if(h.endOnNext&&!p){const R=n.reduce((A,k)=>{const D=r[k];return D.class===h.class&&D.id!==k&&D.startDate>h.startDate&&A.push(D),A},[]).sort((A,k)=>A.startDate.getTime()-k.startDate.getTime())[0];R&&(x=Et(R.startDate,l),p=!0)}const E=Object.keys(h.attr);for(let R=0;R<E.length;R++){const A=E[R];if(!mr(A))continue;let k=m[A];if(k)p&&!f.durationKnown&&(k.endTime=x);else{let D=h.attr[A];k=new u(T,x,""),gr(A)&&(D=on(D)),k.value={key:A,data:D},k.type=Te.dateRange,k.id=d,this.id3Track.addCue(k),m[A]=k}}i[d]={cues:m,dateRange:h,durationKnown:p}}}}class un{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:e,levelDetails:t}=this;return e.liveMaxLatencyDuration!==void 0?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const{levelDetails:e}=this;if(e===null)return null;const{holdBack:t,partHoldBack:i,targetduration:s}=e,{liveSyncDuration:r,liveSyncDurationCount:n,lowLatencyMode:o}=this.config,l=this.hls.userConfig;let u=o&&i||t;(l.liveSyncDuration||l.liveSyncDurationCount||u===0)&&(u=r!==void 0?r:n*s);const c=s,d=1;return u+Math.min(this.stallCount*d,c)}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency,i=this.levelDetails;if(e===null||t===null||i===null)return null;const s=i.edge,r=e-t-this.edgeStalled,n=s-i.totalduration,o=s-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(n,r),o)}get drift(){const{levelDetails:e}=this;return e===null?1:e.drift}get edgeStalled(){const{levelDetails:e}=this;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e,levelDetails:t}=this;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(g.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(g.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(g.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(g.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(g.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(g.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(g.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(g.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(g.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(g.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){this.levelDetails=t,t.advanced&&this.timeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){var i;t.details===L.BUFFER_STALLED_ERROR&&(this.stallCount++,(i=this.levelDetails)!=null&&i.live&&y.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:e,levelDetails:t}=this;if(!e||!t)return;this.currentTime=e.currentTime;const i=this.computeLatency();if(i===null)return;this._latency=i;const{lowLatencyMode:s,maxLiveSyncPlaybackRate:r}=this.config;if(!s||r===1)return;const n=this.targetLatency;if(n===null)return;const o=i-n,l=Math.min(this.maxLatency,n+t.targetduration),u=o<l;if(t.live&&u&&o>.05&&this.forwardBufferLength>1){const c=Math.min(2,Math.max(1,r)),d=Math.round(2/(1+Math.exp(-.75*o-this.edgeStalled))*20)/20;e.playbackRate=Math.min(c,Math.max(1,d))}else e.playbackRate!==1&&e.playbackRate!==0&&(e.playbackRate=1)}estimateLiveEdge(){const{levelDetails:e}=this;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}const qt=["NONE","TYPE-0","TYPE-1",null];var qe={No:"",Yes:"YES",v2:"v2"};function cn(a,e){const{canSkipUntil:t,canSkipDateRanges:i,endSN:s}=a,r=e!==void 0?e-s:0;return t&&r<t?i?qe.v2:qe.Yes:qe.No}class Ci{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Ve{constructor(e){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.unknownCodecs=e.unknownCodecs,this.codecSet=[e.videoCodec,e.audioCodec].filter(t=>t).join(",").replace(/\.[^.,]+/g,"")}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get attrs(){return this._attrs[this._urlId]}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get uri(){return this.url[this._urlId]||""}get urlId(){return this._urlId}set urlId(e){const t=e%this.url.length;this._urlId!==t&&(this.fragmentError=0,this.loadError=0,this.details=void 0,this._urlId=t)}get audioGroupId(){var e;return(e=this.audioGroupIds)==null?void 0:e[this.urlId]}get textGroupId(){var e;return(e=this.textGroupIds)==null?void 0:e[this.urlId]}addFallback(e){this.url.push(e.url),this._attrs.push(e.attrs)}}function vt(a,e){const t=e.startPTS;if(F(t)){let i=0,s;e.sn>a.sn?(i=t-a.start,s=a):(i=a.start-t,s=e),s.duration!==i&&(s.duration=i)}else e.sn>a.sn?a.cc===e.cc&&a.minEndPTS?e.start=a.start+(a.minEndPTS-a.start):e.start=a.start+a.duration:e.start=Math.max(a.start-e.duration,0)}function Ls(a,e,t,i,s,r){i-t<=0&&(y.warn("Fragment should have a positive duration",e),i=t+e.duration,r=s+e.duration);let o=t,l=i;const u=e.startPTS,c=e.endPTS;if(F(u)){const T=Math.abs(u-t);F(e.deltaPTS)?e.deltaPTS=Math.max(T,e.deltaPTS):e.deltaPTS=T,o=Math.max(t,u),t=Math.min(t,u),s=Math.min(s,e.startDTS),l=Math.min(i,c),i=Math.max(i,c),r=Math.max(r,e.endDTS)}const d=t-e.start;e.start!==0&&(e.start=t),e.duration=i-e.start,e.startPTS=t,e.maxStartPTS=o,e.startDTS=s,e.endPTS=i,e.minEndPTS=l,e.endDTS=r;const h=e.sn;if(!a||h<a.startSN||h>a.endSN)return 0;let f;const m=h-a.startSN,p=a.fragments;for(p[m]=e,f=m;f>0;f--)vt(p[f],p[f-1]);for(f=m;f<p.length-1;f++)vt(p[f],p[f+1]);return a.fragmentHint&&vt(p[p.length-1],a.fragmentHint),a.PTSKnown=a.alignedSliding=!0,d}function dn(a,e){let t=null;const i=a.fragments;for(let l=i.length-1;l>=0;l--){const u=i[l].initSegment;if(u){t=u;break}}a.fragmentHint&&delete a.fragmentHint.endPTS;let s=0,r;if(mn(a,e,(l,u)=>{l.relurl&&(s=l.cc-u.cc),F(l.startPTS)&&F(l.endPTS)&&(u.start=u.startPTS=l.startPTS,u.startDTS=l.startDTS,u.maxStartPTS=l.maxStartPTS,u.endPTS=l.endPTS,u.endDTS=l.endDTS,u.minEndPTS=l.minEndPTS,u.duration=l.endPTS-l.startPTS,u.duration&&(r=u),e.PTSKnown=e.alignedSliding=!0),u.elementaryStreams=l.elementaryStreams,u.loader=l.loader,u.stats=l.stats,u.urlId=l.urlId,l.initSegment&&(u.initSegment=l.initSegment,t=l.initSegment)}),t&&(e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments).forEach(u=>{var c;(!u.initSegment||u.initSegment.relurl===((c=t)==null?void 0:c.relurl))&&(u.initSegment=t)}),e.skippedSegments)if(e.deltaUpdateFailed=e.fragments.some(l=>!l),e.deltaUpdateFailed){y.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let l=e.skippedSegments;l--;)e.fragments.shift();e.startSN=e.fragments[0].sn,e.startCC=e.fragments[0].cc}else e.canSkipDateRanges&&(e.dateRanges=hn(a.dateRanges,e.dateRanges,e.recentlyRemovedDateranges));const n=e.fragments;if(s){y.warn("discontinuity sliding from playlist, take drift into account");for(let l=0;l<n.length;l++)n[l].cc+=s}e.skippedSegments&&(e.startCC=e.fragments[0].cc),fn(a.partList,e.partList,(l,u)=>{u.elementaryStreams=l.elementaryStreams,u.stats=l.stats}),r?Ls(e,r,r.startPTS,r.endPTS,r.startDTS,r.endDTS):Rs(a,e),n.length&&(e.totalduration=e.edge-n[0].start),e.driftStartTime=a.driftStartTime,e.driftStart=a.driftStart;const o=e.advancedDateTime;if(e.advanced&&o){const l=e.edge;e.driftStart||(e.driftStartTime=o,e.driftStart=l),e.driftEndTime=o,e.driftEnd=l}else e.driftEndTime=a.driftEndTime,e.driftEnd=a.driftEnd,e.advancedDateTime=a.advancedDateTime}function hn(a,e,t){const i=ee({},a);return t&&t.forEach(s=>{delete i[s]}),Object.keys(e).forEach(s=>{const r=new as(e[s].attr,i[s]);r.isValid?i[s]=r:y.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(e[s].attr)}"`)}),i}function fn(a,e,t){if(a&&e){let i=0;for(let s=0,r=a.length;s<=r;s++){const n=a[s],o=e[s+i];n&&o&&n.index===o.index&&n.fragment.sn===o.fragment.sn?t(n,o):i--}}}function mn(a,e,t){const i=e.skippedSegments,s=Math.max(a.startSN,e.startSN)-e.startSN,r=(a.fragmentHint?1:0)+(i?e.endSN:Math.min(a.endSN,e.endSN))-e.startSN,n=e.startSN-a.startSN,o=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=a.fragmentHint?a.fragments.concat(a.fragmentHint):a.fragments;for(let u=s;u<=r;u++){const c=l[n+u];let d=o[u];i&&!d&&u<i&&(d=e.fragments[u]=c),c&&d&&t(c,d)}}function Rs(a,e){const t=e.startSN+e.skippedSegments-a.startSN,i=a.fragments;t<0||t>=i.length||Kt(e,i[t].start)}function Kt(a,e){if(e){const t=a.fragments;for(let i=a.skippedSegments;i<t.length;i++)t[i].start+=e;a.fragmentHint&&(a.fragmentHint.start+=e)}}function gn(a,e=1/0){let t=1e3*a.targetduration;if(a.updated){const i=a.fragments,s=4;if(i.length&&t*s>e){const r=i[i.length-1].duration*1e3;r<t&&(t=r)}}else t/=2;return Math.round(t)}function pn(a,e,t){if(!(a!=null&&a.details))return null;const i=a.details;let s=i.fragments[e-i.startSN];return s||(s=i.fragmentHint,s&&s.sn===e)?s:e<i.startSN&&t&&t.sn===e?t:null}function ki(a,e,t){var i;return a!=null&&a.details?Is((i=a.details)==null?void 0:i.partList,e,t):null}function Is(a,e,t){if(a)for(let i=a.length;i--;){const s=a[i];if(s.index===t&&s.fragment.sn===e)return s}return null}function at(a){switch(a.details){case L.FRAG_LOAD_TIMEOUT:case L.KEY_LOAD_TIMEOUT:case L.LEVEL_LOAD_TIMEOUT:case L.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function _i(a,e){const t=at(e);return a.default[`${t?"timeout":"error"}Retry`]}function Qt(a,e){const t=a.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*a.retryDelayMs,a.maxRetryDelayMs)}function wi(a){return ue(ue({},a),{errorRetry:null,timeoutRetry:null})}function ot(a,e,t,i){return!!a&&e<a.maxNumRetry&&(Tn(i)||!!t)}function Tn(a){return a===0&&navigator.onLine===!1||!!a&&(a<400||a>499)}const bs={search:function(a,e){let t=0,i=a.length-1,s=null,r=null;for(;t<=i;){s=(t+i)/2|0,r=a[s];const n=e(r);if(n>0)t=s+1;else if(n<0)i=s-1;else return r}return null}};function xn(a,e,t){if(e===null||!Array.isArray(a)||!a.length||!F(e))return null;const i=a[0].programDateTime;if(e<(i||0))return null;const s=a[a.length-1].endProgramDateTime;if(e>=(s||0))return null;t=t||0;for(let r=0;r<a.length;++r){const n=a[r];if(yn(e,t,n))return n}return null}function He(a,e,t=0,i=0){let s=null;if(a?s=e[a.sn-e[0].sn+1]||null:t===0&&e[0].start===0&&(s=e[0]),s&&Vt(t,i,s)===0)return s;const r=bs.search(e,Vt.bind(null,t,i));return r&&(r!==a||!s)?r:s}function Vt(a=0,e=0,t){if(t.start<=a&&t.start+t.duration>a)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=a?1:t.start-i>a&&t.start?-1:0}function yn(a,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>a}function En(a,e){return bs.search(a,t=>t.cc<e?1:t.cc>e?-1:0)}const vn=3e5;var oe={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},ge={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class Sn{constructor(e){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=e,this.log=y.log.bind(y,"[info]:"),this.warn=y.warn.bind(y,"[warning]:"),this.error=y.error.bind(y,"[error]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(g.ERROR,this.onError,this),e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(g.ERROR,this.onError,this),e.off(g.ERROR,this.onErrorOut,this),e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){this.playlistError=0}stopLoad(){}getVariantLevelIndex(e){return(e==null?void 0:e.type)===U.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;const s=this.hls,r=t.context;switch(t.details){case L.FRAG_LOAD_ERROR:case L.FRAG_LOAD_TIMEOUT:case L.KEY_LOAD_ERROR:case L.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case L.FRAG_GAP:case L.FRAG_PARSING_ERROR:case L.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=oe.SendAlternateToPenaltyBox;return}case L.LEVEL_EMPTY_ERROR:case L.LEVEL_PARSING_ERROR:{var n,o;const l=t.parent===U.MAIN?t.level:s.loadLevel;t.details===L.LEVEL_EMPTY_ERROR&&((n=t.context)!=null&&(o=n.levelDetails)!=null&&o.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,l):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,l))}return;case L.LEVEL_LOAD_ERROR:case L.LEVEL_LOAD_TIMEOUT:typeof(r==null?void 0:r.level)=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.level));return;case L.AUDIO_TRACK_LOAD_ERROR:case L.AUDIO_TRACK_LOAD_TIMEOUT:case L.SUBTITLE_LOAD_ERROR:case L.SUBTITLE_TRACK_LOAD_TIMEOUT:if(r){const l=s.levels[s.loadLevel];if(l&&(r.type===G.AUDIO_TRACK&&r.groupId===l.audioGroupId||r.type===G.SUBTITLE_TRACK&&r.groupId===l.textGroupId)){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.loadLevel),t.errorAction.action=oe.SendAlternateToPenaltyBox,t.errorAction.flags=ge.MoveAllAlternatesMatchingHost;return}}return;case L.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const l=s.levels[s.loadLevel],u=l==null?void 0:l.attrs["HDCP-LEVEL"];u&&(t.errorAction={action:oe.SendAlternateToPenaltyBox,flags:ge.MoveAllAlternatesMatchingHDCP,hdcpLevel:u})}return;case L.BUFFER_ADD_CODEC_ERROR:case L.REMUX_ALLOC_ERROR:t.errorAction=this.getLevelSwitchAction(t,(i=t.level)!=null?i:s.loadLevel);return;case L.INTERNAL_EXCEPTION:case L.BUFFER_APPENDING_ERROR:case L.BUFFER_APPEND_ERROR:case L.BUFFER_FULL_ERROR:case L.LEVEL_SWITCH_ERROR:case L.BUFFER_STALLED_ERROR:case L.BUFFER_SEEK_OVER_HOLE:case L.BUFFER_NUDGE_ON_STALL:t.errorAction={action:oe.DoNothing,flags:ge.None};return}if(t.type===N.KEY_SYSTEM_ERROR){const l=this.getVariantLevelIndex(t.frag);t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,l);return}}getPlaylistRetryOrSwitchAction(e,t){var i;const s=this.hls,r=_i(s.config.playlistLoadPolicy,e),n=this.playlistError++,o=(i=e.response)==null?void 0:i.code;if(ot(r,n,at(e),o))return{action:oe.RetryRequest,flags:ge.None,retryConfig:r,retryCount:n};const u=this.getLevelSwitchAction(e,t);return r&&(u.retryConfig=r,u.retryCount=n),u}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),s=t.levels[i],{fragLoadPolicy:r,keyLoadPolicy:n}=t.config,o=_i(e.details.startsWith("key")?n:r,e),l=t.levels.reduce((d,h)=>d+h.fragmentError,0);if(s){var u;e.details!==L.FRAG_GAP&&s.fragmentError++;const d=(u=e.response)==null?void 0:u.code;if(ot(o,l,at(e),d))return{action:oe.RetryRequest,flags:ge.None,retryConfig:o,retryCount:l}}const c=this.getLevelSwitchAction(e,i);return o&&(c.retryConfig=o,c.retryCount=l),c}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const s=this.hls.levels[t];if(s&&(s.loadError++,i.autoLevelEnabled)){var r,n;let o=-1;const l=i.levels,u=(r=e.frag)==null?void 0:r.type,{type:c,groupId:d}=(n=e.context)!=null?n:{};for(let h=l.length;h--;){const f=(h+i.loadLevel)%l.length;if(f!==i.loadLevel&&l[f].loadError===0){const m=l[f];if(e.details===L.FRAG_GAP&&e.frag){const p=l[f].details;if(p){const T=He(e.frag,p.fragments,e.frag.start);if(T!=null&&T.gap)continue}}else{if(c===G.AUDIO_TRACK&&d===m.audioGroupId||c===G.SUBTITLE_TRACK&&d===m.textGroupId)continue;if(u===U.AUDIO&&s.audioGroupId===m.audioGroupId||u===U.SUBTITLE&&s.textGroupId===m.textGroupId)continue}o=f;break}}if(o>-1&&i.loadLevel!==o)return e.levelRetry=!0,this.playlistError=0,{action:oe.SendAlternateToPenaltyBox,flags:ge.None,nextAutoLevel:o}}return{action:oe.SendAlternateToPenaltyBox,flags:ge.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case oe.DoNothing:break;case oe.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==L.FRAG_GAP&&(t.fatal=!0);break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:s,hdcpLevel:r,nextAutoLevel:n}=i;switch(s){case ge.None:this.switchLevel(e,n);break;case ge.MoveAllAlternatesMatchingHost:i.resolved||(i.resolved=this.redundantFailover(e));break;case ge.MoveAllAlternatesMatchingHDCP:r&&(t.maxHdcpLevel=qt[qt.indexOf(r)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(e,n)}switchLevel(e,t){t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}redundantFailover(e){const{hls:t,penalizedRenditions:i}=this,s=e.parent===U.MAIN?e.level:t.loadLevel,r=t.levels[s],n=r.url.length,o=e.frag?e.frag.urlId:r.urlId;r.urlId===o&&(!e.frag||r.details)&&this.penalizeRendition(r,e);for(let l=1;l<n;l++){const u=(o+l)%n,c=i[u];if(!c||An(c,e,i[o]))return this.warn(`Switching to Redundant Stream ${u+1}/${n}: "${r.url[u]}" after ${e.details}`),this.playlistError=0,t.levels.forEach(d=>{d.urlId=u}),t.nextLoadLevel=s,!0}return!1}penalizeRendition(e,t){const{penalizedRenditions:i}=this,s=i[e.urlId]||{lastErrorPerfMs:0,errors:[],details:void 0};s.lastErrorPerfMs=performance.now(),s.errors.push(t),s.details=e.details,i[e.urlId]=s}}function An(a,e,t){if(performance.now()-a.lastErrorPerfMs>vn)return!0;const i=a.details;if(e.details===L.FRAG_GAP&&i&&e.frag){const s=e.frag.start,r=He(null,i.fragments,s);if(r&&!r.gap)return!0}if(t&&a.errors.length<t.errors.length){const s=a.errors[a.errors.length-1];if(i&&s.frag&&e.frag&&Math.abs(s.frag.start-e.frag.start)>i.targetduration*3)return!0}return!1}class Jt{constructor(e,t){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=y.log.bind(y,`${t}:`),this.warn=y.warn.bind(y,`${t}:`),this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){clearTimeout(this.timer),this.timer=-1}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t){const i=t==null?void 0:t.renditionReports;if(i){let s=-1;for(let r=0;r<i.length;r++){const n=i[r];let o;try{o=new self.URL(n.URI,t.url).href}catch(l){y.warn(`Could not construct new URL for Rendition Report: ${l}`),o=n.URI||""}if(o===e){s=r;break}else o===e.substring(0,o.length)&&(s=r)}if(s!==-1){const r=i[s],n=parseInt(r["LAST-MSN"])||(t==null?void 0:t.lastPartSn);let o=parseInt(r["LAST-PART"])||(t==null?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const l=Math.min(t.age-t.partTarget,t.targetduration);o>=0&&l>t.partTarget&&(o+=1)}return new Ci(n,o>=0?o:void 0,qe.No)}}}loadPlaylist(e){this.requestScheduled===-1&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}shouldReloadPlaylist(e){return this.timer===-1&&this.requestScheduled===-1&&this.shouldLoadPlaylist(e)}playlistLoaded(e,t,i){const{details:s,stats:r}=t,n=self.performance.now(),o=r.loading.first?Math.max(0,n-r.loading.first):0;if(s.advancedDateTime=Date.now()-o,s.live||i!=null&&i.live){if(s.reloaded(i),i&&this.log(`live playlist ${e} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:"MISSED"}`),i&&s.fragments.length>0&&dn(i,s),!this.canLoad||!s.live)return;let l,u,c;if(s.canBlockReload&&s.endSN&&s.advanced){const T=this.hls.config.lowLatencyMode,x=s.lastPartSn,v=s.endSN,E=s.lastPartIndex,R=E!==-1,A=x===v,k=T?0:E;R?(u=A?v+1:x,c=A?k:E+1):u=v+1;const D=s.age,C=D+s.ageHeader;let _=Math.min(C-s.partTarget,s.targetduration*1.5);if(_>0){if(i&&_>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${_} with playlist age: ${s.age}`),_=0;else{const I=Math.floor(_/s.targetduration);if(u+=I,c!==void 0){const O=Math.round(_%s.targetduration/s.partTarget);c+=O}this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${D.toFixed(2)}s goal: ${_} skip sn ${I} to part ${c}`)}s.tuneInGoal=_}if(l=this.getDeliveryDirectives(s,t.deliveryDirectives,u,c),T||!A){this.loadPlaylist(l);return}}else s.canBlockReload&&(l=this.getDeliveryDirectives(s,t.deliveryDirectives,u,c));const d=this.hls.mainForwardBufferInfo,h=d?d.end-d.len:0,f=(s.edge-h)*1e3,m=gn(s,f);s.updated&&n>this.requestScheduled+m&&(this.requestScheduled=r.loading.start),u!==void 0&&s.canBlockReload?this.requestScheduled=r.loading.first+m-(s.partTarget*1e3||1e3):this.requestScheduled===-1||this.requestScheduled+m<n?this.requestScheduled=n:this.requestScheduled-n<=0&&(this.requestScheduled+=m);let p=this.requestScheduled-n;p=Math.max(0,p),this.log(`reload live playlist ${e} in ${Math.round(p)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(l),p)}else this.clearTimer()}getDeliveryDirectives(e,t,i,s){let r=cn(e,i);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,s=t.part,r=qe.No),new Ci(i,s,r)}checkRetry(e){const t=e.details,i=at(e),s=e.errorAction,{action:r,retryCount:n=0,retryConfig:o}=s||{},l=!!s&&!!o&&(r===oe.RetryRequest||!s.resolved&&r===oe.SendAlternateToPenaltyBox);if(l){var u;if(this.requestScheduled=-1,n>=o.maxNumRetry)return!1;if(i&&(u=e.context)!=null&&u.deliveryDirectives)this.warn(`Retrying playlist loading ${n+1}/${o.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const c=Qt(o,n);this.timer=self.setTimeout(()=>this.loadPlaylist(),c),this.warn(`Retrying playlist loading ${n+1}/${o.maxNumRetry} after "${t}" in ${c}ms`)}e.levelRetry=!0,s.resolved=!0}return l}}let St;class Ln extends Jt{constructor(e,t){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(g.LEVEL_LOADED,this.onLevelLoaded,this),e.on(g.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(g.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(g.FRAG_LOADED,this.onFragLoaded,this),e.on(g.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(g.LEVEL_LOADED,this.onLevelLoaded,this),e.off(g.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(g.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(g.FRAG_LOADED,this.onFragLoaded,this),e.off(g.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}startLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.startLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[]}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=[],s={};let r;t.levels.forEach(n=>{var o;const l=n.attrs;((o=n.audioCodec)==null?void 0:o.indexOf("mp4a.40.34"))!==-1&&(St||(St=/chrome|firefox/i.test(navigator.userAgent)),St&&(n.audioCodec=void 0));const{AUDIO:u,CODECS:c,"FRAME-RATE":d,"PATHWAY-ID":h,RESOLUTION:f,SUBTITLES:m}=l,T=`${`${h||"."}-`}${n.bitrate}-${f}-${d}-${c}`;r=s[T],r?r.addFallback(n):(r=new Ve(n),s[T]=r,i.push(r)),lt(r,"audio",u),lt(r,"text",m)}),this.filterAndSortMediaOptions(i,t)}filterAndSortMediaOptions(e,t){let i=[],s=[],r=!1,n=!1,o=!1,l=e.filter(({audioCodec:f,videoCodec:m,width:p,height:T,unknownCodecs:x})=>(r||(r=!!(p&&T)),n||(n=!!m),o||(o=!!f),!(x!=null&&x.length)&&(!f||xt(f,"audio"))&&(!m||xt(m,"video"))));if((r||n)&&o&&(l=l.filter(({videoCodec:f,width:m,height:p})=>!!f||!!(m&&p))),l.length===0){Promise.resolve().then(()=>{if(this.hls){const f=new Error("no level with compatible codecs found in manifest");this.hls.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:f,reason:f.message})}});return}t.audioTracks&&(i=t.audioTracks.filter(f=>!f.audioCodec||xt(f.audioCodec,"audio")),Pi(i)),t.subtitles&&(s=t.subtitles,Pi(s));const u=l.slice(0);l.sort((f,m)=>f.attrs["HDCP-LEVEL"]!==m.attrs["HDCP-LEVEL"]?(f.attrs["HDCP-LEVEL"]||"")>(m.attrs["HDCP-LEVEL"]||"")?1:-1:f.bitrate!==m.bitrate?f.bitrate-m.bitrate:f.attrs["FRAME-RATE"]!==m.attrs["FRAME-RATE"]?f.attrs.decimalFloatingPoint("FRAME-RATE")-m.attrs.decimalFloatingPoint("FRAME-RATE"):f.attrs.SCORE!==m.attrs.SCORE?f.attrs.decimalFloatingPoint("SCORE")-m.attrs.decimalFloatingPoint("SCORE"):r&&f.height!==m.height?f.height-m.height:0);let c=u[0];if(this.steering&&(l=this.steering.filterParsedLevels(l),l.length!==u.length)){for(let f=0;f<u.length;f++)if(u[f].pathwayId===l[0].pathwayId){c=u[f];break}}this._levels=l;for(let f=0;f<l.length;f++)if(l[f]===c){this._firstLevel=f,this.log(`manifest loaded, ${l.length} level(s) found, first bitrate: ${c.bitrate}`);break}const d=o&&!n,h={levels:l,audioTracks:i,subtitleTracks:s,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:o,video:n,altAudio:!d&&i.some(f=>!!f.url)};this.hls.trigger(g.MANIFEST_PARSED,h),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return this._levels.length===0?null:this._levels}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const c=new Error("invalid level idx"),d=e<0;if(this.hls.trigger(g.ERROR,{type:N.OTHER_ERROR,details:L.LEVEL_SWITCH_ERROR,level:e,fatal:d,error:c,reason:c.message}),d)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,s=this.currentLevel,r=s?s.attrs["PATHWAY-ID"]:void 0,n=t[e],o=n.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=n,i===e&&n.details&&s&&r===o)return;this.log(`Switching to level ${e}${o?" with Pathway "+o:""} from level ${i}${r?" with Pathway "+r:""}`);const l=ee({},n,{level:e,maxBitrate:n.maxBitrate,attrs:n.attrs,uri:n.uri,urlId:n.urlId});delete l._attrs,delete l._urlId,this.hls.trigger(g.LEVEL_SWITCHING,l);const u=n.details;if(!u||u.live){const c=this.switchParams(n.uri,s==null?void 0:s.details);this.loadPlaylist(c)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this._firstLevel}else return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){t.fatal||!t.context||t.context.type===G.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragLoaded(e,{frag:t}){if(t!==void 0&&t.type===U.MAIN){const i=this._levels[t.level];i!==void 0&&(i.loadError=0)}}onLevelLoaded(e,t){var i;const{level:s,details:r}=t,n=this._levels[s];if(!n){var o;this.warn(`Invalid level index ${s}`),(o=t.deliveryDirectives)!=null&&o.skip&&(r.deltaUpdateFailed=!0);return}s===this.currentLevelIndex?(n.fragmentError===0&&(n.loadError=0),this.playlistLoaded(s,t,n.details)):(i=t.deliveryDirectives)!=null&&i.skip&&(r.deltaUpdateFailed=!0)}onAudioTrackSwitched(e,t){const i=this.currentLevel;if(!i)return;const s=this.hls.audioTracks[t.id].groupId;if(i.audioGroupIds&&i.audioGroupId!==s){let r=-1;for(let n=0;n<i.audioGroupIds.length;n++)if(i.audioGroupIds[n]===s){r=n;break}r!==-1&&r!==i.urlId&&(i.urlId=r,this.canLoad&&this.startLoad())}}loadPlaylist(e){super.loadPlaylist();const t=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){const s=i.urlId;let r=i.uri;if(e)try{r=e.addDirectives(r)}catch(o){this.warn(`Could not construct new URL with HLS Delivery Directives: ${o}`)}const n=i.attrs["PATHWAY-ID"];this.log(`Loading level index ${t}${(e==null?void 0:e.msn)!==void 0?" at sn "+e.msn+" part "+e.part:""} with${n?" Pathway "+n:""} URI ${s+1}/${i.url.length} ${r}`),this.clearTimer(),this.hls.trigger(g.LEVEL_LOADING,{url:r,level:t,id:s,deliveryDirectives:e||null})}}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e,t){const i=(r,n)=>n!==t,s=this._levels.filter((r,n)=>n!==e?!0:r.url.length>1&&t!==void 0?(r.url=r.url.filter(i),r.audioGroupIds&&(r.audioGroupIds=r.audioGroupIds.filter(i)),r.textGroupIds&&(r.textGroupIds=r.textGroupIds.filter(i)),r.urlId=0,!0):(this.steering&&this.steering.removeLevel(r),!1));this.hls.trigger(g.LEVELS_UPDATED,{levels:s})}onLevelsUpdated(e,{levels:t}){t.forEach((i,s)=>{const{details:r}=i;r!=null&&r.fragments&&r.fragments.forEach(n=>{n.level=s})}),this._levels=t}}function lt(a,e,t){t&&(e==="audio"?(a.audioGroupIds||(a.audioGroupIds=[]),a.audioGroupIds[a.url.length-1]=t):e==="text"&&(a.textGroupIds||(a.textGroupIds=[]),a.textGroupIds[a.url.length-1]=t))}function Pi(a){const e={};a.forEach(t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}var ie={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class Rn{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(g.BUFFER_APPENDED,this.onBufferAppended,this),e.on(g.FRAG_BUFFERED,this.onFragBuffered,this),e.on(g.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(g.BUFFER_APPENDED,this.onBufferAppended,this),e.off(g.FRAG_BUFFERED,this.onFragBuffered,this),e.off(g.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let s=i.length;s--;){const r=i[s];if(!r)break;const n=r.end;if(r.start<=e&&n!==null&&e<=n)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){const{fragments:i}=this,s=Object.keys(i);for(let r=s.length;r--;){const n=i[s[r]];if((n==null?void 0:n.body.type)===t&&n.buffered){const o=n.body;if(o.start<=e&&e<=o.end)return o}}return null}detectEvictedFragments(e,t,i,s){this.timeRanges&&(this.timeRanges[e]=t);const r=(s==null?void 0:s.fragment.sn)||-1;Object.keys(this.fragments).forEach(n=>{const o=this.fragments[n];if(!o||r>=o.body.sn)return;if(!o.buffered&&!o.loaded){o.body.type===i&&this.removeFragment(o.body);return}const l=o.range[e];l&&l.time.some(u=>{const c=!this.isTimeBuffered(u.startPTS,u.endPTS,t);return c&&this.removeFragment(o.body),c})})}detectPartialFragments(e){const t=this.timeRanges,{frag:i,part:s}=e;if(!t||i.sn==="initSegment")return;const r=Fe(i),n=this.fragments[r];if(!n)return;const o=!i.relurl;Object.keys(t).forEach(l=>{const u=i.elementaryStreams[l];if(!u)return;const c=t[l],d=o||u.partial===!0;n.range[l]=this.getBufferedTimes(i,s,d,c)}),n.loaded=null,Object.keys(n.range).length?(n.buffered=!0,n.body.endList&&(this.endListFragments[n.body.type]=n),je(n)||this.removeParts(i.sn-1,i.type)):this.removeFragment(n.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=i.filter(s=>s.fragment.sn>=e))}fragBuffered(e,t){const i=Fe(e);let s=this.fragments[i];!s&&t&&(s=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),s&&(s.loaded=null,s.buffered=!0)}getBufferedTimes(e,t,i,s){const r={time:[],partial:i},n=e.start,o=e.end,l=e.minEndPTS||o,u=e.maxStartPTS||n;for(let c=0;c<s.length;c++){const d=s.start(c)-this.bufferPadding,h=s.end(c)+this.bufferPadding;if(u>=d&&l<=h){r.time.push({startPTS:Math.max(n,s.start(c)),endPTS:Math.min(o,s.end(c))});break}else if(n<h&&o>d)r.partial=!0,r.time.push({startPTS:Math.max(n,s.start(c)),endPTS:Math.min(o,s.end(c))});else if(o<=d)break}return r}getPartialFragment(e){let t=null,i,s,r,n=0;const{bufferPadding:o,fragments:l}=this;return Object.keys(l).forEach(u=>{const c=l[u];c&&je(c)&&(s=c.body.start-o,r=c.body.end+o,e>=s&&e<=r&&(i=Math.min(e-s,r-e),n<=i&&(t=c.body,n=i)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||je(t))}getState(e){const t=Fe(e),i=this.fragments[t];return i?i.buffered?je(i)?ie.PARTIAL:ie.OK:ie.APPENDING:ie.NOT_LOADED}isTimeBuffered(e,t,i){let s,r;for(let n=0;n<i.length;n++){if(s=i.start(n)-this.bufferPadding,r=i.end(n)+this.bufferPadding,e>=s&&t<=r)return!0;if(t<=s)return!1}return!1}onFragLoaded(e,t){const{frag:i,part:s}=t;if(i.sn==="initSegment"||i.bitrateTest)return;const r=s?null:t,n=Fe(i);this.fragments[n]={body:i,appendedPTS:null,loaded:r,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:s,timeRanges:r}=t;if(i.sn==="initSegment")return;const n=i.type;if(s){let o=this.activePartLists[n];o||(this.activePartLists[n]=o=[]),o.push(s)}this.timeRanges=r,Object.keys(r).forEach(o=>{const l=r[o];this.detectEvictedFragments(o,l,n,s)})}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=Fe(e);return!!this.fragments[t]}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,s,r){s&&!this.hasGaps||Object.keys(this.fragments).forEach(n=>{const o=this.fragments[n];if(!o)return;const l=o.body;l.type!==i||s&&!l.gap||l.start<t&&l.end>e&&(o.buffered||r)&&this.removeFragment(l)})}removeFragment(e){const t=Fe(e);e.stats.loaded=0,e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const s=e.sn;this.activePartLists[e.type]=i.filter(r=>r.fragment.sn!==s)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function je(a){var e,t,i;return a.buffered&&(a.body.gap||((e=a.range.video)==null?void 0:e.partial)||((t=a.range.audio)==null?void 0:t.partial)||((i=a.range.audiovideo)==null?void 0:i.partial))}function Fe(a){return`${a.type}_${a.level}_${a.urlId}_${a.sn}`}const Fi=Math.pow(2,17);class In{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new Ae({type:N.NETWORK_ERROR,details:L.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const s=this.config,r=s.fLoader,n=s.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap){l(Mi(e));return}const u=this.loader=e.loader=r?new r(s):new n(s),c=Oi(e),d=wi(s.fragLoadPolicy.default),h={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:Fi};e.stats=u.stats,u.load(c,h,{onSuccess:(f,m,p,T)=>{this.resetLoader(e,u);let x=f.data;p.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(x.slice(0,16)),x=x.slice(16)),o({frag:e,part:null,payload:x,networkDetails:T})},onError:(f,m,p,T)=>{this.resetLoader(e,u),l(new Ae({type:N.NETWORK_ERROR,details:L.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:ue({url:i,data:void 0},f),error:new Error(`HTTP Error ${f.code} ${f.text}`),networkDetails:p,stats:T}))},onAbort:(f,m,p)=>{this.resetLoader(e,u),l(new Ae({type:N.NETWORK_ERROR,details:L.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:p,stats:f}))},onTimeout:(f,m,p)=>{this.resetLoader(e,u),l(new Ae({type:N.NETWORK_ERROR,details:L.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${h.timeout}ms`),networkDetails:p,stats:f}))},onProgress:(f,m,p,T)=>{t&&t({frag:e,part:null,payload:p,networkDetails:T})}})})}loadPart(e,t,i){this.abort();const s=this.config,r=s.fLoader,n=s.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(Mi(e,t));return}const u=this.loader=e.loader=r?new r(s):new n(s),c=Oi(e,t),d=wi(s.fragLoadPolicy.default),h={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Fi};t.stats=u.stats,u.load(c,h,{onSuccess:(f,m,p,T)=>{this.resetLoader(e,u),this.updateStatsFromPart(e,t);const x={frag:e,part:t,payload:f.data,networkDetails:T};i(x),o(x)},onError:(f,m,p,T)=>{this.resetLoader(e,u),l(new Ae({type:N.NETWORK_ERROR,details:L.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:ue({url:c.url,data:void 0},f),error:new Error(`HTTP Error ${f.code} ${f.text}`),networkDetails:p,stats:T}))},onAbort:(f,m,p)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,u),l(new Ae({type:N.NETWORK_ERROR,details:L.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:p,stats:f}))},onTimeout:(f,m,p)=>{this.resetLoader(e,u),l(new Ae({type:N.NETWORK_ERROR,details:L.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${h.timeout}ms`),networkDetails:p,stats:f}))}})})}updateStatsFromPart(e,t){const i=e.stats,s=t.stats,r=s.total;if(i.loaded+=s.loaded,r){const l=Math.round(e.duration/t.duration),u=Math.min(Math.round(i.loaded/r),l),d=(l-u)*Math.round(i.loaded/u);i.total=i.loaded+d}else i.total=Math.max(i.loaded,i.total);const n=i.loading,o=s.loading;n.start?n.first+=o.first-o.start:(n.start=o.start,n.first=o.first),n.end=o.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function Oi(a,e=null){const t=e||a,i={frag:a,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},s=t.byteRangeStartOffset,r=t.byteRangeEndOffset;if(F(s)&&F(r)){var n;let o=s,l=r;if(a.sn==="initSegment"&&((n=a.decryptdata)==null?void 0:n.method)==="AES-128"){const u=r-s;u%16&&(l=r+(16-u%16)),s!==0&&(i.resetIV=!0,o=s-16)}i.rangeStart=o,i.rangeEnd=l}return i}function Mi(a,e){const t=new Error(`GAP ${a.gap?"tag":"attribute"} found`),i={type:N.MEDIA_ERROR,details:L.FRAG_GAP,fatal:!1,frag:a,error:t,networkDetails:null};return e&&(i.part=e),(e||a).stats.aborted=!0,new Ae(i)}class Ae extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class bn{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const t in this.keyUriToKeyInfo){const i=this.keyUriToKeyInfo[t].loader;if(i){if(e&&e!==i.context.frag.type)return;i.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=L.KEY_LOAD_ERROR,i,s,r){return new Ae({type:N.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:r,error:i,networkDetails:s})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:s}=e;for(let r=0;r<t.length;r++){const n=t[r];if(s<=n.cc&&(i==="initSegment"||n.sn==="initSegment"||i<n.sn)){this.emeController.selectKeySystemFormat(n).then(o=>{n.setKeyFormat(o)});break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,s;t&&e.setKeyFormat(t);const r=e.decryptdata;if(!r){const u=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,L.KEY_LOAD_ERROR,u))}const n=r.uri;if(!n)return Promise.reject(this.createKeyLoadError(e,L.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${n}"`)));let o=this.keyUriToKeyInfo[n];if((i=o)!=null&&i.decryptdata.key)return r.key=o.decryptdata.key,Promise.resolve({frag:e,keyInfo:o});if((s=o)!=null&&s.keyLoadPromise){var l;switch((l=o.mediaKeySessionContext)==null?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return o.keyLoadPromise.then(u=>(r.key=u.keyInfo.decryptdata.key,{frag:e,keyInfo:o}))}}switch(o=this.keyUriToKeyInfo[n]={decryptdata:r,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},r.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return r.keyFormat==="identity"?this.loadKeyHTTP(o,e):this.loadKeyEME(o,e);case"AES-128":return this.loadKeyHTTP(o,e);default:return Promise.reject(this.createKeyLoadError(e,L.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${r.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const s=this.emeController.loadKey(i);if(s)return(e.keyLoadPromise=s.then(r=>(e.mediaKeySessionContext=r,i))).catch(r=>{throw e.keyLoadPromise=null,r})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,s=i.loader,r=new s(i);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise((n,o)=>{const l={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},u=i.keyLoadPolicy.default,c={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},d={onSuccess:(h,f,m,p)=>{const{frag:T,keyInfo:x,url:v}=m;if(!T.decryptdata||x!==this.keyUriToKeyInfo[v])return o(this.createKeyLoadError(T,L.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),p));x.decryptdata.key=T.decryptdata.key=new Uint8Array(h.data),T.keyLoader=null,x.loader=null,n({frag:T,keyInfo:x})},onError:(h,f,m,p)=>{this.resetLoader(f),o(this.createKeyLoadError(t,L.KEY_LOAD_ERROR,new Error(`HTTP Error ${h.code} loading key ${h.text}`),m,ue({url:l.url,data:void 0},h)))},onTimeout:(h,f,m)=>{this.resetLoader(f),o(this.createKeyLoadError(t,L.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),m))},onAbort:(h,f,m)=>{this.resetLoader(f),o(this.createKeyLoadError(t,L.INTERNAL_ABORTED,new Error("key loading aborted"),m))}};r.load(l,c,d)})}resetLoader(e){const{frag:t,keyInfo:i,url:s}=e,r=i.loader;t.keyLoader===r&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[s],r&&r.destroy()}}class Dn{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}const Cn={length:0,start:()=>0,end:()=>0};class Y{static isBuffered(e,t){try{if(e){const i=Y.getBuffered(e);for(let s=0;s<i.length;s++)if(t>=i.start(s)&&t<=i.end(s))return!0}}catch{}return!1}static bufferInfo(e,t,i){try{if(e){const s=Y.getBuffered(e),r=[];let n;for(n=0;n<s.length;n++)r.push({start:s.start(n),end:s.end(n)});return this.bufferedInfo(r,t,i)}}catch{}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.sort(function(u,c){const d=u.start-c.start;return d||c.end-u.end});let s=[];if(i)for(let u=0;u<e.length;u++){const c=s.length;if(c){const d=s[c-1].end;e[u].start-d<i?e[u].end>d&&(s[c-1].end=e[u].end):s.push(e[u])}else s.push(e[u])}else s=e;let r=0,n,o=t,l=t;for(let u=0;u<s.length;u++){const c=s[u].start,d=s[u].end;if(t+i>=c&&t<d)o=c,l=d,r=l-t;else if(t+i<c){n=c;break}}return{len:r,start:o||0,end:l||0,nextStart:n}}static getBuffered(e){try{return e.buffered}catch(t){return y.log("failed to get media.buffered",t),Cn}}}class Zt{constructor(e,t,i,s=0,r=-1,n=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=Xe(),this.buffering={audio:Xe(),video:Xe(),audiovideo:Xe()},this.level=e,this.sn=t,this.id=i,this.size=s,this.part=r,this.partial=n}}function Xe(){return{start:0,executeStart:0,executeEnd:0,end:0}}function Ds(a,e){let t=null;for(let i=0,s=a.length;i<s;i++){const r=a[i];if(r&&r.cc===e){t=r;break}}return t}function kn(a,e,t){return!!(e.details&&(t.endCC>t.startCC||a&&a.cc<t.startCC))}function _n(a,e,t=0){const i=a.fragments,s=e.fragments;if(!s.length||!i.length){y.log("No fragments to align");return}const r=Ds(i,s[0].cc);if(!r||r&&!r.startPTS){y.log("No frag in previous level to align on");return}return r}function Ni(a,e){if(a){const t=a.start+e;a.start=a.startPTS=t,a.endPTS=t+a.duration}}function ei(a,e){const t=e.fragments;for(let i=0,s=t.length;i<s;i++)Ni(t[i],a);e.fragmentHint&&Ni(e.fragmentHint,a),e.alignedSliding=!0}function wn(a,e,t){e&&(Pn(a,t,e),!t.alignedSliding&&e.details&&Fn(t,e.details),!t.alignedSliding&&e.details&&!t.skippedSegments&&Rs(e.details,t))}function Pn(a,e,t){if(kn(a,t,e)){const i=_n(t.details,e);i&&F(i.start)&&(y.log(`Adjusting PTS using last level due to CC increase within current level ${e.url}`),ei(i.start,e))}}function Fn(a,e){if(!e.fragments.length||!a.hasProgramDateTime||!e.hasProgramDateTime)return;const t=e.fragments[0].programDateTime,i=a.fragments[0].programDateTime,s=(i-t)/1e3+e.fragments[0].start;s&&F(s)&&(y.log(`Adjusting PTS using programDateTime delta ${i-t}ms, sliding:${s.toFixed(3)} ${a.url} `),ei(s,a))}function Cs(a,e){if(!a.hasProgramDateTime||!e.hasProgramDateTime)return;const t=a.fragments,i=e.fragments;if(!t.length||!i.length)return;const s=Math.round(i.length/2)-1,r=i[s],n=Ds(t,r.cc)||t[Math.round(t.length/2)-1],o=r.programDateTime,l=n.programDateTime;if(o===null||l===null)return;const u=(l-o)/1e3-(n.start-r.start);ei(u,a)}class On{constructor(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class Mn{constructor(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}function Nn(a){const e=a.byteLength,t=e&&new DataView(a.buffer).getUint8(e-1);return t?we(a,0,e-t):a}class Un{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let s=0;s<4;s++)i[s]=t.getUint32(s*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,s=i[0],r=i[1],n=i[2],o=i[3],l=this.invSubMix,u=l[0],c=l[1],d=l[2],h=l[3],f=new Uint32Array(256);let m=0,p=0,T=0;for(T=0;T<256;T++)T<128?f[T]=T<<1:f[T]=T<<1^283;for(T=0;T<256;T++){let x=p^p<<1^p<<2^p<<3^p<<4;x=x>>>8^x&255^99,e[m]=x,t[x]=m;const v=f[m],E=f[v],R=f[E];let A=f[x]*257^x*16843008;s[m]=A<<24|A>>>8,r[m]=A<<16|A>>>16,n[m]=A<<8|A>>>24,o[m]=A,A=R*16843009^E*65537^v*257^m*16843008,u[x]=A<<24|A>>>8,c[x]=A<<16|A>>>16,d[x]=A<<8|A>>>24,h[x]=A,m?(m=v^f[f[f[R^v]]],p^=f[f[p]]):m=p=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,s=0;for(;s<t.length&&i;)i=t[s]===this.key[s],s++;if(i)return;this.key=t;const r=this.keySize=t.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);const n=this.ksRows=(r+6+1)*4;let o,l;const u=this.keySchedule=new Uint32Array(n),c=this.invKeySchedule=new Uint32Array(n),d=this.sBox,h=this.rcon,f=this.invSubMix,m=f[0],p=f[1],T=f[2],x=f[3];let v,E;for(o=0;o<n;o++){if(o<r){v=u[o]=t[o];continue}E=v,o%r===0?(E=E<<8|E>>>24,E=d[E>>>24]<<24|d[E>>>16&255]<<16|d[E>>>8&255]<<8|d[E&255],E^=h[o/r|0]<<24):r>6&&o%r===4&&(E=d[E>>>24]<<24|d[E>>>16&255]<<16|d[E>>>8&255]<<8|d[E&255]),u[o]=v=(u[o-r]^E)>>>0}for(l=0;l<n;l++)o=n-l,l&3?E=u[o]:E=u[o-4],l<4||o<=4?c[l]=E:c[l]=m[d[E>>>24]]^p[d[E>>>16&255]]^T[d[E>>>8&255]]^x[d[E&255]],c[l]=c[l]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const s=this.keySize+6,r=this.invKeySchedule,n=this.invSBox,o=this.invSubMix,l=o[0],u=o[1],c=o[2],d=o[3],h=this.uint8ArrayToUint32Array_(i);let f=h[0],m=h[1],p=h[2],T=h[3];const x=new Int32Array(e),v=new Int32Array(x.length);let E,R,A,k,D,C,_,I,O,w,V,re,j,z;const X=this.networkToHostOrderSwap;for(;t<x.length;){for(O=X(x[t]),w=X(x[t+1]),V=X(x[t+2]),re=X(x[t+3]),D=O^r[0],C=re^r[1],_=V^r[2],I=w^r[3],j=4,z=1;z<s;z++)E=l[D>>>24]^u[C>>16&255]^c[_>>8&255]^d[I&255]^r[j],R=l[C>>>24]^u[_>>16&255]^c[I>>8&255]^d[D&255]^r[j+1],A=l[_>>>24]^u[I>>16&255]^c[D>>8&255]^d[C&255]^r[j+2],k=l[I>>>24]^u[D>>16&255]^c[C>>8&255]^d[_&255]^r[j+3],D=E,C=R,_=A,I=k,j=j+4;E=n[D>>>24]<<24^n[C>>16&255]<<16^n[_>>8&255]<<8^n[I&255]^r[j],R=n[C>>>24]<<24^n[_>>16&255]<<16^n[I>>8&255]<<8^n[D&255]^r[j+1],A=n[_>>>24]<<24^n[I>>16&255]<<16^n[D>>8&255]<<8^n[C&255]^r[j+2],k=n[I>>>24]<<24^n[D>>16&255]<<16^n[C>>8&255]<<8^n[_&255]^r[j+3],v[t]=X(E^f),v[t+1]=X(k^m),v[t+2]=X(A^p),v[t+3]=X(R^T),f=O,m=w,p=V,T=re,t=t+4}return v.buffer}}const Bn=16;class ti{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.subtle===null&&(this.useSoftware=!0)}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?Nn(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i){return this.useSoftware?new Promise((s,r)=>{this.softwareDecrypt(new Uint8Array(e),t,i);const n=this.flush();n?s(n.buffer):r(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i)}softwareDecrypt(e,t,i){const{currentIV:s,currentResult:r,remainderData:n}=this;this.logOnce("JS AES decrypt"),n&&(e=Pe(n,e),this.remainderData=null);const o=this.getValidChunk(e);if(!o.length)return null;s&&(i=s);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new Un),l.expandKey(t);const u=r;return this.currentResult=l.decrypt(o.buffer,0,i),this.currentIV=we(o,-16).buffer,u||null}webCryptoDecrypt(e,t,i){const s=this.subtle;return(this.key!==t||!this.fastAesKey)&&(this.key=t,this.fastAesKey=new Mn(s,t)),this.fastAesKey.expandKey().then(r=>s?(this.logOnce("WebCrypto AES decrypt"),new On(s,new Uint8Array(i)).decrypt(e.buffer,r)):Promise.reject(new Error("web crypto not initialized"))).catch(r=>(y.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(e,t,i)))}onWebCryptoError(e,t,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i);const s=this.flush();if(s)return s.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%Bn;return i!==e.length&&(t=we(e,0,i),this.remainderData=we(e,i)),t}logOnce(e){this.logEnabled&&(y.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const $n={toString:function(a){let e="";const t=a.length;for(let i=0;i<t;i++)e+=`[${a.start(i).toFixed(3)}-${a.end(i).toFixed(3)}]`;return e}},b={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class ii extends Dn{constructor(e,t,i,s,r){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=b.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=r,this.logPrefix=s,this.log=y.log.bind(y,`${s}:`),this.warn=y.warn.bind(y,`${s}:`),this.hls=e,this.fragmentLoader=new In(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new ti(e.config),e.on(g.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=b.STOPPED}_streamEnded(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;const i=t.partList;if(i!=null&&i.length){const r=i[i.length-1];return Y.isBuffered(this.media,r.start+r.duration/2)}const s=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(s)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levels[this.levelLastLoaded])==null?void 0:e.details}}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const s=this.config;this.levels&&s.autoStartLoad&&this.state===b.STOPPED&&this.startLoad(s.startPosition)}onMediaDetaching(){const e=this.media;e!=null&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:e,fragCurrent:t,media:i,mediaBuffer:s,state:r}=this,n=i?i.currentTime:0,o=Y.bufferInfo(s||i,n,e.maxBufferHole);if(this.log(`media seeking to ${F(n)?n.toFixed(3):n}, state: ${r}`),this.state===b.ENDED)this.resetLoadingState();else if(t){const l=e.maxFragLookUpTolerance,u=t.start-l,c=t.start+t.duration+l;if(!o.len||c<o.start||u>o.end){const d=n>c;(n<u||d)&&(d&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}i&&(this.fragmentTracker.removeFragmentsInRange(n,1/0,this.playlistType,!0),this.lastCurrentTime=n),!this.loadedmetadata&&!o.len&&(this.nextLoadPosition=this.startPosition=n),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.stopLoad(),super.onHandlerDestroying()}onHandlerDestroyed(){this.state=b.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const s=r=>{if(this.fragContextChanged(e)){this.warn(`Fragment ${e.sn}${r.part?" p: "+r.part.index:""} of level ${e.level} was dropped during download.`),this.fragmentTracker.removeFragment(e);return}e.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(e,t,i,s).then(r=>{if(!r)return;const n=this.state;if(this.fragContextChanged(e)){(n===b.FRAG_LOADING||!this.fragCurrent&&n===b.PARSING)&&(this.fragmentTracker.removeFragment(e),this.state=b.IDLE);return}"payload"in r&&(this.log(`Loaded fragment ${e.sn} of level ${e.level}`),this.hls.trigger(g.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===b.STOPPED||this.state===b.ERROR||(this.warn(r),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===ie.APPENDING){const r=e.type,n=this.getFwdBufferInfo(this.mediaBuffer,r),o=Math.max(e.duration,n?n.len:this.config.maxBufferLength);this.reduceMaxBufferLength(o)&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===ie.PARTIAL&&i.removeFragment(e))}flushMainBuffer(e,t,i=null){if(!(e-t))return;const s={startOffset:e,endOffset:t,type:i};this.hls.trigger(g.BUFFER_FLUSHING,s)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{if(!i||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:s}=this,{payload:r}=i,n=e.decryptdata;if(r&&r.byteLength>0&&n&&n.key&&n.iv&&n.method==="AES-128"){const o=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),n.key.buffer,n.iv.buffer).catch(l=>{throw s.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.FRAG_DECRYPT_ERROR,fatal:!1,error:l,reason:l.message,frag:e}),l}).then(l=>{const u=self.performance.now();return s.trigger(g.FRAG_DECRYPTED,{frag:e,payload:l,stats:{tstart:o,tdecrypt:u}}),i.payload=l,i})}return i}).then(i=>{const{fragCurrent:s,hls:r,levels:n}=this;if(!n)throw new Error("init load aborted, missing levels");const o=e.stats;this.state=b.IDLE,t.fragmentError=0,e.data=new Uint8Array(i.payload),o.parsing.start=o.buffering.start=self.performance.now(),o.parsing.end=o.buffering.end=self.performance.now(),i.frag===s&&r.trigger(g.FRAG_BUFFERED,{stats:o,frag:s,part:null,id:e.type}),this.tick()}).catch(i=>{this.state===b.STOPPED||this.state===b.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.level!==t.level||e.sn!==t.sn||e.urlId!==t.urlId}fragBufferedComplete(e,t){var i,s,r,n;const o=this.mediaBuffer?this.mediaBuffer:this.media;this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.playlistType===U.MAIN?"level":"track"} ${e.level} (frag:[${((i=e.startPTS)!=null?i:NaN).toFixed(3)}-${((s=e.endPTS)!=null?s:NaN).toFixed(3)}] > buffer:${o?$n.toString(Y.getBuffered(o)):"(detached)"})`),this.state=b.IDLE,o&&(!this.loadedmetadata&&e.type==U.MAIN&&o.buffered.length&&((r=this.fragCurrent)==null?void 0:r.sn)===((n=this.fragPrevious)==null?void 0:n.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:s,partsLoaded:r}=e,n=!r||r.length===0||r.some(l=>!l),o=new Zt(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!n);t.flush(o)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,s){var r;const n=t==null?void 0:t.details;if(!this.levels||!n)throw new Error(`frag load aborted, missing level${n?"":" detail"}s`);let o=null;if(e.encrypted&&!((r=e.decryptdata)!=null&&r.key)?(this.log(`Loading key for ${e.sn} of [${n.startSN}-${n.endSN}], ${this.logPrefix==="[stream-controller]"?"level":"track"} ${e.level}`),this.state=b.KEY_LOADING,this.fragCurrent=e,o=this.keyLoader.load(e).then(c=>{if(!this.fragContextChanged(c.frag))return this.hls.trigger(g.KEY_LOADED,c),this.state===b.KEY_LOADING&&(this.state=b.IDLE),c}),this.hls.trigger(g.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(o=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!e.encrypted&&n.encryptedFragments.length&&this.keyLoader.loadClear(e,n.encryptedFragments),i=Math.max(e.start,i||0),this.config.lowLatencyMode&&e.sn!=="initSegment"){const c=n.partList;if(c&&s){i>e.end&&n.fragmentHint&&(e=n.fragmentHint);const d=this.getNextPart(c,e,i);if(d>-1){const h=c[d];this.log(`Loading part sn: ${e.sn} p: ${h.index} cc: ${e.cc} of playlist [${n.startSN}-${n.endSN}] parts [0-${d}-${c.length-1}] ${this.logPrefix==="[stream-controller]"?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=h.start+h.duration,this.state=b.FRAG_LOADING;let f;return o?f=o.then(m=>!m||this.fragContextChanged(m.frag)?null:this.doFragPartsLoad(e,h,t,s)).catch(m=>this.handleFragLoadError(m)):f=this.doFragPartsLoad(e,h,t,s).catch(m=>this.handleFragLoadError(m)),this.hls.trigger(g.FRAG_LOADING,{frag:e,part:h,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):f}else if(!e.url||this.loadedEndOfParts(c,i))return Promise.resolve(null)}}this.log(`Loading fragment ${e.sn} cc: ${e.cc} ${n?"of ["+n.startSN+"-"+n.endSN+"] ":""}${this.logPrefix==="[stream-controller]"?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),F(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=b.FRAG_LOADING;const l=this.config.progressive;let u;return l&&o?u=o.then(c=>!c||this.fragContextChanged(c==null?void 0:c.frag)?null:this.fragmentLoader.load(e,s)).catch(c=>this.handleFragLoadError(c)):u=Promise.all([this.fragmentLoader.load(e,l?s:void 0),o]).then(([c])=>(!l&&c&&s&&s(c),c)).catch(c=>this.handleFragLoadError(c)),this.hls.trigger(g.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):u}doFragPartsLoad(e,t,i,s){return new Promise((r,n)=>{var o;const l=[],u=(o=i.details)==null?void 0:o.partList,c=d=>{this.fragmentLoader.loadPart(e,d,s).then(h=>{l[d.index]=h;const f=h.part;this.hls.trigger(g.FRAG_LOADED,h);const m=ki(i,e.sn,d.index+1)||Is(u,e.sn,d.index+1);if(m)c(m);else return r({frag:e,part:f,partsLoaded:l})}).catch(n)};c(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===L.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(g.ERROR,t)}else this.hls.trigger(g.ERROR,{type:N.OTHER_ERROR,details:L.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==b.PARSING){!this.fragCurrent&&this.state!==b.STOPPED&&this.state!==b.ERROR&&(this.state=b.IDLE);return}const{frag:i,part:s,level:r}=t,n=self.performance.now();i.stats.parsing.end=n,s&&(s.stats.parsing.end=n),this.updateLevelTiming(i,s,r,e.partial)}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:s,sn:r,part:n}=e;if(!(t!=null&&t[s]))return this.warn(`Levels object was unset while buffering fragment ${r} of level ${s}. The current chunk will not be buffered.`),null;const o=t[s],l=n>-1?ki(o,r,n):null,u=l?l.fragment:pn(o,r,i);return u?(i&&i!==u&&(u.stats=i.stats),{frag:u,part:l,level:o}):null}bufferFragmentData(e,t,i,s){var r;if(!e||this.state!==b.PARSING)return;const{data1:n,data2:o}=e;let l=n;if(n&&o&&(l=Pe(n,o)),!((r=l)!=null&&r.length))return;const u={type:e.type,frag:t,part:i,chunkMeta:s,parent:t.type,data:l};this.hls.trigger(g.BUFFER_APPENDING,u),e.dropped&&e.independent&&!i&&this.flushBufferGap(t)}flushBufferGap(e){const t=this.media;if(!t)return;if(!Y.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,s=Y.bufferInfo(t,i,0),r=e.duration,n=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),o=Math.max(Math.min(e.start-n,s.end-n),i+n);e.start-o>n&&this.flushMainBuffer(o,e.start)}getFwdBufferInfo(e,t){const i=this.getLoadPosition();return F(i)?this.getFwdBufferInfoAtPos(e,i,t):null}getFwdBufferInfoAtPos(e,t,i){const{config:{maxBufferHole:s}}=this,r=Y.bufferInfo(e,t,s);if(r.len===0&&r.nextStart!==void 0){const n=this.fragmentTracker.getBufferedFrag(t,i);if(n&&r.nextStart<n.end)return Y.bufferInfo(e,t,Math.max(r.nextStart,s))}return r}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e){const t=this.config,i=e||t.maxBufferLength;return t.maxMaxBufferLength>=i?(t.maxMaxBufferLength/=2,this.warn(`Reduce max buffer length to ${t.maxMaxBufferLength}s`),!0):!1}getAppendedFrag(e,t=U.MAIN){const i=this.fragmentTracker.getAppendedFrag(e,U.MAIN);return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const i=t.fragments,s=i.length;if(!s)return null;const{config:r}=this,n=i[0].start;let o;if(t.live){const l=r.initialLiveManifestSize;if(s<l)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${l})`),null;!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1&&(o=this.getInitialLiveFragment(t,i),this.startPosition=o?this.hls.liveSyncPosition||o.start:e)}else e<=n&&(o=i[0]);if(!o){const l=r.lowLatencyMode?t.partEnd:t.fragmentEnd;o=this.getFragmentAtPosition(e,l,t)}return this.mapToInitFragWhenRequired(o)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===ie.OK||i===ie.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,s,r){const n=e.gap,o=this.getNextFragment(this.nextLoadPosition,t);if(o===null)return o;if(e=o,n&&e&&!e.gap&&i.nextStart){const l=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,s);if(l!==null&&i.len+l.len>=r)return this.log(`buffer full after gaps in "${s}" playlist starting at sn: ${e.sn}`),null}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let s=-1,r=!1,n=!0;for(let o=0,l=e.length;o<l;o++){const u=e[o];if(n=n&&!u.independent,s>-1&&i<u.start)break;const c=u.loaded;c?s=-1:(r||u.independent||n)&&u.fragment===t&&(s=o),r=c}return s}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e,t){const i=this.fragPrevious;let s=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),s=xn(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){const r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){const n=t[r-e.startSN];i.cc===n.cc&&(s=n,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}s||(s=En(t,i.cc),s&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`))}}else{const r=this.hls.liveSyncPosition;r!==null&&(s=this.getFragmentAtPosition(r,this.bitrateTest?e.fragmentEnd:e.edge,e))}return s}getFragmentAtPosition(e,t,i){const{config:s}=this;let{fragPrevious:r}=this,{fragments:n,endSN:o}=i;const{fragmentHint:l}=i,u=s.maxFragLookUpTolerance,c=i.partList,d=!!(s.lowLatencyMode&&c!=null&&c.length&&l);d&&l&&!this.bitrateTest&&(n=n.concat(l),o=l.sn);let h;if(e<t){const f=e>t-u?0:u;h=He(r,n,e,f)}else h=n[n.length-1];if(h){const f=h.sn-i.startSN,m=this.fragmentTracker.getState(h);if((m===ie.OK||m===ie.PARTIAL&&h.gap)&&(r=h),r&&h.sn===r.sn&&(!d||c[0].fragment.sn>h.sn)&&r&&h.level===r.level){const T=n[f+1];h.sn<o&&this.fragmentTracker.getState(T)!==ie.OK?h=T:h=null}}return h}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const s=this.hls.liveSyncPosition,r=i.currentTime,n=e.fragments[0].start,o=e.edge,l=r>=n-t.maxFragLookUpTolerance&&r<=o;if(s!==null&&i.duration>s&&(r<s||!l)){const u=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!l&&i.readyState<4||r<o-u)&&(this.loadedmetadata||(this.nextLoadPosition=s),i.readyState&&(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${o}, reset currentTime to : ${s.toFixed(3)}`),i.currentTime=s))}}alignPlaylists(e,t){const{levels:i,levelLastLoaded:s,fragPrevious:r}=this,n=s!==null?i[s]:null,o=e.fragments.length;if(!o)return this.warn("No fragments in live playlist"),0;const l=e.fragments[0].start,u=!t,c=e.alignedSliding&&F(l);if(u||!c&&!l){wn(r,n,e);const d=e.fragments[0].start;return this.log(`Live playlist sliding: ${d.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} prev-sn: ${r?r.sn:"na"} fragments: ${o}`),d}return l}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;if(i<t&&(i=-1),i===-1||this.lastCurrentTime===-1){const s=this.startTimeOffset!==null,r=s?this.startTimeOffset:e.startTimeOffset;r!==null&&F(r)?(i=t+r,r<0&&(i+=e.totalduration),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Start time offset ${r} found in ${s?"multivariant":"media"} playlist, adjust startPosition to ${i}`),this.startPosition=i):e.live?i=this.hls.liveSyncPosition||t:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:e}=this;let t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&e.sn!=="initSegment"&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==b.FRAG_LOADING_WAITING_RETRY)&&(this.state=b.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const c=this.getCurrentContext(t.chunkMeta);c&&(t.frag=c.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var s;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(s=this.fragCurrent)==null?void 0:s.url}`);return}const r=t.details===L.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);const n=t.errorAction,{action:o,retryCount:l=0,retryConfig:u}=n||{};if(n&&o===oe.RetryRequest&&u){this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition);const c=Qt(u,l);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${l+1}/${u.maxNumRetry} in ${c}ms`),n.resolved=!0,this.retryDate=self.performance.now()+c,this.state=b.FRAG_LOADING_WAITING_RETRY}else u&&n?(this.resetFragmentErrors(e),l<u.maxNumRetry?r||(n.resolved=!0):y.warn(`${t.details} reached or exceeded max retry (${l})`)):this.state=b.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===b.PARSING||this.state===b.PARSED){const t=e.parent,i=this.getFwdBufferInfo(this.mediaBuffer,t),s=i&&i.len>.5;s&&this.reduceMaxBufferLength(i.len);const r=!s;return r&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${t} buffer`),e.frag&&(this.fragmentTracker.removeFragment(e.frag),this.nextLoadPosition=e.frag.start),this.resetLoadingState(),r}return!1}resetFragmentErrors(e){e===U.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==b.STOPPED&&(this.state=b.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const s=Y.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,s,i),this.state===b.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=b.IDLE}resetStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;const t=this.levels?this.levels[e].details:null;t!=null&&t.live?(this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of level ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(e.level),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,s){var r;const n=i.details;if(!n){this.warn("level.details undefined");return}if(Object.keys(e.elementaryStreams).reduce((l,u)=>{const c=e.elementaryStreams[u];if(c){const d=c.endPTS-c.startPTS;if(d<=0)return this.warn(`Could not parse fragment ${e.sn} ${u} duration reliably (${d})`),l||!1;const h=s?0:Ls(n,e,c.startPTS,c.endPTS,c.startDTS,c.endDTS);return this.hls.trigger(g.LEVEL_PTS_UPDATED,{details:n,level:i,drift:h,type:u,frag:e,start:c.startPTS,end:c.endPTS}),!0}return l},!1))i.fragmentError=0;else if(((r=this.transmuxer)==null?void 0:r.error)===null){const l=new Error(`Found no media in fragment ${e.sn} of level ${i.id} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of level "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=b.PARSED,this.hls.trigger(g.FRAG_PARSED,{frag:e,part:t})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.resetTransmuxer(),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function ks(){return self.SourceBuffer||self.WebKitSourceBuffer}function Gn(){const a=ht();if(!a)return!1;const e=ks(),t=a&&typeof a.isTypeSupported=="function"&&a.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),i=!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function";return!!t&&!!i}function qn(){var a;const e=ks();return typeof(e==null||(a=e.prototype)==null?void 0:a.changeType)=="function"}function Kn(){return typeof __HLS_WORKER_BUNDLE__=="function"}function Vn(){const a=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),e=self.URL.createObjectURL(a);return{worker:new self.Worker(e),objectURL:e}}function Hn(a){const e=new self.URL(a,self.location.href).href;return{worker:new self.Worker(e),scriptURL:e}}function Ee(a="",e=9e4){return{type:a,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class _s{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=Pe(this.cachedData,e),this.cachedData=null);let i=rt(e,0),s=i?i.length:0,r;const n=this._audioTrack,o=this._id3Track,l=i?Ir(i):void 0,u=e.length;for((this.basePTS===null||this.frameIndex===0&&F(l))&&(this.basePTS=Wn(l,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Te.audioId3,duration:Number.POSITIVE_INFINITY});s<u;){if(this.canParse(e,s)){const c=this.appendFrame(n,e,s);c?(this.frameIndex++,this.lastPTS=c.sample.pts,s+=c.length,r=s):s=u}else Rr(e,s)?(i=rt(e,s),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Te.audioId3,duration:Number.POSITIVE_INFINITY}),s+=i.length,r=s):s++;if(s===u&&r!==u){const c=we(e,r);this.cachedData?this.cachedData=Pe(this.cachedData,c):this.cachedData=c}}return{audioTrack:n,videoTrack:Ee(),id3Track:o,textTrack:Ee()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:Ee(),id3Track:this._id3Track,textTrack:Ee()}}destroy(){}}const Wn=(a,e,t)=>{if(F(a))return a*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};function Yn(a,e,t,i){let s,r,n,o;const l=navigator.userAgent.toLowerCase(),u=i,c=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=((e[t+2]&192)>>>6)+1;const d=(e[t+2]&60)>>>2;if(d>c.length-1){a.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ADTS sampling index:${d}`});return}return n=(e[t+2]&1)<<2,n|=(e[t+3]&192)>>>6,y.log(`manifest codec:${i}, ADTS type:${s}, samplingIndex:${d}`),/firefox/i.test(l)?d>=6?(s=5,o=new Array(4),r=d-3):(s=2,o=new Array(2),r=d):l.indexOf("android")!==-1?(s=2,o=new Array(2),r=d):(s=5,o=new Array(4),i&&(i.indexOf("mp4a.40.29")!==-1||i.indexOf("mp4a.40.5")!==-1)||!i&&d>=6?r=d-3:((i&&i.indexOf("mp4a.40.2")!==-1&&(d>=6&&n===1||/vivaldi/i.test(l))||!i&&n===1)&&(s=2,o=new Array(2)),r=d)),o[0]=s<<3,o[0]|=(d&14)>>1,o[1]|=(d&1)<<7,o[1]|=n<<3,s===5&&(o[1]|=(r&14)>>1,o[2]=(r&1)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:c[d],channelCount:n,codec:"mp4a.40."+s,manifestCodec:u}}function ws(a,e){return a[e]===255&&(a[e+1]&246)===240}function Ps(a,e){return a[e+1]&1?7:9}function si(a,e){return(a[e+3]&3)<<11|a[e+4]<<3|(a[e+5]&224)>>>5}function jn(a,e){return e+5<a.length}function ut(a,e){return e+1<a.length&&ws(a,e)}function Xn(a,e){return jn(a,e)&&ws(a,e)&&si(a,e)<=a.length-e}function zn(a,e){if(ut(a,e)){const t=Ps(a,e);if(e+t>=a.length)return!1;const i=si(a,e);if(i<=t)return!1;const s=e+i;return s===a.length||ut(a,s)}return!1}function Fs(a,e,t,i,s){if(!a.samplerate){const r=Yn(e,t,i,s);if(!r)return;a.config=r.config,a.samplerate=r.samplerate,a.channelCount=r.channelCount,a.codec=r.codec,a.manifestCodec=r.manifestCodec,y.log(`parsed codec:${a.codec}, rate:${r.samplerate}, channels:${r.channelCount}`)}}function Os(a){return 1024*9e4/a}function Qn(a,e){const t=Ps(a,e);if(e+t<=a.length){const i=si(a,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function Ms(a,e,t,i,s){const r=Os(a.samplerate),n=i+s*r,o=Qn(e,t);let l;if(o){const{frameLength:d,headerLength:h}=o,f=h+d,m=Math.max(0,t+f-e.length);m?(l=new Uint8Array(f-h),l.set(e.subarray(t+h,e.length),0)):l=e.subarray(t+h,t+f);const p={unit:l,pts:n};return m||a.samples.push(p),{sample:p,length:f,missing:m}}const u=e.length-t;return l=new Uint8Array(u),l.set(e.subarray(t,e.length),0),{sample:{unit:l,pts:n},length:u,missing:-1}}class Jn extends _s{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;let i=(rt(e,0)||[]).length;for(let s=e.length;i<s;i++)if(zn(e,i))return y.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return Xn(e,t)}appendFrame(e,t,i){Fs(e,this.observer,t,i,e.manifestCodec);const s=Ms(e,t,i,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s}}const Zn=/\/emsg[-/]ID3/i;class ea{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,s){const r=this.videoTrack=Ee("video",1),n=this.audioTrack=Ee("audio",1),o=this.txtTrack=Ee("text",1);if(this.id3Track=Ee("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const l=Ts(e);if(l.video){const{id:u,timescale:c,codec:d}=l.video;r.id=u,r.timescale=o.timescale=c,r.codec=d}if(l.audio){const{id:u,timescale:c,codec:d}=l.audio;n.id=u,n.timescale=c,n.codec=d}o.id=ms.text,r.sampleDuration=0,r.duration=n.duration=s}resetContiguity(){this.remainderData=null}static probe(e){return e=e.length>16384?e.subarray(0,16384):e,$(e,["moof"]).length>0}demux(e,t){this.timeOffset=t;let i=e;const s=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=Pe(this.remainderData,e));const o=Gr(i);this.remainderData=o.remainder,s.samples=o.valid||new Uint8Array}else s.samples=i;const n=this.extractID3Track(s,t);return r.samples=gi(t,s),{videoTrack:s,audioTrack:this.audioTrack,id3Track:n,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const s=this.extractID3Track(t,this.timeOffset);return i.samples=gi(e,t),{videoTrack:t,audioTrack:Ee(),id3Track:s,textTrack:Ee()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const s=$(e.samples,["emsg"]);s&&s.forEach(r=>{const n=Vr(r);if(Zn.test(n.schemeIdUri)){const o=F(n.presentationTime)?n.presentationTime/n.timeScale:t+n.presentationTimeDelta/n.timeScale;let l=n.eventDuration===4294967295?Number.POSITIVE_INFINITY:n.eventDuration/n.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const u=n.payload;i.samples.push({data:u,len:u.byteLength,dts:o,pts:o,type:Te.emsg,duration:l})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}let ze=null;const ta=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],ia=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],sa=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],ra=[0,1,1,4];function Ns(a,e,t,i,s){if(t+24>e.length)return;const r=Us(e,t);if(r&&t+r.frameLength<=e.length){const n=r.samplesPerFrame*9e4/r.sampleRate,o=i+s*n,l={unit:e.subarray(t,t+r.frameLength),pts:o,dts:o};return a.config=[],a.channelCount=r.channelCount,a.samplerate=r.sampleRate,a.samples.push(l),{sample:l,length:r.frameLength,missing:0}}}function Us(a,e){const t=a[e+1]>>3&3,i=a[e+1]>>1&3,s=a[e+2]>>4&15,r=a[e+2]>>2&3;if(t!==1&&s!==0&&s!==15&&r!==3){const n=a[e+2]>>1&1,o=a[e+3]>>6,l=t===3?3-i:i===3?3:4,u=ta[l*14+s-1]*1e3,d=ia[(t===3?0:t===2?1:2)*3+r],h=o===3?1:2,f=sa[t][i],m=ra[i],p=f*8*m,T=Math.floor(f*u/d+n)*m;if(ze===null){const E=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);ze=E?parseInt(E[1]):0}return!!ze&&ze<=87&&i===2&&u>=224e3&&o===0&&(a[e+3]=a[e+3]|128),{sampleRate:d,channelCount:h,frameLength:T,samplesPerFrame:p}}}function ri(a,e){return a[e]===255&&(a[e+1]&224)===224&&(a[e+1]&6)!==0}function Bs(a,e){return e+1<a.length&&ri(a,e)}function na(a,e){return ri(a,e)&&4<=a.length-e}function aa(a,e){if(e+1<a.length&&ri(a,e)){const i=Us(a,e);let s=4;i!=null&&i.frameLength&&(s=i.frameLength);const r=e+s;return r===a.length||Bs(a,r)}return!1}class Ui{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,s=new Uint8Array(4),r=Math.min(4,t);if(r===0)throw new Error("no bytes available");s.set(e.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&y.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t=8,i=8,s;for(let r=0;r<e;r++)i!==0&&(s=this.readEG(),i=(t+s+256)%256),t=i===0?t:i}readSPS(){let e=0,t=0,i=0,s=0,r,n,o;const l=this.readUByte.bind(this),u=this.readBits.bind(this),c=this.readUEG.bind(this),d=this.readBoolean.bind(this),h=this.skipBits.bind(this),f=this.skipEG.bind(this),m=this.skipUEG.bind(this),p=this.skipScalingList.bind(this);l();const T=l();if(u(5),h(3),l(),m(),T===100||T===110||T===122||T===244||T===44||T===83||T===86||T===118||T===128){const k=c();if(k===3&&h(1),m(),m(),h(1),d())for(n=k!==3?8:12,o=0;o<n;o++)d()&&(o<6?p(16):p(64))}m();const x=c();if(x===0)c();else if(x===1)for(h(1),f(),f(),r=c(),o=0;o<r;o++)f();m(),h(1);const v=c(),E=c(),R=u(1);R===0&&h(1),h(1),d()&&(e=c(),t=c(),i=c(),s=c());let A=[1,1];if(d()&&d())switch(l()){case 1:A=[1,1];break;case 2:A=[12,11];break;case 3:A=[10,11];break;case 4:A=[16,11];break;case 5:A=[40,33];break;case 6:A=[24,11];break;case 7:A=[20,11];break;case 8:A=[32,11];break;case 9:A=[80,33];break;case 10:A=[18,11];break;case 11:A=[15,11];break;case 12:A=[64,33];break;case 13:A=[160,99];break;case 14:A=[4,3];break;case 15:A=[3,2];break;case 16:A=[2,1];break;case 255:{A=[l()<<8|l(),l()<<8|l()];break}}return{width:Math.ceil((v+1)*16-e*2-t*2),height:(2-R)*(E+1)*16-(R?2:4)*(i+s),pixelRatio:A}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class oa{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new ti(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(e,t,i){const s=e[t].unit;if(s.length<=16)return;const r=s.subarray(16,s.length-s.length%16),n=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(n).then(o=>{const l=new Uint8Array(o);s.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)i.set(e.subarray(r,r+16),s);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)e.set(i.subarray(s,s+16),r);return e}decryptAvcSample(e,t,i,s,r){const n=Es(r.data),o=this.getAvcEncryptedData(n);this.decryptBuffer(o.buffer).then(l=>{r.data=this.getAvcDecryptedUnit(n,l),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,s)})}decryptAvcSamples(e,t,i,s){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){s();return}const r=e[t].units;for(;!(i>=r.length);i++){const n=r[i];if(!(n.data.length<=48||n.type!==1&&n.type!==5)&&(this.decryptAvcSample(e,t,i,s,n),!this.decrypter.isSync()))return}}}}const se=188;class Ie{constructor(e,t,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=e,this.config=t,this.typeSupported=i}static probe(e){const t=Ie.syncOffset(e);return t>0&&y.warn(`MPEG2-TS detected but first sync word found @ offset ${t}`),t!==-1}static syncOffset(e){const t=e.length;let i=Math.min(se*5,e.length-se)+1,s=0;for(;s<i;){let r=!1,n=-1,o=0;for(let l=s;l<t;l+=se)if(e[l]===71){if(o++,n===-1&&(n=l,n!==0&&(i=Math.min(n+se*99,e.length-se)+1)),r||(r=Ht(e,l)===0),r&&o>1&&(n===0&&o>2||l+se>i))return n}else{if(o)return-1;break}s++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:ms[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,s){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=Ie.createTrack("video"),this._audioTrack=Ie.createTrack("audio",s),this._id3Track=Ie.createTrack("id3"),this._txtTrack=Ie.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i,this._duration=s}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_avcTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.avcSample=null,this.remainderData=null}demux(e,t,i=!1,s=!1){i||(this.sampleAes=null);let r;const n=this._avcTrack,o=this._audioTrack,l=this._id3Track,u=this._txtTrack;let c=n.pid,d=n.pesData,h=o.pid,f=l.pid,m=o.pesData,p=l.pesData,T=null,x=this.pmtParsed,v=this._pmtId,E=e.length;if(this.remainderData&&(e=Pe(this.remainderData,e),E=e.length,this.remainderData=null),E<se&&!s)return this.remainderData=e,{audioTrack:o,videoTrack:n,id3Track:l,textTrack:u};const R=Math.max(0,Ie.syncOffset(e));E-=(E-R)%se,E<e.byteLength&&!s&&(this.remainderData=new Uint8Array(e.buffer,E,e.buffer.byteLength-E));let A=0;for(let D=R;D<E;D+=se)if(e[D]===71){const C=!!(e[D+1]&64),_=Ht(e,D),I=(e[D+3]&48)>>4;let O;if(I>1){if(O=D+5+e[D+4],O===D+se)continue}else O=D+4;switch(_){case c:C&&(d&&(r=Oe(d))&&this.parseAVCPES(n,u,r,!1),d={data:[],size:0}),d&&(d.data.push(e.subarray(O,D+se)),d.size+=D+se-O);break;case h:if(C){if(m&&(r=Oe(m)))switch(o.segmentCodec){case"aac":this.parseAACPES(o,r);break;case"mp3":this.parseMPEGPES(o,r);break}m={data:[],size:0}}m&&(m.data.push(e.subarray(O,D+se)),m.size+=D+se-O);break;case f:C&&(p&&(r=Oe(p))&&this.parseID3PES(l,r),p={data:[],size:0}),p&&(p.data.push(e.subarray(O,D+se)),p.size+=D+se-O);break;case 0:C&&(O+=e[O]+1),v=this._pmtId=la(e,O);break;case v:{C&&(O+=e[O]+1);const w=ua(e,O,this.typeSupported,i);c=w.avc,c>0&&(n.pid=c),h=w.audio,h>0&&(o.pid=h,o.segmentCodec=w.segmentCodec),f=w.id3,f>0&&(l.pid=f),T!==null&&!x&&(y.warn(`MPEG-TS PMT found at ${D} after unknown PID '${T}'. Backtracking to sync byte @${R} to parse all TS packets.`),T=null,D=R-188),x=this.pmtParsed=!0;break}case 17:case 8191:break;default:T=_;break}}else A++;if(A>0){const D=new Error(`Found ${A} TS packet/s that do not start with 0x47`);this.observer.emit(g.ERROR,g.ERROR,{type:N.MEDIA_ERROR,details:L.FRAG_PARSING_ERROR,fatal:!1,error:D,reason:D.message})}n.pesData=d,o.pesData=m,l.pesData=p;const k={audioTrack:o,videoTrack:n,id3Track:l,textTrack:u};return s&&this.extractRemainingSamples(k),k}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._avcTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:s,textTrack:r}=e,n=i.pesData,o=t.pesData,l=s.pesData;let u;if(n&&(u=Oe(n))?(this.parseAVCPES(i,r,u,!0),i.pesData=null):i.pesData=n,o&&(u=Oe(o))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,u);break;case"mp3":this.parseMPEGPES(t,u);break}t.pesData=null}else o!=null&&o.size&&y.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=o;l&&(u=Oe(l))?(this.parseID3PES(s,u),s.pesData=null):s.pesData=l}demuxSampleAes(e,t,i){const s=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new oa(this.observer,this.config,t);return this.decrypt(s,r)}decrypt(e,t){return new Promise(i=>{const{audioTrack:s,videoTrack:r}=e;s.samples&&s.segmentCodec==="aac"?t.decryptAacSamples(s.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{i(e)}):i(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{i(e)})})}destroy(){this._duration=0}parseAVCPES(e,t,i,s){const r=this.parseAVCNALu(e,i.data);let n=this.avcSample,o,l=!1;i.data=null,n&&r.length&&!e.audFound&&(At(n,e),n=this.avcSample=Qe(!1,i.pts,i.dts,"")),r.forEach(u=>{switch(u.type){case 1:{o=!0,n||(n=this.avcSample=Qe(!0,i.pts,i.dts,"")),n.frame=!0;const c=u.data;if(l&&c.length>4){const d=new Ui(c).readSliceType();(d===2||d===4||d===7||d===9)&&(n.key=!0)}break}case 5:o=!0,n||(n=this.avcSample=Qe(!0,i.pts,i.dts,"")),n.key=!0,n.frame=!0;break;case 6:{o=!0,ys(u.data,1,i.pts,t.samples);break}case 7:if(o=!0,l=!0,!e.sps){const c=u.data,h=new Ui(c).readSPS();e.width=h.width,e.height=h.height,e.pixelRatio=h.pixelRatio,e.sps=[c],e.duration=this._duration;const f=c.subarray(1,4);let m="avc1.";for(let p=0;p<3;p++){let T=f[p].toString(16);T.length<2&&(T="0"+T),m+=T}e.codec=m}break;case 8:o=!0,e.pps||(e.pps=[u.data]);break;case 9:o=!1,e.audFound=!0,n&&At(n,e),n=this.avcSample=Qe(!1,i.pts,i.dts,"");break;case 12:o=!0;break;default:o=!1,n&&(n.debug+="unknown NAL "+u.type+" ");break}n&&o&&n.units.push(u)}),s&&n&&(At(n,e),this.avcSample=null)}getLastNalUnit(e){var t;let i=this.avcSample,s;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const r=i.units;s=r[r.length-1]}return s}parseAVCNALu(e,t){const i=t.byteLength;let s=e.naluState||0;const r=s,n=[];let o=0,l,u,c,d=-1,h=0;for(s===-1&&(d=0,h=t[0]&31,s=0,o=1);o<i;){if(l=t[o++],!s){s=l?0:1;continue}if(s===1){s=l?0:2;continue}if(!l)s=3;else if(l===1){if(d>=0){const f={data:t.subarray(d,o-s-1),type:h};n.push(f)}else{const f=this.getLastNalUnit(e.samples);if(f&&(r&&o<=4-r&&f.state&&(f.data=f.data.subarray(0,f.data.byteLength-r)),u=o-s-1,u>0)){const m=new Uint8Array(f.data.byteLength+u);m.set(f.data,0),m.set(t.subarray(0,u),f.data.byteLength),f.data=m,f.state=0}}o<i?(c=t[o]&31,d=o,h=c,s=0):s=-1}else s=0}if(d>=0&&s>=0){const f={data:t.subarray(d,i),type:h,state:s};n.push(f)}if(n.length===0){const f=this.getLastNalUnit(e.samples);if(f){const m=new Uint8Array(f.data.byteLength+t.byteLength);m.set(f.data,0),m.set(t,f.data.byteLength),f.data=m}}return e.naluState=s,n}parseAACPES(e,t){let i=0;const s=this.aacOverFlow;let r=t.data;if(s){this.aacOverFlow=null;const d=s.missing,h=s.sample.unit.byteLength;if(d===-1){const f=new Uint8Array(h+r.byteLength);f.set(s.sample.unit,0),f.set(r,h),r=f}else{const f=h-d;s.sample.unit.set(r.subarray(0,d),f),e.samples.push(s.sample),i=s.missing}}let n,o;for(n=i,o=r.length;n<o-1&&!ut(r,n);n++);if(n!==i){let d;const h=n<o-1;h?d=`AAC PES did not start with ADTS header,offset:${n}`:d="No ADTS header found in AAC PES";const f=new Error(d);if(y.warn(`parsing error: ${d}`),this.observer.emit(g.ERROR,g.ERROR,{type:N.MEDIA_ERROR,details:L.FRAG_PARSING_ERROR,fatal:!1,levelRetry:h,error:f,reason:d}),!h)return}Fs(e,this.observer,r,n,this.audioCodec);let l;if(t.pts!==void 0)l=t.pts;else if(s){const d=Os(e.samplerate);l=s.sample.pts+d}else{y.warn("[tsdemuxer]: AAC PES unknown PTS");return}let u=0,c;for(;n<o;)if(c=Ms(e,r,n,l,u),n+=c.length,c.missing){this.aacOverFlow=c;break}else for(u++;n<o-1&&!ut(r,n);n++);}parseMPEGPES(e,t){const i=t.data,s=i.length;let r=0,n=0;const o=t.pts;if(o===void 0){y.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;n<s;)if(Bs(i,n)){const l=Ns(e,i,n,o,r);if(l)n+=l.length,r++;else break}else n++}parseID3PES(e,t){if(t.pts===void 0){y.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=ee({},t,{type:this._avcTrack?Te.emsg:Te.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function Qe(a,e,t,i){return{key:a,frame:!1,pts:e,dts:t,units:[],debug:i,length:0}}function Ht(a,e){return((a[e+1]&31)<<8)+a[e+2]}function la(a,e){return(a[e+10]&31)<<8|a[e+11]}function ua(a,e,t,i){const s={audio:-1,avc:-1,id3:-1,segmentCodec:"aac"},r=(a[e+1]&15)<<8|a[e+2],n=e+3+r-4,o=(a[e+10]&15)<<8|a[e+11];for(e+=12+o;e<n;){const l=Ht(a,e);switch(a[e]){case 207:if(!i){y.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:s.audio===-1&&(s.audio=l);break;case 21:s.id3===-1&&(s.id3=l);break;case 219:if(!i){y.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:s.avc===-1&&(s.avc=l);break;case 3:case 4:t.mpeg!==!0&&t.mp3!==!0?y.log("MPEG audio found, not supported in this browser"):s.audio===-1&&(s.audio=l,s.segmentCodec="mp3");break;case 36:y.warn("Unsupported HEVC stream type found");break}e+=((a[e+3]&15)<<8|a[e+4])+5}return s}function Oe(a){let e=0,t,i,s,r,n;const o=a.data;if(!a||a.size===0)return null;for(;o[0].length<19&&o.length>1;){const u=new Uint8Array(o[0].length+o[1].length);u.set(o[0]),u.set(o[1],o[0].length),o[0]=u,o.splice(1,1)}if(t=o[0],(t[0]<<16)+(t[1]<<8)+t[2]===1){if(i=(t[4]<<8)+t[5],i&&i>a.size-6)return null;const u=t[7];u&192&&(r=(t[9]&14)*536870912+(t[10]&255)*4194304+(t[11]&254)*16384+(t[12]&255)*128+(t[13]&254)/2,u&64?(n=(t[14]&14)*536870912+(t[15]&255)*4194304+(t[16]&254)*16384+(t[17]&255)*128+(t[18]&254)/2,r-n>60*9e4&&(y.warn(`${Math.round((r-n)/9e4)}s delta between PTS and DTS, align them`),r=n)):n=r),s=t[8];let c=s+9;if(a.size<=c)return null;a.size-=c;const d=new Uint8Array(a.size);for(let h=0,f=o.length;h<f;h++){t=o[h];let m=t.byteLength;if(c)if(c>m){c-=m;continue}else t=t.subarray(c),m-=c,c=0;d.set(t,e),e+=m}return i&&(i-=s+3),{data:d,pts:r,dts:n,len:i}}return null}function At(a,e){if(a.units.length&&a.frame){if(a.pts===void 0){const t=e.samples,i=t.length;if(i){const s=t[i-1];a.pts=s.pts,a.dts=s.dts}else{e.dropped++;return}}e.samples.push(a)}a.debug.length&&y.log(a.pts+"/"+a.dts+":"+a.debug)}class ca extends _s{resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;let i=(rt(e,0)||[]).length;for(let s=e.length;i<s;i++)if(aa(e,i))return y.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return na(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return Ns(e,t,i,this.basePTS,this.frameIndex)}}class Bi{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const Re=Math.pow(2,32)-1;class S{static init(){S.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in S.types)S.types.hasOwnProperty(e)&&(S.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);S.HDLR_TYPES={video:t,audio:i};const s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);S.STTS=S.STSC=S.STCO=r,S.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),S.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),S.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),S.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const n=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);S.FTYP=S.box(S.types.ftyp,n,l,n,o),S.DINF=S.box(S.types.dinf,S.box(S.types.dref,s))}static box(e,...t){let i=8,s=t.length;const r=s;for(;s--;)i+=t[s].byteLength;const n=new Uint8Array(i);for(n[0]=i>>24&255,n[1]=i>>16&255,n[2]=i>>8&255,n[3]=i&255,n.set(e,4),s=0,i=8;s<r;s++)n.set(t[s],i),i+=t[s].byteLength;return n}static hdlr(e){return S.box(S.types.hdlr,S.HDLR_TYPES[e])}static mdat(e){return S.box(S.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(Re+1)),s=Math.floor(t%(Re+1));return S.box(S.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,85,196,0,0]))}static mdia(e){return S.box(S.types.mdia,S.mdhd(e.timescale,e.duration),S.hdlr(e.type),S.minf(e))}static mfhd(e){return S.box(S.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?S.box(S.types.minf,S.box(S.types.smhd,S.SMHD),S.DINF,S.stbl(e)):S.box(S.types.minf,S.box(S.types.vmhd,S.VMHD),S.DINF,S.stbl(e))}static moof(e,t,i){return S.box(S.types.moof,S.mfhd(e),S.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=S.trak(e[t]);return S.box.apply(null,[S.types.moov,S.mvhd(e[0].timescale,e[0].duration)].concat(i).concat(S.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=S.trex(e[t]);return S.box.apply(null,[S.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(Re+1)),s=Math.floor(t%(Re+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return S.box(S.types.mvhd,r)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let s,r;for(s=0;s<t.length;s++)r=t[s].flags,i[s+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return S.box(S.types.sdtp,i)}static stbl(e){return S.box(S.types.stbl,S.stsd(e),S.box(S.types.stts,S.STTS),S.box(S.types.stsc,S.STSC),S.box(S.types.stsz,S.STSZ),S.box(S.types.stco,S.STCO))}static avc1(e){let t=[],i=[],s,r,n;for(s=0;s<e.sps.length;s++)r=e.sps[s],n=r.byteLength,t.push(n>>>8&255),t.push(n&255),t=t.concat(Array.prototype.slice.call(r));for(s=0;s<e.pps.length;s++)r=e.pps[s],n=r.byteLength,i.push(n>>>8&255),i.push(n&255),i=i.concat(Array.prototype.slice.call(r));const o=S.box(S.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),l=e.width,u=e.height,c=e.pixelRatio[0],d=e.pixelRatio[1];return S.box(S.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,u>>8&255,u&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,S.box(S.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),S.box(S.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,c&255,d>>24,d>>16&255,d>>8&255,d&255])))}static esds(e){const t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static mp4a(e){const t=e.samplerate;return S.box(S.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,t&255,0,0]),S.box(S.types.esds,S.esds(e)))}static mp3(e){const t=e.samplerate;return S.box(S.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,t&255,0,0]))}static stsd(e){return e.type==="audio"?e.segmentCodec==="mp3"&&e.codec==="mp3"?S.box(S.types.stsd,S.STSD,S.mp3(e)):S.box(S.types.stsd,S.STSD,S.mp4a(e)):S.box(S.types.stsd,S.STSD,S.avc1(e))}static tkhd(e){const t=e.id,i=e.duration*e.timescale,s=e.width,r=e.height,n=Math.floor(i/(Re+1)),o=Math.floor(i%(Re+1));return S.box(S.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255,o>>24,o>>16&255,o>>8&255,o&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,s&255,0,0,r>>8&255,r&255,0,0]))}static traf(e,t){const i=S.sdtp(e),s=e.id,r=Math.floor(t/(Re+1)),n=Math.floor(t%(Re+1));return S.box(S.types.traf,S.box(S.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255])),S.box(S.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,n>>24,n>>16&255,n>>8&255,n&255])),S.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,S.box(S.types.trak,S.tkhd(e),S.mdia(e))}static trex(e){const t=e.id;return S.box(S.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],s=i.length,r=12+16*s,n=new Uint8Array(r);let o,l,u,c,d,h;for(t+=8+r,n.set([e.type==="video"?1:0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,s&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),o=0;o<s;o++)l=i[o],u=l.duration,c=l.size,d=l.flags,h=l.cts,n.set([u>>>24&255,u>>>16&255,u>>>8&255,u&255,c>>>24&255,c>>>16&255,c>>>8&255,c&255,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,d.degradPrio&61440,d.degradPrio&15,h>>>24&255,h>>>16&255,h>>>8&255,h&255],12+16*o);return S.box(S.types.trun,n)}static initSegment(e){S.types||S.init();const t=S.moov(e),i=new Uint8Array(S.FTYP.byteLength+t.byteLength);return i.set(S.FTYP),i.set(t,S.FTYP.byteLength),i}}S.types=void 0;S.HDLR_TYPES=void 0;S.STTS=void 0;S.STSC=void 0;S.STCO=void 0;S.STSZ=void 0;S.VMHD=void 0;S.SMHD=void 0;S.STSD=void 0;S.FTYP=void 0;S.DINF=void 0;const $s=9e4;function ni(a,e,t=1,i=!1){const s=a*e*t;return i?Math.round(s):s}function da(a,e,t=1,i=!1){return ni(a,e,1/t,i)}function $e(a,e=!1){return ni(a,1e3,1/$s,e)}function ha(a,e=1){return ni(a,$s,1/e)}const fa=10*1e3,$i=1024,ma=1152;let Je=null,Lt=null;class Rt{constructor(e,t,i,s=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,Je===null){const n=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Je=n?parseInt(n[1]):0}if(Lt===null){const r=navigator.userAgent.match(/Safari\/(\d+)/i);Lt=r?parseInt(r[1]):0}}destroy(){}resetTimeStamp(e){y.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){y.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){y.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1}getVideoStartPts(e){let t=!1;const i=e.reduce((s,r)=>{const n=r.pts-s;return n<-4294967296?(t=!0,fe(s,r.pts)):n>0?s:r.pts},e[0].pts);return t&&y.debug("PTS rollover detected"),i}remux(e,t,i,s,r,n,o,l){let u,c,d,h,f,m,p=r,T=r;const x=e.pid>-1,v=t.pid>-1,E=t.samples.length,R=e.samples.length>0,A=o&&E>0||E>1;if((!x||R)&&(!v||A)||this.ISGenerated||o){this.ISGenerated||(d=this.generateIS(e,t,r,n));const D=this.isVideoContiguous;let C=-1,_;if(A&&(C=ga(t.samples),!D&&this.config.forceKeyFrameOnDiscontinuity))if(m=!0,C>0){y.warn(`[mp4-remuxer]: Dropped ${C} out of ${E} video samples due to a missing keyframe`);const I=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(C),t.dropped+=C,T+=(t.samples[0].pts-I)/t.inputTimeScale,_=T}else C===-1&&(y.warn(`[mp4-remuxer]: No keyframe found out of ${E} video samples`),m=!1);if(this.ISGenerated){if(R&&A){const I=this.getVideoStartPts(t.samples),w=(fe(e.samples[0].pts,I)-I)/t.inputTimeScale;p+=Math.max(0,w),T+=Math.max(0,-w)}if(R){if(e.samplerate||(y.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(e,t,r,n)),c=this.remuxAudio(e,p,this.isAudioContiguous,n,v||A||l===U.AUDIO?T:void 0),A){const I=c?c.endPTS-c.startPTS:0;t.inputTimeScale||(y.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(e,t,r,n)),u=this.remuxVideo(t,T,D,I)}}else A&&(u=this.remuxVideo(t,T,D,0));u&&(u.firstKeyFrame=C,u.independent=C!==-1,u.firstKeyFramePTS=_)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(f=Gs(i,r,this._initPTS,this._initDTS)),s.samples.length&&(h=qs(s,r,this._initPTS))),{audio:c,video:u,initSegment:d,independent:m,text:h,id3:f}}generateIS(e,t,i,s){const r=e.samples,n=t.samples,o=this.typeSupported,l={},u=this._initPTS;let c=!u||s,d="audio/mp4",h,f,m;if(c&&(h=f=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":o.mpeg?(d="audio/mpeg",e.codec=""):o.mp3&&(e.codec="mp3");break}l.audio={id:"audio",container:d,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&o.mpeg?new Uint8Array(0):S.initSegment([e]),metadata:{channelCount:e.channelCount}},c&&(m=e.inputTimeScale,!u||m!==u.timescale?h=f=r[0].pts-Math.round(m*i):c=!1)}if(t.sps&&t.pps&&n.length&&(t.timescale=t.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:S.initSegment([t]),metadata:{width:t.width,height:t.height}},c))if(m=t.inputTimeScale,!u||m!==u.timescale){const p=this.getVideoStartPts(n),T=Math.round(m*i);f=Math.min(f,fe(n[0].dts,p)-T),h=Math.min(h,p-T)}else c=!1;if(Object.keys(l).length)return this.ISGenerated=!0,c?(this._initPTS={baseTime:h,timescale:m},this._initDTS={baseTime:f,timescale:m}):h=m=void 0,{tracks:l,initPTS:h,timescale:m}}remuxVideo(e,t,i,s){const r=e.inputTimeScale,n=e.samples,o=[],l=n.length,u=this._initPTS;let c=this.nextAvcDts,d=8,h=this.videoSampleDuration,f,m,p=Number.POSITIVE_INFINITY,T=Number.NEGATIVE_INFINITY,x=!1;if(!i||c===null){const P=t*r,M=n[0].pts-fe(n[0].dts,n[0].pts);c=P-M}const v=u.baseTime*r/u.timescale;for(let P=0;P<l;P++){const M=n[P];M.pts=fe(M.pts-v,c),M.dts=fe(M.dts-v,c),M.dts<n[P>0?P-1:P].dts&&(x=!0)}x&&n.sort(function(P,M){const H=P.dts-M.dts,W=P.pts-M.pts;return H||W}),f=n[0].dts,m=n[n.length-1].dts;const E=m-f,R=E?Math.round(E/(l-1)):h||e.inputTimeScale/30;if(i){const P=f-c,M=P>R,H=P<-1;if((M||H)&&(M?y.warn(`AVC: ${$e(P,!0)} ms (${P}dts) hole between fragments detected, filling it`):y.warn(`AVC: ${$e(-P,!0)} ms (${P}dts) overlapping between fragments detected`),!H||c>=n[0].pts)){f=c;const W=n[0].pts-P;n[0].dts=f,n[0].pts=W,y.log(`Video: First PTS/DTS adjusted: ${$e(W,!0)}/${$e(f,!0)}, delta: ${$e(P,!0)} ms`)}}f=Math.max(0,f);let A=0,k=0;for(let P=0;P<l;P++){const M=n[P],H=M.units,W=H.length;let q=0;for(let Z=0;Z<W;Z++)q+=H[Z].data.length;k+=q,A+=W,M.length=q,M.dts=Math.max(M.dts,f),p=Math.min(M.pts,p),T=Math.max(M.pts,T)}m=n[l-1].dts;const D=k+4*A+8;let C;try{C=new Uint8Array(D)}catch(P){this.observer.emit(g.ERROR,g.ERROR,{type:N.MUX_ERROR,details:L.REMUX_ALLOC_ERROR,fatal:!1,error:P,bytes:D,reason:`fail allocating video mdat ${D}`});return}const _=new DataView(C.buffer);_.setUint32(0,D),C.set(S.types.mdat,4);let I=!1,O=Number.POSITIVE_INFINITY,w=Number.POSITIVE_INFINITY,V=Number.NEGATIVE_INFINITY,re=Number.NEGATIVE_INFINITY;for(let P=0;P<l;P++){const M=n[P],H=M.units;let W=0;for(let ce=0,me=H.length;ce<me;ce++){const de=H[ce],Ce=de.data,ft=de.data.byteLength;_.setUint32(d,ft),d+=4,C.set(Ce,d),d+=ft,W+=4+ft}let q;if(P<l-1)h=n[P+1].dts-M.dts,q=n[P+1].pts-M.pts;else{const ce=this.config,me=P>0?M.dts-n[P-1].dts:R;if(q=P>0?M.pts-n[P-1].pts:R,ce.stretchShortVideoTrack&&this.nextAudioPts!==null){const de=Math.floor(ce.maxBufferHole*r),Ce=(s?p+s*r:this.nextAudioPts)-M.pts;Ce>de?(h=Ce-me,h<0?h=me:I=!0,y.log(`[mp4-remuxer]: It is approximately ${Ce/90} ms to the next segment; using duration ${h/90} ms for the last video frame.`)):h=me}else h=me}const Z=Math.round(M.pts-M.dts);O=Math.min(O,h),V=Math.max(V,h),w=Math.min(w,q),re=Math.max(re,q),o.push(new Gi(M.key,h,W,Z))}if(o.length){if(Je){if(Je<70){const P=o[0].flags;P.dependsOn=2,P.isNonSync=0}}else if(Lt&&re-w<V-O&&R/V<.025&&o[0].cts===0){y.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let P=f;for(let M=0,H=o.length;M<H;M++){const W=P+o[M].duration,q=P+o[M].cts;if(M<H-1){const Z=W+o[M+1].cts;o[M].duration=Z-q}else o[M].duration=M?o[M-1].duration:R;o[M].cts=0,P=W}}}h=I||!h?R:h,this.nextAvcDts=c=m+h,this.videoSampleDuration=h,this.isVideoContiguous=!0;const j=S.moof(e.sequenceNumber++,f,ee({},e,{samples:o})),z="video",X={data1:j,data2:C,startPTS:p/r,endPTS:(T+h)/r,startDTS:f/r,endDTS:c/r,type:z,hasAudio:!1,hasVideo:!0,nb:o.length,dropped:e.dropped};return e.samples=[],e.dropped=0,X}remuxAudio(e,t,i,s,r){const n=e.inputTimeScale,o=e.samplerate?e.samplerate:n,l=n/o,u=e.segmentCodec==="aac"?$i:ma,c=u*l,d=this._initPTS,h=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,f=[],m=r!==void 0;let p=e.samples,T=h?0:8,x=this.nextAudioPts||-1;const v=t*n,E=d.baseTime*n/d.timescale;if(this.isAudioContiguous=i=i||p.length&&x>0&&(s&&Math.abs(v-x)<9e3||Math.abs(fe(p[0].pts-E,v)-x)<20*c),p.forEach(function(z){z.pts=fe(z.pts-E,v)}),!i||x<0){if(p=p.filter(z=>z.pts>=0),!p.length)return;r===0?x=0:s&&!m?x=Math.max(0,v):x=p[0].pts}if(e.segmentCodec==="aac"){const z=this.config.maxAudioFramesDrift;for(let X=0,P=x;X<p.length;X++){const M=p[X],H=M.pts,W=H-P,q=Math.abs(1e3*W/n);if(W<=-z*c&&m)X===0&&(y.warn(`Audio frame @ ${(H/n).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*W/n)} ms.`),this.nextAudioPts=x=P=H);else if(W>=z*c&&q<fa&&m){let Z=Math.round(W/c);P=H-Z*c,P<0&&(Z--,P+=c),X===0&&(this.nextAudioPts=x=P),y.warn(`[mp4-remuxer]: Injecting ${Z} audio frame @ ${(P/n).toFixed(3)}s due to ${Math.round(1e3*W/n)} ms gap.`);for(let ce=0;ce<Z;ce++){const me=Math.max(P,0);let de=Bi.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);de||(y.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),de=M.unit.subarray()),p.splice(X,0,{unit:de,pts:me}),P+=c,X++}}M.pts=P,P+=c}}let R=null,A=null,k,D=0,C=p.length;for(;C--;)D+=p[C].unit.byteLength;for(let z=0,X=p.length;z<X;z++){const P=p[z],M=P.unit;let H=P.pts;if(A!==null){const q=f[z-1];q.duration=Math.round((H-A)/l)}else if(i&&e.segmentCodec==="aac"&&(H=x),R=H,D>0){D+=T;try{k=new Uint8Array(D)}catch(q){this.observer.emit(g.ERROR,g.ERROR,{type:N.MUX_ERROR,details:L.REMUX_ALLOC_ERROR,fatal:!1,error:q,bytes:D,reason:`fail allocating audio mdat ${D}`});return}h||(new DataView(k.buffer).setUint32(0,D),k.set(S.types.mdat,4))}else return;k.set(M,T);const W=M.byteLength;T+=W,f.push(new Gi(!0,u,W,0)),A=H}const _=f.length;if(!_)return;const I=f[f.length-1];this.nextAudioPts=x=A+l*I.duration;const O=h?new Uint8Array(0):S.moof(e.sequenceNumber++,R/l,ee({},e,{samples:f}));e.samples=[];const w=R/n,V=x/n,j={data1:O,data2:k,startPTS:w,endPTS:V,startDTS:w,endDTS:V,type:"audio",hasAudio:!0,hasVideo:!1,nb:_};return this.isAudioContiguous=!0,j}remuxEmptyAudio(e,t,i,s){const r=e.inputTimeScale,n=e.samplerate?e.samplerate:r,o=r/n,l=this.nextAudioPts,u=this._initDTS,c=u.baseTime*9e4/u.timescale,d=(l!==null?l:s.startDTS*r)+c,h=s.endDTS*r+c,f=o*$i,m=Math.ceil((h-d)/f),p=Bi.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(y.warn("[mp4-remuxer]: remux empty Audio"),!p){y.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}const T=[];for(let x=0;x<m;x++){const v=d+x*f;T.push({unit:p,pts:v,dts:v})}return e.samples=T,this.remuxAudio(e,t,i,!1)}}function fe(a,e){let t;if(e===null)return a;for(e<a?t=-8589934592:t=8589934592;Math.abs(a-e)>4294967296;)a+=t;return a}function ga(a){for(let e=0;e<a.length;e++)if(a[e].key)return e;return-1}function Gs(a,e,t,i){const s=a.samples.length;if(!s)return;const r=a.inputTimeScale;for(let o=0;o<s;o++){const l=a.samples[o];l.pts=fe(l.pts-t.baseTime*r/t.timescale,e*r)/r,l.dts=fe(l.dts-i.baseTime*r/i.timescale,e*r)/r}const n=a.samples;return a.samples=[],{samples:n}}function qs(a,e,t){const i=a.samples.length;if(!i)return;const s=a.inputTimeScale;for(let n=0;n<i;n++){const o=a.samples[n];o.pts=fe(o.pts-t.baseTime*9e4/t.timescale,e*s)/s}a.samples.sort((n,o)=>n.pts-o.pts);const r=a.samples;return a.samples=[],{samples:r}}class Gi{constructor(e,t,i,s){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=i,this.cts=s,this.flags=new pa(e)}}class pa{constructor(e){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=e?2:1,this.isNonSync=e?0:1}}class Ta{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,i,s){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(Mr(e,s)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const s=this.initData=Ts(e);t||(t=qi(s.audio,K.AUDIO)),i||(i=qi(s.video,K.VIDEO));const r={};s.audio&&s.video?r.audiovideo={container:"video/mp4",codec:t+","+i,initSegment:e,id:"main"}:s.audio?r.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:s.video?r.video={container:"video/mp4",codec:i,initSegment:e,id:"main"}:y.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(e,t,i,s,r,n){var o,l;let{initPTS:u,lastEndTime:c}=this;const d={audio:void 0,video:void 0,text:s,id3:i,initSegment:void 0};F(c)||(c=this.lastEndTime=r||0);const h=t.samples;if(!(h!=null&&h.length))return d;const f={initPTS:void 0,timescale:1};let m=this.initData;if((o=m)!=null&&o.length||(this.generateInitSegment(h),m=this.initData),!((l=m)!=null&&l.length))return y.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),d;this.emitInitSegment&&(f.tracks=this.initTracks,this.emitInitSegment=!1);const p=Ur(h,m),T=Nr(m,h),x=T===null?r:T;(xa(u,x,r,p)||f.timescale!==u.timescale&&n)&&(f.initPTS=x-r,u&&u.timescale===1&&y.warn(`Adjusting initPTS by ${f.initPTS-u.baseTime}`),this.initPTS=u={baseTime:f.initPTS,timescale:1});const v=e?x-u.baseTime/u.timescale:c,E=v+p;$r(m,h,u.baseTime/u.timescale),p>0?this.lastEndTime=E:(y.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const R=!!m.audio,A=!!m.video;let k="";R&&(k+="audio"),A&&(k+="video");const D={data1:h,startPTS:v,startDTS:v,endPTS:E,endDTS:E,type:k,hasAudio:R,hasVideo:A,nb:1,dropped:0};return d.audio=D.type==="audio"?D:void 0,d.video=D.type!=="audio"?D:void 0,d.initSegment=f,d.id3=Gs(i,r,u,u),s.samples.length&&(d.text=qs(s,r,u)),d}}function xa(a,e,t,i){if(a===null)return!0;const s=Math.max(i,1),r=e-a.baseTime/a.timescale;return Math.abs(r-t)>s}function qi(a,e){const t=a==null?void 0:a.codec;return t&&t.length>4?t:t==="hvc1"||t==="hev1"?"hvc1.1.6.L120.90":t==="av01"?"av01.0.04M.08":t==="avc1"||e===K.VIDEO?"avc1.42e01e":"mp4a.40.5"}let Le;try{Le=self.performance.now.bind(self.performance)}catch{y.debug("Unable to use Performance API on this environment"),Le=typeof self<"u"&&self.Date.now}const It=[{demux:ea,remux:Ta},{demux:Ie,remux:Rt},{demux:Jn,remux:Rt},{demux:ca,remux:Rt}];class Ki{constructor(e,t,i,s,r){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.vendor=s,this.id=r}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,s){const r=i.transmuxing;r.executeStart=Le();let n=new Uint8Array(e);const{currentTransmuxState:o,transmuxConfig:l}=this;s&&(this.currentTransmuxState=s);const{contiguous:u,discontinuity:c,trackSwitch:d,accurateTimeOffset:h,timeOffset:f,initSegmentChange:m}=s||o,{audioCodec:p,videoCodec:T,defaultInitPts:x,duration:v,initSegmentData:E}=l,R=ya(n,t);if(R&&R.method==="AES-128"){const C=this.getDecrypter();if(C.isSync()){let _=C.softwareDecrypt(n,R.key.buffer,R.iv.buffer);if(i.part>-1&&(_=C.flush()),!_)return r.executeEnd=Le(),bt(i);n=new Uint8Array(_)}else return this.decryptionPromise=C.webCryptoDecrypt(n,R.key.buffer,R.iv.buffer).then(_=>{const I=this.push(_,null,i);return this.decryptionPromise=null,I}),this.decryptionPromise}const A=this.needsProbing(c,d);if(A){const C=this.configureTransmuxer(n);if(C)return y.warn(`[transmuxer] ${C.message}`),this.observer.emit(g.ERROR,g.ERROR,{type:N.MEDIA_ERROR,details:L.FRAG_PARSING_ERROR,fatal:!1,error:C,reason:C.message}),r.executeEnd=Le(),bt(i)}(c||d||m||A)&&this.resetInitSegment(E,p,T,v,t),(c||m||A)&&this.resetInitialTimestamp(x),u||this.resetContiguity();const k=this.transmux(n,R,f,h,i),D=this.currentTransmuxState;return D.contiguous=!0,D.discontinuity=!1,D.trackSwitch=!1,r.executeEnd=Le(),k}flush(e){const t=e.transmuxing;t.executeStart=Le();const{decrypter:i,currentTransmuxState:s,decryptionPromise:r}=this;if(r)return r.then(()=>this.flush(e));const n=[],{timeOffset:o}=s;if(i){const d=i.flush();d&&n.push(this.push(d,null,e))}const{demuxer:l,remuxer:u}=this;if(!l||!u)return t.executeEnd=Le(),[bt(e)];const c=l.flush(o);return st(c)?c.then(d=>(this.flushRemux(n,d,e),n)):(this.flushRemux(n,c,e),n)}flushRemux(e,t,i){const{audioTrack:s,videoTrack:r,id3Track:n,textTrack:o}=t,{accurateTimeOffset:l,timeOffset:u}=this.currentTransmuxState;y.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const c=this.remuxer.remux(s,r,n,o,u,l,!0,this.id);e.push({remuxResult:c,chunkMeta:i}),i.transmuxing.executeEnd=Le()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,s,r){const{demuxer:n,remuxer:o}=this;!n||!o||(n.resetInitSegment(e,t,i,s),o.resetInitSegment(e,t,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,s,r){let n;return t&&t.method==="SAMPLE-AES"?n=this.transmuxSampleAes(e,t,i,s,r):n=this.transmuxUnencrypted(e,i,s,r),n}transmuxUnencrypted(e,t,i,s){const{audioTrack:r,videoTrack:n,id3Track:o,textTrack:l}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,n,o,l,t,i,!1,this.id),chunkMeta:s}}transmuxSampleAes(e,t,i,s,r){return this.demuxer.demuxSampleAes(e,t,i).then(n=>({remuxResult:this.remuxer.remux(n.audioTrack,n.videoTrack,n.id3Track,n.textTrack,i,s,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:s,vendor:r}=this;let n;for(let d=0,h=It.length;d<h;d++)if(It[d].demux.probe(e)){n=It[d];break}if(!n)return new Error("Failed to find demuxer by probing fragment data");const o=this.demuxer,l=this.remuxer,u=n.remux,c=n.demux;(!l||!(l instanceof u))&&(this.remuxer=new u(i,t,s,r)),(!o||!(o instanceof c))&&(this.demuxer=new c(i,t,s),this.probe=c.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new ti(this.config)),e}}function ya(a,e){let t=null;return a.byteLength>0&&e!=null&&e.key!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const bt=a=>({remuxResult:{},chunkMeta:a});function st(a){return"then"in a&&a.then instanceof Function}class Ea{constructor(e,t,i,s,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=s,this.defaultInitPts=r||null}}class va{constructor(e,t,i,s,r,n){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=s,this.timeOffset=r,this.initSegmentChange=n}}var Ks={exports:{}};(function(a){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function s(l,u,c){this.fn=l,this.context=u,this.once=c||!1}function r(l,u,c,d,h){if(typeof c!="function")throw new TypeError("The listener must be a function");var f=new s(c,d||l,h),m=t?t+u:u;return l._events[m]?l._events[m].fn?l._events[m]=[l._events[m],f]:l._events[m].push(f):(l._events[m]=f,l._eventsCount++),l}function n(l,u){--l._eventsCount===0?l._events=new i:delete l._events[u]}function o(){this._events=new i,this._eventsCount=0}o.prototype.eventNames=function(){var u=[],c,d;if(this._eventsCount===0)return u;for(d in c=this._events)e.call(c,d)&&u.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(c)):u},o.prototype.listeners=function(u){var c=t?t+u:u,d=this._events[c];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,f=d.length,m=new Array(f);h<f;h++)m[h]=d[h].fn;return m},o.prototype.listenerCount=function(u){var c=t?t+u:u,d=this._events[c];return d?d.fn?1:d.length:0},o.prototype.emit=function(u,c,d,h,f,m){var p=t?t+u:u;if(!this._events[p])return!1;var T=this._events[p],x=arguments.length,v,E;if(T.fn){switch(T.once&&this.removeListener(u,T.fn,void 0,!0),x){case 1:return T.fn.call(T.context),!0;case 2:return T.fn.call(T.context,c),!0;case 3:return T.fn.call(T.context,c,d),!0;case 4:return T.fn.call(T.context,c,d,h),!0;case 5:return T.fn.call(T.context,c,d,h,f),!0;case 6:return T.fn.call(T.context,c,d,h,f,m),!0}for(E=1,v=new Array(x-1);E<x;E++)v[E-1]=arguments[E];T.fn.apply(T.context,v)}else{var R=T.length,A;for(E=0;E<R;E++)switch(T[E].once&&this.removeListener(u,T[E].fn,void 0,!0),x){case 1:T[E].fn.call(T[E].context);break;case 2:T[E].fn.call(T[E].context,c);break;case 3:T[E].fn.call(T[E].context,c,d);break;case 4:T[E].fn.call(T[E].context,c,d,h);break;default:if(!v)for(A=1,v=new Array(x-1);A<x;A++)v[A-1]=arguments[A];T[E].fn.apply(T[E].context,v)}}return!0},o.prototype.on=function(u,c,d){return r(this,u,c,d,!1)},o.prototype.once=function(u,c,d){return r(this,u,c,d,!0)},o.prototype.removeListener=function(u,c,d,h){var f=t?t+u:u;if(!this._events[f])return this;if(!c)return n(this,f),this;var m=this._events[f];if(m.fn)m.fn===c&&(!h||m.once)&&(!d||m.context===d)&&n(this,f);else{for(var p=0,T=[],x=m.length;p<x;p++)(m[p].fn!==c||h&&!m[p].once||d&&m[p].context!==d)&&T.push(m[p]);T.length?this._events[f]=T.length===1?T[0]:T:n(this,f)}return this},o.prototype.removeAllListeners=function(u){var c;return u?(c=t?t+u:u,this._events[c]&&n(this,c)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,a.exports=o})(Ks);var Sa=Ks.exports,ai=ar(Sa);const Dt=ht()||{isTypeSupported:()=>!1};class Vs{constructor(e,t,i,s){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=s;const n=(u,c)=>{c=c||{},c.frag=this.frag,c.id=this.id,u===g.ERROR&&(this.error=c.error),this.hls.trigger(u,c)};this.observer=new ai,this.observer.on(g.FRAG_DECRYPTED,n),this.observer.on(g.ERROR,n);const o={mp4:Dt.isTypeSupported("video/mp4"),mpeg:Dt.isTypeSupported("audio/mpeg"),mp3:Dt.isTypeSupported('audio/mp4; codecs="mp3"')},l=navigator.vendor;if(this.useWorker&&typeof Worker<"u"&&(r.workerPath||Kn())){try{r.workerPath?(y.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=Hn(r.workerPath)):(y.log(`injecting Web Worker for "${t}"`),this.workerContext=Vn()),this.onwmsg=d=>this.onWorkerMessage(d);const{worker:c}=this.workerContext;c.addEventListener("message",this.onwmsg),c.onerror=d=>{const h=new Error(`${d.message}  (${d.filename}:${d.lineno})`);r.enableWorker=!1,y.warn(`Error in "${t}" Web Worker, fallback to inline`),this.hls.trigger(g.ERROR,{type:N.OTHER_ERROR,details:L.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:h})},c.postMessage({cmd:"init",typeSupported:o,vendor:l,id:t,config:JSON.stringify(r)})}catch(c){y.warn(`Error setting up "${t}" Web Worker, fallback to inline`,c),this.resetWorker(),this.error=null,this.transmuxer=new Ki(this.observer,o,r,l,t)}return}this.transmuxer=new Ki(this.observer,o,r,l,t)}resetWorker(){if(this.workerContext){const{worker:e,objectURL:t}=this.workerContext;t&&self.URL.revokeObjectURL(t),e.removeEventListener("message",this.onwmsg),e.onerror=null,e.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(e,t,i,s,r,n,o,l,u,c){var d,h;u.transmuxing.start=self.performance.now();const{transmuxer:f}=this,m=n?n.start:r.start,p=r.decryptdata,T=this.frag,x=!(T&&r.cc===T.cc),v=!(T&&u.level===T.level),E=T?u.sn-T.sn:-1,R=this.part?u.part-this.part.index:-1,A=E===0&&u.id>1&&u.id===(T==null?void 0:T.stats.chunkCount),k=!v&&(E===1||E===0&&(R===1||A&&R<=0)),D=self.performance.now();(v||E||r.stats.parsing.start===0)&&(r.stats.parsing.start=D),n&&(R||!k)&&(n.stats.parsing.start=D);const C=!(T&&((d=r.initSegment)==null?void 0:d.url)===((h=T.initSegment)==null?void 0:h.url)),_=new va(x,k,l,v,m,C);if(!k||x||C){y.log(`[transmuxer-interface, ${r.type}]: Starting new transmux session for sn: ${u.sn} p: ${u.part} level: ${u.level} id: ${u.id}
        discontinuity: ${x}
        trackSwitch: ${v}
        contiguous: ${k}
        accurateTimeOffset: ${l}
        timeOffset: ${m}
        initSegmentChange: ${C}`);const I=new Ea(i,s,t,o,c);this.configureTransmuxer(I)}if(this.frag=r,this.part=n,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:e,decryptdata:p,chunkMeta:u,state:_},e instanceof ArrayBuffer?[e]:[]);else if(f){const I=f.push(e,p,u,_);st(I)?(f.async=!0,I.then(O=>{this.handleTransmuxComplete(O)}).catch(O=>{this.transmuxerError(O,u,"transmuxer-interface push error")})):(f.async=!1,this.handleTransmuxComplete(I))}}flush(e){e.transmuxing.start=self.performance.now();const{transmuxer:t}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(t){let i=t.flush(e);st(i)||t.async?(st(i)||(i=Promise.resolve(i)),i.then(r=>{this.handleFlushResult(r,e)}).catch(r=>{this.transmuxerError(r,e,"transmuxer-interface flush error")})):this.handleFlushResult(i,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.FRAG_PARSING_ERROR,chunkMeta:t,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}onWorkerMessage(e){const t=e.data,i=this.hls;switch(t.event){case"init":{var s;const r=(s=this.workerContext)==null?void 0:s.objectURL;r&&self.URL.revokeObjectURL(r);break}case"transmuxComplete":{this.handleTransmuxComplete(t.data);break}case"flush":{this.onFlush(t.data);break}case"workerLog":y[t.data.logType]&&y[t.data.logType](t.data.message);break;default:{t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,i.trigger(t.event,t.data);break}}}configureTransmuxer(e){const{transmuxer:t}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):t&&t.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const Aa=250,Ct=2,La=.1,Ra=.05;class Ia{constructor(e,t,i,s){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=i,this.hls=s}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(e,t){const{config:i,media:s,stalled:r}=this;if(s===null)return;const{currentTime:n,seeking:o}=s,l=this.seeking&&!o,u=!this.seeking&&o;if(this.seeking=o,n!==e){if(this.moved=!0,r!==null){if(this.stallReported){const x=self.performance.now()-r;y.warn(`playback not stuck anymore @${n}, after ${Math.round(x)}ms`),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if(u||l){this.stalled=null;return}if(s.paused&&!o||s.ended||s.playbackRate===0||!Y.getBuffered(s).length)return;const c=Y.bufferInfo(s,n,0),d=c.len>0,h=c.nextStart||0;if(!d&&!h)return;if(o){const x=c.len>Ct,v=!h||t&&t.start<=n||h-n>Ct&&!this.fragmentTracker.getPartialFragment(n);if(x||v)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var f;const x=Math.max(h,c.start||0)-n,v=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,R=(v==null||(f=v.details)==null?void 0:f.live)?v.details.targetduration*2:Ct,A=this.fragmentTracker.getPartialFragment(n);if(x>0&&(x<=R||A)){this._trySkipBufferHole(A);return}}const m=self.performance.now();if(r===null){this.stalled=m;return}const p=m-r;if(!o&&p>=Aa&&(this._reportStall(c),!this.media))return;const T=Y.bufferInfo(s,n,i.maxBufferHole);this._tryFixBufferStall(T,p)}_tryFixBufferStall(e,t){const{config:i,fragmentTracker:s,media:r}=this;if(r===null)return;const n=r.currentTime,o=s.getPartialFragment(n);o&&(this._trySkipBufferHole(o)||!this.media)||(e.len>i.maxBufferHole||e.nextStart&&e.nextStart-n<i.maxBufferHole)&&t>i.highBufferWatchdogPeriod*1e3&&(y.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){const{hls:t,media:i,stallReported:s}=this;if(!s&&i){this.stallReported=!0;const r=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${JSON.stringify(e)})`);y.warn(r.message),t.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len})}}_trySkipBufferHole(e){const{config:t,hls:i,media:s}=this;if(s===null)return 0;const r=s.currentTime,n=Y.bufferInfo(s,r,0),o=r<n.start?n.start:n.nextStart;if(o){const l=n.len<=t.maxBufferHole,u=n.len>0&&n.len<1&&s.readyState<3,c=o-r;if(c>0&&(l||u)){if(c>t.maxBufferHole){const{fragmentTracker:h}=this;let f=!1;if(r===0){const m=h.getAppendedFrag(0,U.MAIN);m&&o<m.end&&(f=!0)}if(!f){const m=e||h.getAppendedFrag(r,U.MAIN);if(m){let p=!1,T=m.end;for(;T<o;){const x=h.getPartialFragment(T);if(x)T+=x.duration;else{p=!0;break}}if(p)return 0}}}const d=Math.max(o+Ra,r+La);if(y.warn(`skipping hole, adjusting currentTime from ${r} to ${d}`),this.moved=!0,this.stalled=null,s.currentTime=d,e&&!e.gap){const h=new Error(`fragment loaded with buffer holes, seeking from ${r} to ${d}`);i.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:h,reason:h.message,frag:e})}return d}}return 0}_tryNudgeBuffer(){const{config:e,hls:t,media:i,nudgeRetry:s}=this;if(i===null)return;const r=i.currentTime;if(this.nudgeRetry++,s<e.nudgeMaxRetry){const n=r+(s+1)*e.nudgeOffset,o=new Error(`Nudging 'currentTime' from ${r} to ${n}`);y.warn(o.message),i.currentTime=n,t.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.BUFFER_NUDGE_ON_STALL,error:o,fatal:!1})}else{const n=new Error(`Playhead still not moving while enough data buffered @${r} after ${e.nudgeMaxRetry} nudges`);y.error(n.message),t.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.BUFFER_STALLED_ERROR,error:n,fatal:!0})}}}const ba=100;class Da extends ii{constructor(e,t,i){super(e,t,i,"[stream-controller]",U.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.MANIFEST_PARSED,this.onManifestParsed,this),e.on(g.LEVEL_LOADING,this.onLevelLoading,this),e.on(g.LEVEL_LOADED,this.onLevelLoaded,this),e.on(g.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(g.ERROR,this.onError,this),e.on(g.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(g.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(g.BUFFER_CREATED,this.onBufferCreated,this),e.on(g.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(g.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(g.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.MANIFEST_PARSED,this.onManifestParsed,this),e.off(g.LEVEL_LOADED,this.onLevelLoaded,this),e.off(g.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(g.ERROR,this.onError,this),e.off(g.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(g.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(g.BUFFER_CREATED,this.onBufferCreated,this),e.off(g.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(g.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(g.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),this.onMediaDetaching()}startLoad(e){if(this.levels){const{lastCurrentTime:t,hls:i}=this;if(this.stopLoad(),this.setInterval(ba),this.level=-1,!this.startFragRequested){let s=i.startLevel;s===-1&&(i.config.testBandwidth&&this.levels.length>1?(s=0,this.bitrateTest=!0):s=i.nextAutoLevel),this.level=i.nextLoadLevel=s,this.loadedmetadata=!1}t>0&&e===-1&&(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t),this.state=b.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=b.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case b.WAITING_LEVEL:{var e;const{levels:i,level:s}=this,r=i==null||(e=i[s])==null?void 0:e.details;if(r&&(!r.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(r))break;this.state=b.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=b.IDLE;break}break}case b.FRAG_LOADING_WAITING_RETRY:{var t;const i=self.performance.now(),s=this.retryDate;(!s||i>=s||(t=this.media)!=null&&t.seeking)&&(this.resetStartWhenNotLoaded(this.level),this.state=b.IDLE)}break}this.state===b.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:s}=this,{config:r,nextLoadLevel:n}=e;if(t===null||!s&&(this.startFragRequested||!r.startFragPrefetch)||this.altAudio&&this.audioOnly||!(i!=null&&i[n]))return;const o=i[n],l=this.getMainFwdBufferInfo();if(l===null)return;const u=this.getLevelDetails();if(u&&this._streamEnded(l,u)){const T={};this.altAudio&&(T.type="video"),this.hls.trigger(g.BUFFER_EOS,T),this.state=b.ENDED;return}e.loadLevel!==n&&e.manualLevel===-1&&this.log(`Adapting to level ${n} from level ${this.level}`),this.level=e.nextLoadLevel=n;const c=o.details;if(!c||this.state===b.WAITING_LEVEL||c.live&&this.levelLastLoaded!==n){this.level=n,this.state=b.WAITING_LEVEL;return}const d=l.len,h=this.getMaxBufferLength(o.maxBitrate);if(d>=h)return;this.backtrackFragment&&this.backtrackFragment.start>l.end&&(this.backtrackFragment=null);const f=this.backtrackFragment?this.backtrackFragment.start:l.end;let m=this.getNextFragment(f,c);if(this.couldBacktrack&&!this.fragPrevious&&m&&m.sn!=="initSegment"&&this.fragmentTracker.getState(m)!==ie.OK){var p;const x=((p=this.backtrackFragment)!=null?p:m).sn-c.startSN,v=c.fragments[x-1];v&&m.cc===v.cc&&(m=v,this.fragmentTracker.removeFragment(v))}else this.backtrackFragment&&l.len&&(this.backtrackFragment=null);if(m&&this.isLoopLoading(m,f)){if(!m.gap){const x=this.audioOnly&&!this.altAudio?K.AUDIO:K.VIDEO,v=(x===K.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;v&&this.afterBufferFlushed(v,x,U.MAIN)}m=this.getNextFragmentLoopLoading(m,c,l,U.MAIN,h)}m&&(m.initSegment&&!m.initSegment.data&&!this.bitrateTest&&(m=m.initSegment),this.loadFragment(m,o,f))}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);this.fragCurrent=e,s===ie.NOT_LOADED||s===ie.PARTIAL?e.sn==="initSegment"?this._loadInitSegment(e,t):this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):(this.startFragRequested=!0,super.loadFragment(e,t,i)):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,U.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let i;const s=this.getAppendedFrag(t.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);const r=this.getLevelDetails();if(r!=null&&r.live){const o=this.getMainFwdBufferInfo();if(!o||o.len<r.targetduration*2)return}if(!t.paused&&e){const o=this.hls.nextLoadLevel,l=e[o],u=this.fragLastKbps;u&&this.fragCurrent?i=this.fragCurrent.duration*l.maxBitrate/(1e3*u)+1:i=0}else i=0;const n=this.getBufferedFrag(t.currentTime+i);if(n){const o=this.followingBufferedFrag(n);if(o){this.abortCurrentFrag();const l=o.maxStartPTS?o.maxStartPTS:o.start,u=o.duration,c=Math.max(n.end,l+Math.min(Math.max(u-this.config.maxFragLookUpTolerance,u*.5),u*.75));this.flushMainBuffer(c,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case b.KEY_LOADING:case b.FRAG_LOADING:case b.FRAG_LOADING_WAITING_RETRY:case b.PARSING:case b.PARSED:this.state=b.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new Ia(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:e}=this;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:null;F(t)&&this.log(`Media seeked to ${t.toFixed(3)}`);const i=this.getMainFwdBufferInfo();if(i===null||i.len===0){this.warn(`Main forward buffer length on "seeked" event ${i?i.len:"empty"})`);return}this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(g.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=0,this.levels=this.fragPlaying=this.backtrackFragment=null,this.altAudio=this.audioOnly=!1}onManifestParsed(e,t){let i=!1,s=!1,r;t.levels.forEach(n=>{r=n.audioCodec,r&&(r.indexOf("mp4a.40.2")!==-1&&(i=!0),r.indexOf("mp4a.40.5")!==-1&&(s=!0))}),this.audioCodecSwitch=i&&s&&!qn(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==b.IDLE)return;const s=i[t.level];(!s.details||s.details.live&&this.levelLastLoaded!==t.level||this.waitForCdnTuneIn(s.details))&&(this.state=b.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:s}=this,r=t.level,n=t.details,o=n.totalduration;if(!s){this.warn(`Levels were reset while loading level ${r}`);return}this.log(`Level ${r} loaded [${n.startSN},${n.endSN}]${n.lastPartSn?`[part-${n.lastPartSn}-${n.lastPartIndex}]`:""}, cc [${n.startCC}, ${n.endCC}] duration:${o}`);const l=s[r],u=this.fragCurrent;u&&(this.state===b.FRAG_LOADING||this.state===b.FRAG_LOADING_WAITING_RETRY)&&(u.level!==t.level||u.urlId!==l.urlId)&&u.loader&&this.abortCurrentFrag();let c=0;if(n.live||(i=l.details)!=null&&i.live){if(n.fragments[0]||(n.deltaUpdateFailed=!0),n.deltaUpdateFailed)return;c=this.alignPlaylists(n,l.details)}if(l.details=n,this.levelLastLoaded=r,this.hls.trigger(g.LEVEL_UPDATED,{details:n,level:r}),this.state===b.WAITING_LEVEL){if(this.waitForCdnTuneIn(n))return;this.state=b.IDLE}this.startFragRequested?n.live&&this.synchronizeToLiveEdge(n):this.setStartPosition(n,c),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:s,payload:r}=e,{levels:n}=this;if(!n){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const o=n[i.level],l=o.details;if(!l){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const u=o.videoCodec,c=l.PTSKnown||!l.live,d=(t=i.initSegment)==null?void 0:t.data,h=this._getAudioCodec(o),f=this.transmuxer=this.transmuxer||new Vs(this.hls,U.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),m=s?s.index:-1,p=m!==-1,T=new Zt(i.level,i.sn,i.stats.chunkCount,r.byteLength,m,p),x=this.initPTS[i.cc];f.push(r,d,h,u,i,s,l.totalduration,c,T,x)}onAudioTrackSwitching(e,t){const i=this.altAudio;if(!!!t.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const n=this.fragCurrent;n&&(this.log("Switching to main audio track, cancel main fragment load"),n.abortRequests(),this.fragmentTracker.removeFragment(n)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const r=this.hls;i&&(r.trigger(g.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),r.trigger(g.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=t.id,s=!!this.hls.audioTracks[i].url;if(s){const r=this.videoBuffer;r&&this.mediaBuffer!==r&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=r)}this.altAudio=s,this.tick()}onBufferCreated(e,t){const i=t.tracks;let s,r,n=!1;for(const o in i){const l=i[o];if(l.id==="main"){if(r=o,s=l,o==="video"){const u=i[o];u&&(this.videoBuffer=u.buffer)}}else n=!0}n&&s?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i&&i.type!==U.MAIN)return;if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===b.PARSED&&(this.state=b.IDLE);return}const r=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*r.total/(r.buffering.end-r.loading.first)),i.sn!=="initSegment"&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}onError(e,t){var i;if(t.fatal){this.state=b.ERROR;return}switch(t.details){case L.FRAG_GAP:case L.FRAG_PARSING_ERROR:case L.FRAG_DECRYPT_ERROR:case L.FRAG_LOAD_ERROR:case L.FRAG_LOAD_TIMEOUT:case L.KEY_LOAD_ERROR:case L.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(U.MAIN,t);break;case L.LEVEL_LOAD_ERROR:case L.LEVEL_LOAD_TIMEOUT:case L.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===b.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===G.LEVEL&&(this.state=b.IDLE);break;case L.BUFFER_FULL_ERROR:if(!t.parent||t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case L.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}checkBuffer(){const{media:e,gapController:t}=this;if(!(!e||!t||!e.readyState)){if(this.loadedmetadata||!Y.getBuffered(e).length){const i=this.state!==b.IDLE?this.fragCurrent:null;t.poll(this.lastCurrentTime,i)}this.lastCurrentTime=e.currentTime}}onFragLoadEmergencyAborted(){this.state=b.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==K.AUDIO||this.audioOnly&&!this.altAudio){const i=(t===K.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(i,t,U.MAIN)}}onLevelsUpdated(e,t){this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}const s=Y.getBuffered(e),n=(s.length?s.start(0):0)-i;n>0&&(n<this.config.maxBufferHole||n<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${n} to match buffer start`),i+=n,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${t}`),e.currentTime=i}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{const{hls:s}=this;if(!i||this.fragContextChanged(e))return;t.fragmentError=0,this.state=b.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const r=e.stats;r.parsing.start=r.parsing.end=r.buffering.start=r.buffering.end=self.performance.now(),s.trigger(g.FRAG_LOADED,i),e.bitrateTest=!1})}_handleTransmuxComplete(e){var t;const i="main",{hls:s}=this,{remuxResult:r,chunkMeta:n}=e,o=this.getCurrentContext(n);if(!o){this.resetWhenMissingContext(n);return}const{frag:l,part:u,level:c}=o,{video:d,text:h,id3:f,initSegment:m}=r,{details:p}=c,T=this.altAudio?void 0:r.audio;if(this.fragContextChanged(l)){this.fragmentTracker.removeFragment(l);return}if(this.state=b.PARSING,m){if(m!=null&&m.tracks){const E=l.initSegment||l;this._bufferInitSegment(c,m.tracks,E,n),s.trigger(g.FRAG_PARSING_INIT_SEGMENT,{frag:E,id:i,tracks:m.tracks})}const x=m.initPTS,v=m.timescale;F(x)&&(this.initPTS[l.cc]={baseTime:x,timescale:v},s.trigger(g.INIT_PTS_FOUND,{frag:l,id:i,initPTS:x,timescale:v}))}if(d&&r.independent!==!1){if(p){const{startPTS:x,endPTS:v,startDTS:E,endDTS:R}=d;if(u)u.elementaryStreams[d.type]={startPTS:x,endPTS:v,startDTS:E,endDTS:R};else if(d.firstKeyFrame&&d.independent&&n.id===1&&(this.couldBacktrack=!0),d.dropped&&d.independent){const A=this.getMainFwdBufferInfo(),k=(A?A.end:this.getLoadPosition())+this.config.maxBufferHole,D=d.firstKeyFramePTS?d.firstKeyFramePTS:x;if(k<D-this.config.maxBufferHole){this.backtrack(l);return}l.setElementaryStreamInfo(d.type,l.start,v,l.start,R,!0)}l.setElementaryStreamInfo(d.type,x,v,E,R),this.backtrackFragment&&(this.backtrackFragment=l),this.bufferFragmentData(d,l,u,n)}}else if(r.independent===!1){this.backtrack(l);return}if(T){const{startPTS:x,endPTS:v,startDTS:E,endDTS:R}=T;u&&(u.elementaryStreams[K.AUDIO]={startPTS:x,endPTS:v,startDTS:E,endDTS:R}),l.setElementaryStreamInfo(K.AUDIO,x,v,E,R),this.bufferFragmentData(T,l,u,n)}if(p&&f!=null&&(t=f.samples)!=null&&t.length){const x={id:i,frag:l,details:p,samples:f.samples};s.trigger(g.FRAG_PARSING_METADATA,x)}if(p&&h){const x={id:i,frag:l,details:p,samples:h.samples};s.trigger(g.FRAG_PARSING_USERDATA,x)}}_bufferInitSegment(e,t,i,s){if(this.state!==b.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;const{audio:r,video:n,audiovideo:o}=t;if(r){let l=e.audioCodec;const u=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(l&&(l.indexOf("mp4a.40.5")!==-1?l="mp4a.40.2":l="mp4a.40.5"),r.metadata.channelCount!==1&&u.indexOf("firefox")===-1&&(l="mp4a.40.5")),u.indexOf("android")!==-1&&r.container!=="audio/mpeg"&&(l="mp4a.40.2",this.log(`Android: force audio codec to ${l}`)),e.audioCodec&&e.audioCodec!==l&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${l}"`),r.levelCodec=l,r.id="main",this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${l||""}/${e.audioCodec||""}/${r.codec}]`)}n&&(n.levelCodec=e.videoCodec,n.id="main",this.log(`Init video buffer, container:${n.container}, codecs[level/parsed]=[${e.videoCodec||""}/${n.codec}]`)),o&&this.log(`Init audiovideo buffer, container:${o.container}, codecs[level/parsed]=[${e.attrs.CODECS||""}/${o.codec}]`),this.hls.trigger(g.BUFFER_CODECS,t),Object.keys(t).forEach(l=>{const c=t[l].initSegment;c!=null&&c.byteLength&&this.hls.trigger(g.BUFFER_APPENDING,{type:l,data:c,frag:i,part:null,chunkMeta:s,parent:i.type})}),this.tick()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,U.MAIN)}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=b.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const i=e.currentTime;if(Y.isBuffered(e,i)?t=this.getAppendedFrag(i):Y.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const s=this.fragPlaying,r=t.level;(!s||t.sn!==s.sn||s.level!==r||t.urlId!==s.urlId)&&(this.fragPlaying=t,this.hls.trigger(g.FRAG_CHANGED,{frag:t}),(!s||s.level!==r)&&this.hls.trigger(g.LEVEL_SWITCHED,{level:r}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){const e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}get currentProgramDateTime(){const e=this.media;if(e){const t=e.currentTime,i=this.currentFrag;if(i&&F(t)&&F(i.programDateTime)){const s=i.programDateTime+(t-i.start)*1e3;return new Date(s)}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class Me{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class Ca{constructor(e,t,i,s=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Me(e),this.fast_=new Me(t),this.defaultTTFB_=s,this.ttfb_=new Me(e)}update(e,t){const{slow_:i,fast_:s,ttfb_:r}=this;i.halfLife!==e&&(this.slow_=new Me(e,i.getEstimate(),i.getTotalWeight())),s.halfLife!==t&&(this.fast_=new Me(t,s.getEstimate(),s.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new Me(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,s=e/1e3,r=i/s;this.fast_.sample(s,r),this.slow_.sample(s,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}class ka{constructor(e){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=-1,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=e;const t=e.config;this.bwEstimator=new Ca(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate),this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(g.FRAG_LOADING,this.onFragLoading,this),e.on(g.FRAG_LOADED,this.onFragLoaded,this),e.on(g.FRAG_BUFFERED,this.onFragBuffered,this),e.on(g.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(g.LEVEL_LOADED,this.onLevelLoaded,this)}unregisterListeners(){const{hls:e}=this;e.off(g.FRAG_LOADING,this.onFragLoading,this),e.off(g.FRAG_LOADED,this.onFragLoaded,this),e.off(g.FRAG_BUFFERED,this.onFragBuffered,this),e.off(g.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(g.LEVEL_LOADED,this.onLevelLoaded,this)}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null}onFragLoading(e,t){var i;const s=t.frag;this.ignoreFragment(s)||(this.fragCurrent=s,this.partCurrent=(i=t.part)!=null?i:null,this.clearTimer(),this.timer=self.setInterval(this.onCheck,100))}onLevelSwitching(e,t){this.clearTimer()}getTimeToLoadFrag(e,t,i,s){const r=e+i/t,n=s?this.lastLevelLoadSec:0;return r+n}onLevelLoaded(e,t){const i=this.hls.config,{total:s,bwEstimate:r}=t.stats;F(s)&&F(r)&&(this.lastLevelLoadSec=8*s/r),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}_abandonRulesCheck(){const{fragCurrent:e,partCurrent:t,hls:i}=this,{autoLevelEnabled:s,media:r}=i;if(!e||!r)return;const n=performance.now(),o=t?t.stats:e.stats,l=t?t.duration:e.duration,u=n-o.loading.start;if(o.aborted||o.loaded&&o.loaded===o.total||e.level===0){this.clearTimer(),this._nextAutoLevel=-1;return}if(!s||r.paused||!r.playbackRate||!r.readyState)return;const c=i.mainForwardBufferInfo;if(c===null)return;const d=this.bwEstimator.getEstimateTTFB(),h=Math.abs(r.playbackRate);if(u<=Math.max(d,1e3*(l/(h*2))))return;const f=c.len/h;if(f>=2*l/h)return;const m=o.loading.first?o.loading.first-o.loading.start:-1,p=o.loaded&&m>-1,T=this.bwEstimator.getEstimate(),{levels:x,minAutoLevel:v}=i,E=x[e.level],R=o.total||Math.max(o.loaded,Math.round(l*E.maxBitrate/8));let A=u-m;A<1&&p&&(A=Math.min(u,o.loaded*8/T));const k=p?o.loaded*1e3/A:0,D=k?(R-o.loaded)/k:R*8/T+d/1e3;if(D<=f)return;const C=k?k*8:T;let _=Number.POSITIVE_INFINITY,I;for(I=e.level-1;I>v;I--){const O=x[I].maxBitrate;if(_=this.getTimeToLoadFrag(d/1e3,C,l*O,!x[I].details),_<f)break}_>=D||_>l*10||(i.nextLoadLevel=I,p?this.bwEstimator.sample(u-Math.min(d,m),o.loaded):this.bwEstimator.sampleTTFB(u),this.clearTimer(),y.warn(`[abr] Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} is loading too slowly;
      Time to underbuffer: ${f.toFixed(3)} s
      Estimated load time for current fragment: ${D.toFixed(3)} s
      Estimated load time for down switch fragment: ${_.toFixed(3)} s
      TTFB estimate: ${m}
      Current BW estimate: ${F(T)?(T/1024).toFixed(3):"Unknown"} Kb/s
      New BW estimate: ${(this.bwEstimator.getEstimate()/1024).toFixed(3)} Kb/s
      Aborting and switching to level ${I}`),e.loader&&(this.fragCurrent=this.partCurrent=null,e.abortRequests()),i.trigger(g.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:t,stats:o}))}onFragLoaded(e,{frag:t,part:i}){const s=i?i.stats:t.stats;if(t.type===U.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),this.lastLoadedFragLevel=t.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){const r=i?i.duration:t.duration,n=this.hls.levels[t.level],o=(n.loaded?n.loaded.bytes:0)+s.loaded,l=(n.loaded?n.loaded.duration:0)+r;n.loaded={bytes:o,duration:l},n.realBitrate=Math.round(8*o/l)}if(t.bitrateTest){const r={stats:s,frag:t,part:i,id:t.type};this.onFragBuffered(g.FRAG_BUFFERED,r),t.bitrateTest=!1}}}onFragBuffered(e,t){const{frag:i,part:s}=t,r=s!=null&&s.stats.loaded?s.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;const n=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(n,r.loaded),r.bwEstimate=this.bwEstimator.getEstimate(),i.bitrateTest?this.bitrateTestDelay=n/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==U.MAIN||e.sn==="initSegment"}clearTimer(){self.clearInterval(this.timer)}get nextAutoLevel(){const e=this._nextAutoLevel,t=this.bwEstimator;if(e!==-1&&!t.canEstimate())return e;let i=this.getNextABRAutoLevel();if(e!==-1){const s=this.hls.levels;if(s.length>Math.max(e,i)&&s[e].loadError<=s[i].loadError)return e}return e!==-1&&(i=Math.min(e,i)),i}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this,{maxAutoLevel:s,config:r,minAutoLevel:n,media:o}=i,l=t?t.duration:e?e.duration:0,u=o&&o.playbackRate!==0?Math.abs(o.playbackRate):1,c=this.bwEstimator?this.bwEstimator.getEstimate():r.abrEwmaDefaultEstimate,d=i.mainForwardBufferInfo,h=(d?d.len:0)/u;let f=this.findBestLevel(c,n,s,h,r.abrBandWidthFactor,r.abrBandWidthUpFactor);if(f>=0)return f;y.trace(`[abr] ${h?"rebuffering expected":"buffer is empty"}, finding optimal quality level`);let m=l?Math.min(l,r.maxStarvationDelay):r.maxStarvationDelay,p=r.abrBandWidthFactor,T=r.abrBandWidthUpFactor;if(!h){const x=this.bitrateTestDelay;x&&(m=(l?Math.min(l,r.maxLoadingDelay):r.maxLoadingDelay)-x,y.trace(`[abr] bitrate test took ${Math.round(1e3*x)}ms, set first fragment max fetchDuration to ${Math.round(1e3*m)} ms`),p=T=1)}return f=this.findBestLevel(c,n,s,h+m,p,T),Math.max(f,0)}findBestLevel(e,t,i,s,r,n){var o;const{fragCurrent:l,partCurrent:u,lastLoadedFragLevel:c}=this,{levels:d}=this.hls,h=d[c],f=!!(h!=null&&(o=h.details)!=null&&o.live),m=h==null?void 0:h.codecSet,p=u?u.duration:l?l.duration:0,T=this.bwEstimator.getEstimateTTFB()/1e3;let x=t,v=-1;for(let E=i;E>=t;E--){const R=d[E];if(!R||m&&R.codecSet!==m){R&&(x=Math.min(E,x),v=Math.max(E,v));continue}v!==-1&&y.trace(`[abr] Skipped level(s) ${x}-${v} with CODECS:"${d[v].attrs.CODECS}"; not compatible with "${h.attrs.CODECS}"`);const A=R.details,k=(u?A==null?void 0:A.partTarget:A==null?void 0:A.averagetargetduration)||p;let D;E<=c?D=r*e:D=n*e;const C=d[E].maxBitrate,_=this.getTimeToLoadFrag(T,D,C*k,A===void 0);if(y.trace(`[abr] level:${E} adjustedbw-bitrate:${Math.round(D-C)} avgDuration:${k.toFixed(1)} maxFetchDuration:${s.toFixed(1)} fetchDuration:${_.toFixed(1)}`),D>C&&(_===0||!F(_)||f&&!this.bitrateTestDelay||_<s))return E}return-1}set nextAutoLevel(e){this._nextAutoLevel=e}}class Hs{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=_a(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function _a(a,e){const t=new Uint8Array(e);let i=0;for(let s=0;s<a.length;s++){const r=a[s];t.set(r,i),i+=r.length}return t}const Vi=100;class wa extends ii{constructor(e,t,i){super(e,t,i,"[audio-stream-controller]",U.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:e}=this;e.on(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.LEVEL_LOADED,this.onLevelLoaded,this),e.on(g.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(g.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(g.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(g.ERROR,this.onError,this),e.on(g.BUFFER_RESET,this.onBufferReset,this),e.on(g.BUFFER_CREATED,this.onBufferCreated,this),e.on(g.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(g.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(g.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.LEVEL_LOADED,this.onLevelLoaded,this),e.off(g.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(g.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(g.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(g.ERROR,this.onError,this),e.off(g.BUFFER_RESET,this.onBufferReset,this),e.off(g.BUFFER_CREATED,this.onBufferCreated,this),e.off(g.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(g.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(g.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){if(i==="main"){const n=t.cc;this.initPTS[t.cc]={baseTime:s,timescale:r},this.log(`InitPTS for cc: ${n} found from main: ${s}`),this.videoTrackCC=n,this.state===b.WAITING_INIT_PTS&&this.tick()}}startLoad(e){if(!this.levels){this.startPosition=e,this.state=b.STOPPED;return}const t=this.lastCurrentTime;this.stopLoad(),this.setInterval(Vi),t>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t,this.state=b.IDLE):(this.loadedmetadata=!1,this.state=b.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}doTick(){switch(this.state){case b.IDLE:this.doTickIdle();break;case b.WAITING_TRACK:{var e;const{levels:i,trackId:s}=this,r=i==null||(e=i[s])==null?void 0:e.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=b.WAITING_INIT_PTS}break}case b.FRAG_LOADING_WAITING_RETRY:{var t;const i=performance.now(),s=this.retryDate;(!s||i>=s||(t=this.media)!=null&&t.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.trackId),this.state=b.IDLE);break}case b.WAITING_INIT_PTS:{const i=this.waitingData;if(i){const{frag:s,part:r,cache:n,complete:o}=i;if(this.initPTS[s.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=b.FRAG_LOADING;const l=n.flush(),u={frag:s,part:r,payload:l,networkDetails:null};this._handleFragmentLoadProgress(u),o&&super._handleFragmentLoadComplete(u)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${s.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const l=this.getLoadPosition(),u=Y.bufferInfo(this.mediaBuffer,l,this.config.maxBufferHole);Vt(u.end,this.config.maxFragLookUpTolerance,s)<0&&(this.log(`Waiting fragment cc (${s.cc}) @ ${s.start} cancelled because another fragment at ${u.end} is needed`),this.clearWaitingFragment())}}else this.state=b.IDLE}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=b.IDLE)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){const{hls:e,levels:t,media:i,trackId:s}=this,r=e.config;if(!(t!=null&&t[s])||!i&&(this.startFragRequested||!r.startFragPrefetch))return;const n=t[s],o=n.details;if(!o||o.live&&this.levelLastLoaded!==s||this.waitForCdnTuneIn(o)){this.state=b.WAITING_TRACK;return}const l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,K.AUDIO,U.AUDIO));const u=this.getFwdBufferInfo(l,U.AUDIO);if(u===null)return;const{bufferedTrack:c,switchingTrack:d}=this;if(!d&&this._streamEnded(u,o)){e.trigger(g.BUFFER_EOS,{type:"audio"}),this.state=b.ENDED;return}const h=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,U.MAIN),f=u.len,m=this.getMaxBufferLength(h==null?void 0:h.len);if(f>=m&&!d)return;const T=o.fragments[0].start;let x=u.end;if(d&&i){const A=this.getLoadPosition();c&&d.attrs!==c.attrs&&(x=A),o.PTSKnown&&A<T&&(u.end>T||u.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=T+.05)}let v=this.getNextFragment(x,o),E=!1;if(v&&this.isLoopLoading(v,x)&&(E=!!v.gap,v=this.getNextFragmentLoopLoading(v,o,u,U.MAIN,m)),!v){this.bufferFlushed=!0;return}const R=h&&v.start>h.end+o.targetduration;if(R||!(h!=null&&h.len)&&u.len){const A=this.getAppendedFrag(v.start,U.MAIN);if(A===null||(E||(E=!!A.gap||!!R&&h.len===0),R&&!E||E&&u.nextStart&&u.nextStart<A.end))return}this.loadFragment(v,n,x)}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.min(Math.max(t,e),this.config.maxMaxBufferLength):t}onMediaDetaching(){this.videoBuffer=null,super.onMediaDetaching()}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new Ve(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:s}=this;s&&(s.abortRequests(),this.removeUnbufferedFrags(s.start)),this.resetLoadingState(),i?this.setInterval(Vi):this.resetTransmuxer(),i?(this.switchingTrack=t,this.state=b.IDLE):(this.switchingTrack=null,this.bufferedTrack=t,this.state=b.STOPPED),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(e,t){this.mainDetails=t.details,this.cachedTrackLoadedData!==null&&(this.hls.trigger(g.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(e,t){var i;if(this.mainDetails==null){this.cachedTrackLoadedData=t;return}const{levels:s}=this,{details:r,id:n}=t;if(!s){this.warn(`Audio tracks were reset while loading level ${n}`);return}this.log(`Track ${n} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const o=s[n];let l=0;if(r.live||(i=o.details)!=null&&i.live){const u=this.mainDetails;if(r.fragments[0]||(r.deltaUpdateFailed=!0),r.deltaUpdateFailed||!u)return;!o.details&&r.hasProgramDateTime&&u.hasProgramDateTime?(Cs(r,u),l=r.fragments[0].start):l=this.alignPlaylists(r,o.details)}o.details=r,this.levelLastLoaded=n,!this.startFragRequested&&(this.mainDetails||!r.live)&&this.setStartPosition(o.details,l),this.state===b.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=b.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:s,payload:r}=e,{config:n,trackId:o,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const u=l[o];if(!u){this.warn("Audio track is undefined on fragment load progress");return}const c=u.details;if(!c){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const d=n.defaultAudioCodec||u.audioCodec||"mp4a.40.2";let h=this.transmuxer;h||(h=this.transmuxer=new Vs(this.hls,U.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const f=this.initPTS[i.cc],m=(t=i.initSegment)==null?void 0:t.data;if(f!==void 0){const T=s?s.index:-1,x=T!==-1,v=new Zt(i.level,i.sn,i.stats.chunkCount,r.byteLength,T,x);h.push(r,m,d,"",i,s,c.totalduration,!1,v,f)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${c.startSN} ,${c.endSN}],track ${o}`);const{cache:p}=this.waitingData=this.waitingData||{frag:i,part:s,cache:new Hs,complete:!1};p.push(new Uint8Array(r)),this.waitingVideoCC=this.videoTrackCC,this.state=b.WAITING_INIT_PTS}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(e,t){const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer||null)}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i.type!==U.AUDIO){if(!this.loadedmetadata&&i.type===U.MAIN){const r=this.videoBuffer||this.media;r&&Y.getBuffered(r).length&&(this.loadedmetadata=!0)}return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(i.sn!=="initSegment"){this.fragPrevious=i;const r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(g.AUDIO_TRACK_SWITCHED,ue({},r)))}this.fragBufferedComplete(i,s)}onError(e,t){var i;if(t.fatal){this.state=b.ERROR;return}switch(t.details){case L.FRAG_GAP:case L.FRAG_PARSING_ERROR:case L.FRAG_DECRYPT_ERROR:case L.FRAG_LOAD_ERROR:case L.FRAG_LOAD_TIMEOUT:case L.KEY_LOAD_ERROR:case L.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(U.AUDIO,t);break;case L.AUDIO_TRACK_LOAD_ERROR:case L.AUDIO_TRACK_LOAD_TIMEOUT:case L.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===b.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===G.AUDIO_TRACK&&(this.state=b.IDLE);break;case L.BUFFER_FULL_ERROR:if(!t.parent||t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case L.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushed(e,{type:t}){t===K.AUDIO&&(this.bufferFlushed=!0,this.state===b.ENDED&&(this.state=b.IDLE))}_handleTransmuxComplete(e){var t;const i="audio",{hls:s}=this,{remuxResult:r,chunkMeta:n}=e,o=this.getCurrentContext(n);if(!o){this.resetWhenMissingContext(n);return}const{frag:l,part:u,level:c}=o,{details:d}=c,{audio:h,text:f,id3:m,initSegment:p}=r;if(this.fragContextChanged(l)||!d){this.fragmentTracker.removeFragment(l);return}if(this.state=b.PARSING,this.switchingTrack&&h&&this.completeAudioSwitch(this.switchingTrack),p!=null&&p.tracks){const T=l.initSegment||l;this._bufferInitSegment(p.tracks,T,n),s.trigger(g.FRAG_PARSING_INIT_SEGMENT,{frag:T,id:i,tracks:p.tracks})}if(h){const{startPTS:T,endPTS:x,startDTS:v,endDTS:E}=h;u&&(u.elementaryStreams[K.AUDIO]={startPTS:T,endPTS:x,startDTS:v,endDTS:E}),l.setElementaryStreamInfo(K.AUDIO,T,x,v,E),this.bufferFragmentData(h,l,u,n)}if(m!=null&&(t=m.samples)!=null&&t.length){const T=ee({id:i,frag:l,details:d},m);s.trigger(g.FRAG_PARSING_METADATA,T)}if(f){const T=ee({id:i,frag:l,details:d},f);s.trigger(g.FRAG_PARSING_USERDATA,T)}}_bufferInitSegment(e,t,i){if(this.state!==b.PARSING)return;e.video&&delete e.video;const s=e.audio;if(!s)return;s.levelCodec=s.codec,s.id="audio",this.log(`Init audio buffer, container:${s.container}, codecs[parsed]=[${s.codec}]`),this.hls.trigger(g.BUFFER_CODECS,e);const r=s.initSegment;if(r!=null&&r.byteLength){const n={type:"audio",frag:t,part:null,chunkMeta:i,parent:t.type,data:r};this.hls.trigger(g.BUFFER_APPENDING,n)}this.tick()}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);if(this.fragCurrent=e,this.switchingTrack||s===ie.NOT_LOADED||s===ie.PARTIAL){var r;e.sn==="initSegment"?this._loadInitSegment(e,t):(r=t.details)!=null&&r.live&&!this.initPTS[e.cc]?(this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=b.WAITING_INIT_PTS):(this.startFragRequested=!0,super.loadFragment(e,t,i))}else this.clearTrackerIfNeeded(e)}completeAudioSwitch(e){const{hls:t,media:i,bufferedTrack:s}=this,r=s==null?void 0:s.attrs,n=e.attrs;i&&r&&(r.CHANNELS!==n.CHANNELS||r.NAME!==n.NAME||r.LANGUAGE!==n.LANGUAGE)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio")),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(g.AUDIO_TRACK_SWITCHED,ue({},e))}}class Pa extends Jt{constructor(e){super(e,"[audio-track-controller]"),this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.MANIFEST_PARSED,this.onManifestParsed,this),e.on(g.LEVEL_LOADING,this.onLevelLoading,this),e.on(g.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(g.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(g.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.MANIFEST_PARSED,this.onManifestParsed,this),e.off(g.LEVEL_LOADING,this.onLevelLoading,this),e.off(g.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(g.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(g.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,n=this.tracksInGroup[i];if(!n||n.groupId!==s){this.warn(`Track with id:${i} and group:${s} not found in active group ${n.groupId}`);return}const o=n.details;n.details=t.details,this.log(`audio-track ${i} "${n.name}" lang:${n.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!(t!=null&&t.audioGroupIds))return;const i=t.audioGroupIds[t.urlId];if(this.groupId!==i){this.groupId=i||null;const s=this.tracks.filter(n=>!i||n.groupId===i);this.selectDefaultTrack&&!s.some(n=>n.default)&&(this.selectDefaultTrack=!1),this.tracksInGroup=s;const r={audioTracks:s};this.log(`Updating audio tracks, ${s.length} track(s) found in group:${i}`),this.hls.trigger(g.AUDIO_TRACKS_UPDATED,r),this.selectInitialTrack()}else this.shouldReloadPlaylist(this.currentTrack)&&this.setAudioTrack(this.trackId)}onError(e,t){t.fatal||!t.context||t.context.type===G.AUDIO_TRACK&&t.context.id===this.trackId&&t.context.groupId===this.groupId&&(this.requestScheduled=-1,this.checkRetry(t))}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn("Invalid id passed to audio-track controller");return}this.clearTimer();const i=this.currentTrack;t[this.trackId];const s=t[e],{groupId:r,name:n}=s;if(this.log(`Switching to audio-track ${e} "${n}" lang:${s.lang} group:${r}`),this.trackId=e,this.currentTrack=s,this.selectDefaultTrack=!1,this.hls.trigger(g.AUDIO_TRACK_SWITCHING,ue({},s)),s.details&&!s.details.live)return;const o=this.switchParams(s.url,i==null?void 0:i.details);this.loadPlaylist(o)}selectInitialTrack(){const e=this.tracksInGroup,t=this.findTrackId(this.currentTrack)|this.findTrackId(null);if(t!==-1)this.setAudioTrack(t);else{const i=new Error(`No track found for running audio group-ID: ${this.groupId} track count: ${e.length}`);this.warn(i.message),this.hls.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:i})}}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if((!this.selectDefaultTrack||s.default)&&(!e||e.attrs["STABLE-RENDITION-ID"]!==void 0&&e.attrs["STABLE-RENDITION-ID"]===s.attrs["STABLE-RENDITION-ID"]||e.name===s.name&&e.lang===s.lang))return s.id}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.tracksInGroup[this.trackId];if(this.shouldLoadPlaylist(t)){const i=t.id,s=t.groupId;let r=t.url;if(e)try{r=e.addDirectives(r)}catch(n){this.warn(`Could not construct new URL with HLS Delivery Directives: ${n}`)}this.log(`loading audio-track playlist ${i} "${t.name}" lang:${t.lang} group:${s}`),this.clearTimer(),this.hls.trigger(g.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:e||null})}}}function Ws(a,e){if(a.length!==e.length)return!1;for(let t=0;t<a.length;t++)if(!Fa(a[t].attrs,e[t].attrs))return!1;return!0}function Fa(a,e){const t=a["STABLE-RENDITION-ID"];return t?t===e["STABLE-RENDITION-ID"]:!["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED"].some(i=>a[i]!==e[i])}const Hi=500;class Oa extends ii{constructor(e,t,i){super(e,t,i,"[subtitle-stream-controller]",U.SUBTITLE),this.levels=[],this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),this.mainDetails=null}_registerListeners(){const{hls:e}=this;e.on(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.LEVEL_LOADED,this.onLevelLoaded,this),e.on(g.ERROR,this.onError,this),e.on(g.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(g.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(g.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(g.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(g.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(g.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.LEVEL_LOADED,this.onLevelLoaded,this),e.off(g.ERROR,this.onError,this),e.off(g.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(g.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(g.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(g.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(g.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(g.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(e){this.stopLoad(),this.state=b.IDLE,this.setInterval(Hi),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:s}=t;if(this.fragPrevious=i,this.state=b.IDLE,!s)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let n;const o=i.start;for(let u=0;u<r.length;u++)if(o>=r[u].start&&o<=r[u].end){n=r[u];break}const l=i.start+i.duration;n?n.end=l:(n={start:o,end:l},r.push(n)),this.fragmentTracker.fragBuffered(i)}onBufferFlushing(e,t){const{startOffset:i,endOffset:s}=t;if(i===0&&s!==Number.POSITIVE_INFINITY){const{currentTrackId:r,levels:n}=this;if(!n.length||!n[r]||!n[r].details)return;const l=n[r].details.targetduration,u=s-l;if(u<=0)return;t.endOffsetSubtitles=Math.max(0,u),this.tracksBuffered.forEach(c=>{for(let d=0;d<c.length;){if(c[d].end<=u){c.shift();continue}else if(c[d].start<u)c[d].start=u;else break;d++}}),this.fragmentTracker.removeFragmentsInRange(i,u,U.SUBTITLE)}}onFragBuffered(e,t){if(!this.loadedmetadata&&t.frag.type===U.MAIN){var i;(i=this.media)!=null&&i.buffered.length&&(this.loadedmetadata=!0)}}onError(e,t){const i=t.frag;(i==null?void 0:i.type)===U.SUBTITLE&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==b.STOPPED&&(this.state=b.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(Ws(this.levels,t)){this.levels=t.map(i=>new Ve(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const s=new Ve(i);return this.tracksBuffered[s.id]=[],s}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,U.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){if(this.currentTrackId=t.id,!this.levels.length||this.currentTrackId===-1){this.clearInterval();return}const i=this.levels[this.currentTrackId];i!=null&&i.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,i&&this.setInterval(Hi)}onSubtitleTrackLoaded(e,t){var i;const{details:s,id:r}=t,{currentTrackId:n,levels:o}=this;if(!o.length)return;const l=o[n];if(r>=o.length||r!==n||!l)return;this.mediaBuffer=this.mediaBufferTimeRanges;let u=0;if(s.live||(i=l.details)!=null&&i.live){const c=this.mainDetails;if(s.deltaUpdateFailed||!c)return;const d=c.fragments[0];l.details?(u=this.alignPlaylists(s,l.details),u===0&&d&&(u=d.start,Kt(s,u))):s.hasProgramDateTime&&c.hasProgramDateTime?(Cs(s,c),u=s.fragments[0].start):d&&(u=d.start,Kt(s,u))}l.details=s,this.levelLastLoaded=r,!this.startFragRequested&&(this.mainDetails||!s.live)&&this.setStartPosition(l.details,u),this.tick(),s.live&&!this.fragCurrent&&this.media&&this.state===b.IDLE&&(He(null,s.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,s=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&s&&s.key&&s.iv&&s.method==="AES-128"){const n=performance.now();this.decrypter.decrypt(new Uint8Array(i),s.key.buffer,s.iv.buffer).catch(o=>{throw r.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.FRAG_DECRYPT_ERROR,fatal:!1,error:o,reason:o.message,frag:t}),o}).then(o=>{const l=performance.now();r.trigger(g.FRAG_DECRYPTED,{frag:t,payload:o,stats:{tstart:n,tdecrypt:l}})}).catch(o=>{this.warn(`${o.name}: ${o.message}`),this.state=b.IDLE})}}doTick(){if(!this.media){this.state=b.IDLE;return}if(this.state===b.IDLE){const{currentTrackId:e,levels:t}=this,i=t[e];if(!t.length||!i||!i.details)return;const s=i.details,r=s.targetduration,{config:n}=this,o=this.getLoadPosition(),l=Y.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],o-r,n.maxBufferHole),{end:u,len:c}=l,d=this.getFwdBufferInfo(this.media,U.MAIN),h=this.getMaxBufferLength(d==null?void 0:d.len)+r;if(c>h)return;const f=s.fragments,m=f.length,p=s.edge;let T=null;const x=this.fragPrevious;if(u<p){const{maxFragLookUpTolerance:v}=n;T=He(x,f,Math.max(f[0].start,u),v),!T&&x&&x.start<f[0].start&&(T=f[0])}else T=f[m-1];if(!T)return;T=this.mapToInitFragWhenRequired(T),this.fragmentTracker.getState(T)===ie.NOT_LOADED&&this.loadFragment(T,i,u)}}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.max(t,e):t}loadFragment(e,t,i){this.fragCurrent=e,e.sn==="initSegment"?this._loadInitSegment(e,t):(this.startFragRequested=!0,super.loadFragment(e,t,i))}get mediaBufferTimeRanges(){return new Ma(this.tracksBuffered[this.currentTrackId]||[])}}class Ma{constructor(e){this.buffered=void 0;const t=(i,s,r)=>{if(s=s>>>0,s>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${s}) is greater than the maximum bound (${r})`);return e[s][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}class Na extends Jt{constructor(e){super(e,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.trackChangeListener=()=>this.onTextTracksChanged(),this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes(this.trackId)}registerListeners(){const{hls:e}=this;e.on(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.MANIFEST_PARSED,this.onManifestParsed,this),e.on(g.LEVEL_LOADING,this.onLevelLoading,this),e.on(g.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(g.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(g.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.MANIFEST_PARSED,this.onManifestParsed,this),e.off(g.LEVEL_LOADING,this.onLevelLoading,this),e.off(g.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(g.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(g.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,e)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),kt(this.media.textTracks).forEach(t=>{Ue(t)}),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,details:s}=t,{trackId:r}=this,n=this.tracksInGroup[r];if(!n){this.warn(`Invalid subtitle track id ${i}`);return}const o=n.details;n.details=t.details,this.log(`subtitle track ${i} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!(t!=null&&t.textGroupIds))return;const i=t.textGroupIds[t.urlId],s=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;if(this.groupId!==i){const r=this.tracks.filter(l=>!i||l.groupId===i);this.tracksInGroup=r;const n=this.findTrackId(s==null?void 0:s.name)||this.findTrackId();this.groupId=i||null;const o={subtitleTracks:r};this.log(`Updating subtitle tracks, ${r.length} track(s) found in "${i}" group-id`),this.hls.trigger(g.SUBTITLE_TRACKS_UPDATED,o),n!==-1&&this.setSubtitleTrack(n,s)}else this.shouldReloadPlaylist(s)&&this.setSubtitleTrack(this.trackId,s)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if((!this.selectDefaultTrack||s.default)&&(!e||e===s.name))return s.id}return-1}onError(e,t){t.fatal||!t.context||t.context.type===G.SUBTITLE_TRACK&&t.context.id===this.trackId&&t.context.groupId===this.groupId&&this.checkRetry(t)}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1;const t=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(e,t)}loadPlaylist(e){super.loadPlaylist();const t=this.tracksInGroup[this.trackId];if(this.shouldLoadPlaylist(t)){const i=t.id,s=t.groupId;let r=t.url;if(e)try{r=e.addDirectives(r)}catch(n){this.warn(`Could not construct new URL with HLS Delivery Directives: ${n}`)}this.log(`Loading subtitle playlist for id ${i}`),this.hls.trigger(g.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:e||null})}}toggleTrackModes(e){const{media:t,trackId:i}=this;if(!t)return;const s=kt(t.textTracks),r=s.filter(o=>o.groupId===this.groupId);if(e===-1)[].slice.call(s).forEach(o=>{o.mode="disabled"});else{const o=r[i];o&&(o.mode="disabled")}const n=r[e];n&&(n.mode=this.subtitleDisplay?"showing":"hidden")}setSubtitleTrack(e,t){var i;const s=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(this.trackId!==e&&this.toggleTrackModes(e),this.trackId===e&&(e===-1||(i=s[e])!=null&&i.details)||e<-1||e>=s.length)return;this.clearTimer();const r=s[e];if(this.log(`Switching to subtitle-track ${e}`+(r?` "${r.name}" lang:${r.lang} group:${r.groupId}`:"")),this.trackId=e,r){const{id:n,groupId:o="",name:l,type:u,url:c}=r;this.hls.trigger(g.SUBTITLE_TRACK_SWITCH,{id:n,groupId:o,name:l,type:u,url:c});const d=this.switchParams(r.url,t==null?void 0:t.details);this.loadPlaylist(d)}else this.hls.trigger(g.SUBTITLE_TRACK_SWITCH,{id:e})}onTextTracksChanged(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=-1;const t=kt(this.media.textTracks);for(let i=0;i<t.length;i++)if(t[i].mode==="hidden")e=i;else if(t[i].mode==="showing"){e=i;break}this.subtitleTrack!==e&&(this.subtitleTrack=e)}}function kt(a){const e=[];for(let t=0;t<a.length;t++){const i=a[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(a[t])}return e}class Ua{constructor(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}append(e,t){const i=this.queues[t];i.push(e),i.length===1&&this.buffers[t]&&this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){let t;const i=new Promise(r=>{t=r}),s={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(s,e),i}executeNext(e){const{buffers:t,queues:i}=this,s=t[e],r=i[e];if(r.length){const n=r[0];try{n.execute()}catch(o){y.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),n.onError(o),s!=null&&s.updating||(r.shift(),this.executeNext(e))}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}}const Wi=ht(),Yi=/([ha]vc.)(?:\.[^.,]+)+/;class Ba{constructor(e){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=()=>{const{media:t,mediaSource:i}=this;y.log("[buffer-controller]: Media source opened"),t&&(t.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(g.MEDIA_ATTACHED,{media:t})),i&&i.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{y.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=()=>{y.log("[buffer-controller]: Media source ended")},this._onMediaEmptied=()=>{const{media:t,_objectUrl:i}=this;t&&t.src!==i&&y.error(`Media element src was set while attaching MediaSource (${i} > ${t.src})`)},this.hls=e,this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null}registerListeners(){const{hls:e}=this;e.on(g.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.MANIFEST_PARSED,this.onManifestParsed,this),e.on(g.BUFFER_RESET,this.onBufferReset,this),e.on(g.BUFFER_APPENDING,this.onBufferAppending,this),e.on(g.BUFFER_CODECS,this.onBufferCodecs,this),e.on(g.BUFFER_EOS,this.onBufferEos,this),e.on(g.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(g.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(g.FRAG_PARSED,this.onFragParsed,this),e.on(g.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:e}=this;e.off(g.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.MANIFEST_PARSED,this.onManifestParsed,this),e.off(g.BUFFER_RESET,this.onBufferReset,this),e.off(g.BUFFER_APPENDING,this.onBufferAppending,this),e.off(g.BUFFER_CODECS,this.onBufferCodecs,this),e.off(g.BUFFER_EOS,this.onBufferEos,this),e.off(g.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(g.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(g.FRAG_PARSED,this.onFragParsed,this),e.off(g.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new Ua(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){let i=2;(t.audio&&!t.video||!t.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,y.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(e,t){const i=this.media=t.media;if(i&&Wi){const s=this.mediaSource=new Wi;s.addEventListener("sourceopen",this._onMediaSourceOpen),s.addEventListener("sourceended",this._onMediaSourceEnded),s.addEventListener("sourceclose",this._onMediaSourceClose),i.src=self.URL.createObjectURL(s),this._objectUrl=i.src,i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:e,mediaSource:t,_objectUrl:i}=this;if(t){if(y.log("[buffer-controller]: media source detaching"),t.readyState==="open")try{t.endOfStream()}catch(s){y.warn(`[buffer-controller]: onMediaDetaching: ${s.message} while calling endOfStream`)}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),e&&(e.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),e.src===i?(e.removeAttribute("src"),e.load()):y.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(g.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(e=>{const t=this.sourceBuffer[e];try{t&&(this.removeBufferListeners(e),this.mediaSource&&this.mediaSource.removeSourceBuffer(t),this.sourceBuffer[e]=void 0)}catch(i){y.warn(`[buffer-controller]: Failed to reset the ${e} buffer`,i)}}),this._initSourceBuffer()}onBufferCodecs(e,t){const i=this.getSourceBufferTypes().length;Object.keys(t).forEach(s=>{if(i){const r=this.tracks[s];if(r&&typeof r.buffer.changeType=="function"){const{id:n,codec:o,levelCodec:l,container:u,metadata:c}=t[s],d=(r.levelCodec||r.codec).replace(Yi,"$1"),h=(l||o).replace(Yi,"$1");if(d!==h){const f=`${u};codecs=${l||o}`;this.appendChangeType(s,f),y.log(`[buffer-controller]: switching codec ${d} to ${h}`),this.tracks[s]={buffer:r.buffer,codec:o,container:u,levelCodec:l,metadata:c,id:n}}}}else this.pendingTracks[s]=t[s]}),!i&&(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks())}appendChangeType(e,t){const{operationQueue:i}=this,s={execute:()=>{const r=this.sourceBuffer[e];r&&(y.log(`[buffer-controller]: changing ${e} sourceBuffer type to ${t}`),r.changeType(t)),i.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:r=>{y.warn(`[buffer-controller]: Failed to change ${e} SourceBuffer type`,r)}};i.append(s,e)}onBufferAppending(e,t){const{hls:i,operationQueue:s,tracks:r}=this,{data:n,type:o,frag:l,part:u,chunkMeta:c}=t,d=c.buffering[o],h=self.performance.now();d.start=h;const f=l.stats.buffering,m=u?u.stats.buffering:null;f.start===0&&(f.start=h),m&&m.start===0&&(m.start=h);const p=r.audio;let T=!1;o==="audio"&&(p==null?void 0:p.container)==="audio/mpeg"&&(T=!this.lastMpegAudioChunk||c.id===1||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const x=l.start,v={execute:()=>{if(d.executeStart=self.performance.now(),T){const E=this.sourceBuffer[o];if(E){const R=x-E.timestampOffset;Math.abs(R)>=.1&&(y.log(`[buffer-controller]: Updating audio SourceBuffer timestampOffset to ${x} (delta: ${R}) sn: ${l.sn})`),E.timestampOffset=x)}}this.appendExecutor(n,o)},onStart:()=>{},onComplete:()=>{const E=self.performance.now();d.executeEnd=d.end=E,f.first===0&&(f.first=E),m&&m.first===0&&(m.first=E);const{sourceBuffer:R}=this,A={};for(const k in R)A[k]=Y.getBuffered(R[k]);this.appendError=0,this.hls.trigger(g.BUFFER_APPENDED,{type:o,frag:l,part:u,chunkMeta:c,parent:l.type,timeRanges:A})},onError:E=>{y.error(`[buffer-controller]: Error encountered while trying to append to the ${o} SourceBuffer`,E);const R={type:N.MEDIA_ERROR,parent:l.type,details:L.BUFFER_APPEND_ERROR,frag:l,part:u,chunkMeta:c,error:E,err:E,fatal:!1};E.code===DOMException.QUOTA_EXCEEDED_ERR?R.details=L.BUFFER_FULL_ERROR:(this.appendError++,R.details=L.BUFFER_APPEND_ERROR,this.appendError>i.config.appendErrorMaxRetry&&(y.error(`[buffer-controller]: Failed ${i.config.appendErrorMaxRetry} times to append segment in sourceBuffer`),R.fatal=!0)),i.trigger(g.ERROR,R)}};s.append(v,o)}onBufferFlushing(e,t){const{operationQueue:i}=this,s=r=>({execute:this.removeExecutor.bind(this,r,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(g.BUFFER_FLUSHED,{type:r})},onError:n=>{y.warn(`[buffer-controller]: Failed to remove from ${r} SourceBuffer`,n)}});t.type?i.append(s(t.type),t.type):this.getSourceBufferTypes().forEach(r=>{i.append(s(r),r)})}onFragParsed(e,t){const{frag:i,part:s}=t,r=[],n=s?s.elementaryStreams:i.elementaryStreams;n[K.AUDIOVIDEO]?r.push("audiovideo"):(n[K.AUDIO]&&r.push("audio"),n[K.VIDEO]&&r.push("video"));const o=()=>{const l=self.performance.now();i.stats.buffering.end=l,s&&(s.stats.buffering.end=l);const u=s?s.stats:i.stats;this.hls.trigger(g.FRAG_BUFFERED,{frag:i,part:s,stats:u,id:i.type})};r.length===0&&y.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(o,r)}onFragChanged(e,t){this.flushBackBuffer()}onBufferEos(e,t){this.getSourceBufferTypes().reduce((s,r)=>{const n=this.sourceBuffer[r];return n&&(!t.type||t.type===r)&&(n.ending=!0,n.ended||(n.ended=!0,y.log(`[buffer-controller]: ${r} sourceBuffer now EOS`))),s&&!!(!n||n.ended)},!0)&&(y.log("[buffer-controller]: Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(r=>{const n=this.sourceBuffer[r];n&&(n.ending=!1)});const{mediaSource:s}=this;if(!s||s.readyState!=="open"){s&&y.info(`[buffer-controller]: Could not call mediaSource.endOfStream(). mediaSource.readyState: ${s.readyState}`);return}y.log("[buffer-controller]: Calling mediaSource.endOfStream()"),s.endOfStream()}))}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}flushBackBuffer(){const{hls:e,details:t,media:i,sourceBuffer:s}=this;if(!i||t===null)return;const r=this.getSourceBufferTypes();if(!r.length)return;const n=t.live&&e.config.liveBackBufferLength!==null?e.config.liveBackBufferLength:e.config.backBufferLength;if(!F(n)||n<0)return;const o=i.currentTime,l=t.levelTargetDuration,u=Math.max(n,l),c=Math.floor(o/l)*l-u;r.forEach(d=>{const h=s[d];if(h){const f=Y.getBuffered(h);if(f.length>0&&c>f.start(0)){if(e.trigger(g.BACK_BUFFER_REACHED,{bufferEnd:c}),t.live)e.trigger(g.LIVE_BACK_BUFFER_REACHED,{bufferEnd:c});else if(h.ended&&f.end(f.length-1)-o<l*2){y.info(`[buffer-controller]: Cannot flush ${d} back buffer while SourceBuffer is in ended state`);return}e.trigger(g.BUFFER_FLUSHING,{startOffset:0,endOffset:c,type:d})}}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")return;const{details:e,hls:t,media:i,mediaSource:s}=this,r=e.fragments[0].start+e.totalduration,n=i.duration,o=F(s.duration)?s.duration:0;e.live&&t.config.liveDurationInfinity?(y.log("[buffer-controller]: Media Source duration is set to Infinity"),s.duration=1/0,this.updateSeekableRange(e)):(r>o&&r>n||!F(n))&&(y.log(`[buffer-controller]: Updating Media Source duration to ${r.toFixed(3)}`),s.duration=r)}updateSeekableRange(e){const t=this.mediaSource,i=e.fragments;if(i.length&&e.live&&t!=null&&t.setLiveSeekableRange){const r=Math.max(0,i[0].start),n=Math.max(r,r+e.totalduration);t.setLiveSeekableRange(r,n)}}checkPendingTracks(){const{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:i}=this,s=Object.keys(i).length;if(s&&!e||s===2){this.createSourceBuffers(i),this.pendingTracks={};const r=this.getSourceBufferTypes();if(r.length)this.hls.trigger(g.BUFFER_CREATED,{tracks:this.tracks}),r.forEach(n=>{t.executeNext(n)});else{const n=new Error("could not create source buffer for media codec(s)");this.hls.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:n,reason:n.message})}}}createSourceBuffers(e){const{sourceBuffer:t,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(const s in e)if(!t[s]){const r=e[s];if(!r)throw Error(`source buffer exists for track ${s}, however track does not`);const n=r.levelCodec||r.codec,o=`${r.container};codecs=${n}`;y.log(`[buffer-controller]: creating sourceBuffer(${o})`);try{const l=t[s]=i.addSourceBuffer(o),u=s;this.addBufferListener(u,"updatestart",this._onSBUpdateStart),this.addBufferListener(u,"updateend",this._onSBUpdateEnd),this.addBufferListener(u,"error",this._onSBUpdateError),this.tracks[s]={buffer:l,codec:n,container:r.container,levelCodec:r.levelCodec,metadata:r.metadata,id:r.id}}catch(l){y.error(`[buffer-controller]: error while trying to add sourceBuffer: ${l.message}`),this.hls.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:l,mimeType:o})}}}_onSBUpdateStart(e){const{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){const{operationQueue:t}=this;t.current(e).onComplete(),t.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){const i=new Error(`${e} SourceBuffer error`);y.error(`[buffer-controller]: ${i}`,t),this.hls.trigger(g.ERROR,{type:N.MEDIA_ERROR,details:L.BUFFER_APPENDING_ERROR,error:i,fatal:!1});const s=this.operationQueue.current(e);s&&s.onError(t)}removeExecutor(e,t,i){const{media:s,mediaSource:r,operationQueue:n,sourceBuffer:o}=this,l=o[e];if(!s||!r||!l){y.warn(`[buffer-controller]: Attempting to remove from the ${e} SourceBuffer, but it does not exist`),n.shiftAndExecuteNext(e);return}const u=F(s.duration)?s.duration:1/0,c=F(r.duration)?r.duration:1/0,d=Math.max(0,t),h=Math.min(i,u,c);h>d&&!l.ending?(l.ended=!1,y.log(`[buffer-controller]: Removing [${d},${h}] from the ${e} SourceBuffer`),l.remove(d,h)):n.shiftAndExecuteNext(e)}appendExecutor(e,t){const{operationQueue:i,sourceBuffer:s}=this,r=s[t];if(!r){y.warn(`[buffer-controller]: Attempting to append to the ${t} SourceBuffer, but it does not exist`),i.shiftAndExecuteNext(t);return}r.ended=!1,r.appendBuffer(e)}blockBuffers(e,t=this.getSourceBufferTypes()){if(!t.length){y.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);return}const{operationQueue:i}=this,s=t.map(r=>i.appendBlocker(r));Promise.all(s).then(()=>{e(),t.forEach(r=>{const n=this.sourceBuffer[r];n!=null&&n.updating||i.shiftAndExecuteNext(r)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,i){const s=this.sourceBuffer[e];if(!s)return;const r=i.bind(this,e);this.listeners[e].push({event:t,listener:r}),s.addEventListener(t,r)}removeBufferListeners(e){const t=this.sourceBuffer[e];t&&this.listeners[e].forEach(i=>{t.removeEventListener(i.event,i.listener)})}}const ji={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Ys=function(e){let t=e;return ji.hasOwnProperty(e)&&(t=ji[e]),String.fromCharCode(t)},pe=15,Se=100,$a={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Ga={17:2,18:4,21:6,22:8,23:10,19:13,20:15},qa={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Ka={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Va=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class Ha{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;y.log(`${this.time} [${e}] ${i}`)}}}const ke=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class js{constructor(e,t,i,s,r){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=e||"white",this.underline=t||!1,this.italics=i||!1,this.background=s||"black",this.flash=r||!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const s=t[i];e.hasOwnProperty(s)&&(this[s]=e[s])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class Wa{constructor(e,t,i,s,r,n){this.uchar=void 0,this.penState=void 0,this.uchar=e||" ",this.penState=new js(t,i,s,r,n)}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class Ya{constructor(e){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(let t=0;t<Se;t++)this.chars.push(new Wa);this.logger=e,this.pos=0,this.currPenState=new js}equals(e){let t=!0;for(let i=0;i<Se;i++)if(!this.chars[i].equals(e.chars[i])){t=!1;break}return t}copy(e){for(let t=0;t<Se;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<Se;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>Se&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=Se)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=Ys(e);if(this.pos>=Se){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<Se;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<Se;i++){const s=this.chars[i].uchar;s!==" "&&(t=!1),e.push(s)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class _t{constructor(e){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(let t=0;t<pe;t++)this.rows.push(new Ya(e));this.logger=e,this.currRow=pe-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}reset(){for(let e=0;e<pe;e++)this.rows[e].clear();this.currRow=pe-1}equals(e){let t=!0;for(let i=0;i<pe;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<pe;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<pe;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+JSON.stringify(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let o=0;o<pe;o++)this.rows[o].clear();const r=this.currRow+1-this.nrRollUpRows,n=this.lastOutputScreen;if(n){const o=n.rows[r].cueStartTime,l=this.logger.time;if(o&&l!==null&&o<l)for(let u=0;u<this.nrRollUpRows;u++)this.rows[t-this.nrRollUpRows+u+1].copy(n.rows[r+u])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const r=e.indent,n=Math.max(r-1,0);i.setCursor(e.indent),e.color=i.chars[n].penState.foreground}const s={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(s)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",s=-1;for(let r=0;r<pe;r++){const n=this.rows[r].getTextString();n&&(s=r+1,e?t.push("Row "+s+": '"+n+"'"):t.push(n.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class Xi{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new _t(i),this.nonDisplayedMemory=new _t(i),this.lastOutputScreen=new _t(i),this.currRollUpRow=this.displayedMemory.rows[pe-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[pe-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,s=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=s[i]}this.logger.log(2,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class zi{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;const s=new Ha;this.channels=[null,new Xi(e,t,s),new Xi(e+1,i,s)],this.cmdHistory=Ji(),this.logger=s}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let i,s,r,n=!1;this.logger.time=e;for(let o=0;o<t.length;o+=2)if(s=t[o]&127,r=t[o+1]&127,!(s===0&&r===0)){if(this.logger.log(3,"["+ke([t[o],t[o+1]])+"] -> ("+ke([s,r])+")"),i=this.parseCmd(s,r),i||(i=this.parseMidrow(s,r)),i||(i=this.parsePAC(s,r)),i||(i=this.parseBackgroundAttributes(s,r)),!i&&(n=this.parseChars(s,r),n)){const l=this.currentChannel;l&&l>0?this.channels[l].insertChars(n):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!i&&!n&&this.logger.log(2,"Couldn't parse cleaned data "+ke([s,r])+" orig: "+ke([t[o],t[o+1]]))}}parseCmd(e,t){const{cmdHistory:i}=this,s=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,r=(e===23||e===31)&&t>=33&&t<=35;if(!(s||r))return!1;if(Qi(e,t,i))return Ne(null,null,i),this.logger.log(3,"Repeated command ("+ke([e,t])+") is dropped"),!0;const n=e===20||e===21||e===23?1:2,o=this.channels[n];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),Ne(e,t,i),this.currentChannel=n,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const s=this.channels[i];return s?(s.ccMIDROW(t),this.logger.log(3,"MIDROW ("+ke([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const s=this.cmdHistory,r=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,n=(e===16||e===24)&&t>=64&&t<=95;if(!(r||n))return!1;if(Qi(e,t,s))return Ne(null,null,s),!0;const o=e<=23?1:2;t>=64&&t<=95?i=o===1?$a[e]:qa[e]:i=o===1?Ga[e]:Ka[e];const l=this.channels[o];return l?(l.setPAC(this.interpretPAC(i,t)),Ne(e,t,s),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i;const s={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,s.underline=(i&1)===1,i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=Math.floor((i-16)/2)*4,s}parseChars(e,t){let i,s=null,r=null;if(e>=25?(i=2,r=e-8):(i=1,r=e),r>=17&&r<=19){let n;r===17?n=t+80:r===18?n=t+112:n=t+144,this.logger.log(2,"Special char '"+Ys(n)+"' in channel "+i),s=[n]}else e>=32&&e<=127&&(s=t===0?[e]:[e,t]);if(s){const n=ke(s);this.logger.log(3,"Char codes =  "+n.join(",")),Ne(e,t,this.cmdHistory)}return s}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=45&&t<=47;if(!(i||s))return!1;let r;const n={};e===16||e===24?(r=Math.floor((t-32)/2),n.background=Va[r],t%2===1&&(n.background=n.background+"_semi")):t===45?n.background="transparent":(n.foreground="black",t===47&&(n.underline=!0));const o=e<=23?1:2;return this.channels[o].setBkgData(n),Ne(e,t,this.cmdHistory),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}this.cmdHistory=Ji()}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function Ne(a,e,t){t.a=a,t.b=e}function Qi(a,e,t){return t.a===a&&t.b===e}function Ji(){return{a:null,b:null}}class Ze{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var oi=function(){if(typeof self<"u"&&self.VTTCue)return self.VTTCue;const a=["","lr","rl"],e=["start","middle","end","left","right"];function t(o,l){if(typeof l!="string"||!Array.isArray(o))return!1;const u=l.toLowerCase();return~o.indexOf(u)?u:!1}function i(o){return t(a,o)}function s(o){return t(e,o)}function r(o,...l){let u=1;for(;u<arguments.length;u++){const c=arguments[u];for(const d in c)o[d]=c[d]}return o}function n(o,l,u){const c=this,d={enumerable:!0};c.hasBeenReset=!1;let h="",f=!1,m=o,p=l,T=u,x=null,v="",E=!0,R="auto",A="start",k=50,D="middle",C=50,_="middle";Object.defineProperty(c,"id",r({},d,{get:function(){return h},set:function(I){h=""+I}})),Object.defineProperty(c,"pauseOnExit",r({},d,{get:function(){return f},set:function(I){f=!!I}})),Object.defineProperty(c,"startTime",r({},d,{get:function(){return m},set:function(I){if(typeof I!="number")throw new TypeError("Start time must be set to a number.");m=I,this.hasBeenReset=!0}})),Object.defineProperty(c,"endTime",r({},d,{get:function(){return p},set:function(I){if(typeof I!="number")throw new TypeError("End time must be set to a number.");p=I,this.hasBeenReset=!0}})),Object.defineProperty(c,"text",r({},d,{get:function(){return T},set:function(I){T=""+I,this.hasBeenReset=!0}})),Object.defineProperty(c,"region",r({},d,{get:function(){return x},set:function(I){x=I,this.hasBeenReset=!0}})),Object.defineProperty(c,"vertical",r({},d,{get:function(){return v},set:function(I){const O=i(I);if(O===!1)throw new SyntaxError("An invalid or illegal string was specified.");v=O,this.hasBeenReset=!0}})),Object.defineProperty(c,"snapToLines",r({},d,{get:function(){return E},set:function(I){E=!!I,this.hasBeenReset=!0}})),Object.defineProperty(c,"line",r({},d,{get:function(){return R},set:function(I){if(typeof I!="number"&&I!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");R=I,this.hasBeenReset=!0}})),Object.defineProperty(c,"lineAlign",r({},d,{get:function(){return A},set:function(I){const O=s(I);if(!O)throw new SyntaxError("An invalid or illegal string was specified.");A=O,this.hasBeenReset=!0}})),Object.defineProperty(c,"position",r({},d,{get:function(){return k},set:function(I){if(I<0||I>100)throw new Error("Position must be between 0 and 100.");k=I,this.hasBeenReset=!0}})),Object.defineProperty(c,"positionAlign",r({},d,{get:function(){return D},set:function(I){const O=s(I);if(!O)throw new SyntaxError("An invalid or illegal string was specified.");D=O,this.hasBeenReset=!0}})),Object.defineProperty(c,"size",r({},d,{get:function(){return C},set:function(I){if(I<0||I>100)throw new Error("Size must be between 0 and 100.");C=I,this.hasBeenReset=!0}})),Object.defineProperty(c,"align",r({},d,{get:function(){return _},set:function(I){const O=s(I);if(!O)throw new SyntaxError("An invalid or illegal string was specified.");_=O,this.hasBeenReset=!0}})),c.displayState=void 0}return n.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},n}();class ja{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function Xs(a){function e(i,s,r,n){return(i|0)*3600+(s|0)*60+(r|0)+parseFloat(n||0)}const t=a.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class Xa{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let s=0;s<i.length;++s)if(t===i[s]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function zs(a,e,t,i){const s=i?a.split(i):[a];for(const r in s){if(typeof s[r]!="string")continue;const n=s[r].split(t);if(n.length!==2)continue;const o=n[0],l=n[1];e(o,l)}}const Wt=new oi(0,0,""),et=Wt.align==="middle"?"middle":"center";function za(a,e,t){const i=a;function s(){const o=Xs(a);if(o===null)throw new Error("Malformed timestamp: "+i);return a=a.replace(/^[^\sa-zA-Z-]+/,""),o}function r(o,l){const u=new Xa;zs(o,function(h,f){let m;switch(h){case"region":for(let p=t.length-1;p>=0;p--)if(t[p].id===f){u.set(h,t[p].region);break}break;case"vertical":u.alt(h,f,["rl","lr"]);break;case"line":m=f.split(","),u.integer(h,m[0]),u.percent(h,m[0])&&u.set("snapToLines",!1),u.alt(h,m[0],["auto"]),m.length===2&&u.alt("lineAlign",m[1],["start",et,"end"]);break;case"position":m=f.split(","),u.percent(h,m[0]),m.length===2&&u.alt("positionAlign",m[1],["start",et,"end","line-left","line-right","auto"]);break;case"size":u.percent(h,f);break;case"align":u.alt(h,f,["start",et,"end","left","right"]);break}},/:/,/\s/),l.region=u.get("region",null),l.vertical=u.get("vertical","");let c=u.get("line","auto");c==="auto"&&Wt.line===-1&&(c=-1),l.line=c,l.lineAlign=u.get("lineAlign","start"),l.snapToLines=u.get("snapToLines",!0),l.size=u.get("size",100),l.align=u.get("align",et);let d=u.get("position","auto");d==="auto"&&Wt.position===50&&(d=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=d}function n(){a=a.replace(/^\s+/,"")}if(n(),e.startTime=s(),n(),a.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);a=a.slice(3),n(),e.endTime=s(),n(),r(a,e)}function Qs(a){return a.replace(/<br(?: \/)?>/gi,`
`)}class Qa{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new ja,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let r=t.buffer,n=0;for(r=Qs(r);n<r.length&&r[n]!=="\r"&&r[n]!==`
`;)++n;const o=r.slice(0,n);return r[n]==="\r"&&++n,r[n]===`
`&&++n,t.buffer=r.slice(n),o}function s(r){zs(r,function(n,o){},/:/)}try{let r="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;r=i();const o=r.match(/^()?WEBVTT([ \t].*)?$/);if(!(o!=null&&o[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let n=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(n?n=!1:r=i(),t.state){case"HEADER":/:/.test(r)?s(r):r||(t.state="ID");continue;case"NOTE":r||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){t.state="NOTE";break}if(!r)continue;if(t.cue=new oi(0,0,""),t.state="CUE",r.indexOf("-->")===-1){t.cue.id=r;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{za(r,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const o=r.indexOf("-->")!==-1;if(!r||o&&(n=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=r}continue;case"BADCUE":r||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const Ja=/\r\n|\n\r|\n|\r/g,wt=function(e,t,i=0){return e.slice(i,i+t.length)===t},Za=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),s=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!F(t)||!F(i)||!F(s)||!F(r))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*s,t+=60*60*1e3*r,t},Pt=function(e){let t=5381,i=e.length;for(;i;)t=t*33^e.charCodeAt(--i);return(t>>>0).toString()};function li(a,e,t){return Pt(a.toString())+Pt(e.toString())+Pt(t)}const eo=function(e,t,i){let s=e[t],r=e[s.prevCC];if(!r||!r.new&&s.new){e.ccOffset=e.presentationOffset=s.start,s.new=!1;return}for(;(n=r)!=null&&n.new;){var n;e.ccOffset+=s.start-r.start,s.new=!1,s=r,r=e[s.prevCC]}e.presentationOffset=i};function to(a,e,t,i,s,r,n){const o=new Qa,l=ve(new Uint8Array(a)).trim().replace(Ja,`
`).split(`
`),u=[],c=ha(e.baseTime,e.timescale);let d="00:00.000",h=0,f=0,m,p=!0;o.oncue=function(T){const x=t[i];let v=t.ccOffset;const E=(h-c)/9e4;x!=null&&x.new&&(f!==void 0?v=t.ccOffset=x.start:eo(t,i,E)),E&&(v=E-t.presentationOffset);const R=T.endTime-T.startTime,A=fe((T.startTime+v-f)*9e4,s*9e4)/9e4;T.startTime=Math.max(A,0),T.endTime=Math.max(A+R,0);const k=T.text.trim();T.text=decodeURIComponent(encodeURIComponent(k)),T.id||(T.id=li(T.startTime,T.endTime,k)),T.endTime>0&&u.push(T)},o.onparsingerror=function(T){m=T},o.onflush=function(){if(m){n(m);return}r(u)},l.forEach(T=>{if(p)if(wt(T,"X-TIMESTAMP-MAP=")){p=!1,T.slice(16).split(",").forEach(x=>{wt(x,"LOCAL:")?d=x.slice(6):wt(x,"MPEGTS:")&&(h=parseInt(x.slice(7)))});try{f=Za(d)/1e3}catch(x){m=x}return}else T===""&&(p=!1);o.parse(T+`
`)}),o.flush()}const Ft="stpp.ttml.im1t",Js=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Zs=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,io={left:"start",center:"center",right:"end",start:"start",end:"end"};function Zi(a,e,t,i){const s=$(new Uint8Array(a),["mdat"]);if(s.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const r=s.map(o=>ve(o)),n=da(e.baseTime,1,e.timescale);try{r.forEach(o=>t(so(o,n)))}catch(o){i(o)}}function so(a,e){const s=new DOMParser().parseFromString(a,"text/xml").getElementsByTagName("tt")[0];if(!s)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},n=Object.keys(r).reduce((d,h)=>(d[h]=s.getAttribute(`ttp:${h}`)||r[h],d),{}),o=s.getAttribute("xml:space")!=="preserve",l=es(Ot(s,"styling","style")),u=es(Ot(s,"layout","region")),c=Ot(s,"body","[begin]");return[].map.call(c,d=>{const h=er(d,o);if(!h||!d.hasAttribute("begin"))return null;const f=Nt(d.getAttribute("begin"),n),m=Nt(d.getAttribute("dur"),n);let p=Nt(d.getAttribute("end"),n);if(f===null)throw ts(d);if(p===null){if(m===null)throw ts(d);p=f+m}const T=new oi(f-e,p-e,h);T.id=li(T.startTime,T.endTime,T.text);const x=u[d.getAttribute("region")],v=l[d.getAttribute("style")],E=ro(x,v,l),{textAlign:R}=E;if(R){const A=io[R];A&&(T.lineAlign=A),T.align=R}return ee(T,E),T}).filter(d=>d!==null)}function Ot(a,e,t){const i=a.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function es(a){return a.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function er(a,e){return[].slice.call(a.childNodes).reduce((t,i,s)=>{var r;return i.nodeName==="br"&&s?t+`
`:(r=i.childNodes)!=null&&r.length?er(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function ro(a,e,t){const i="http://www.w3.org/ns/ttml#styling";let s=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],n=a!=null&&a.hasAttribute("style")?a.getAttribute("style"):null;return n&&t.hasOwnProperty(n)&&(s=t[n]),r.reduce((o,l)=>{const u=Mt(e,i,l)||Mt(a,i,l)||Mt(s,i,l);return u&&(o[l]=u),o},{})}function Mt(a,e,t){return a&&a.hasAttributeNS(e,t)?a.getAttributeNS(e,t):null}function ts(a){return new Error(`Could not parse ttml timestamp ${a}`)}function Nt(a,e){if(!a)return null;let t=Xs(a);return t===null&&(Js.test(a)?t=no(a,e):Zs.test(a)&&(t=ao(a,e))),t}function no(a,e){const t=Js.exec(a),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function ao(a,e){const t=Zs.exec(a),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class oo{constructor(e){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=is(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){const t=new Ze(this,"textTrack1"),i=new Ze(this,"textTrack2"),s=new Ze(this,"textTrack3"),r=new Ze(this,"textTrack4");this.cea608Parser1=new zi(1,t,i),this.cea608Parser2=new zi(3,s,r)}e.on(g.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(g.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(g.FRAG_LOADING,this.onFragLoading,this),e.on(g.FRAG_LOADED,this.onFragLoaded,this),e.on(g.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(g.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(g.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(g.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(g.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(g.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(g.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(g.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(g.FRAG_LOADING,this.onFragLoading,this),e.off(g.FRAG_LOADED,this.onFragLoaded,this),e.off(g.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(g.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(g.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(g.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(g.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null}addCues(e,t,i,s,r){let n=!1;for(let o=r.length;o--;){const l=r[o],u=uo(l[0],l[1],t,i);if(u>=0&&(l[0]=Math.min(l[0],t),l[1]=Math.max(l[1],i),n=!0,u/(i-t)>.5))return}if(n||r.push([t,i]),this.config.renderTextTracksNatively){const o=this.captionsTracks[e];this.Cues.newCue(o,t,i,s)}else{const o=this.Cues.newCue(null,t,i,s);this.hls.trigger(g.CUES_PARSED,{type:"captions",cues:o,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){const{unparsedVttFrags:n}=this;i==="main"&&(this.initPTS[t.cc]={baseTime:s,timescale:r}),n.length&&(this.unparsedVttFrags=[],n.forEach(o=>{this.onFragLoaded(g.FRAG_LOADED,o)}))}getExistingTrack(e){const{media:t}=this;if(t)for(let i=0;i<t.textTracks.length;i++){const s=t.textTracks[i];if(s[e])return s}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:s}=this,{label:r,languageCode:n}=t[e],o=this.getExistingTrack(e);if(o)i[e]=o,Ue(i[e]),Ss(i[e],s);else{const l=this.createTextTrack("captions",r,n);l&&(l[e]=!0,i[e]=l)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,s={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=s,this.hls.trigger(g.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[s]})}createTextTrack(e,t,i){const s=this.media;if(s)return s.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:e}=this;Object.keys(e).forEach(t=>{Ue(e[t]),delete e[t]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=is(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)Ue(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],s=i.some(r=>r.textCodec===Ft);if(this.config.enableWebVTT||s&&this.config.enableIMSC1){if(Ws(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const n=this.media?this.media.textTracks:null;this.tracks.forEach((o,l)=>{let u;if(n&&l<n.length){let c=null;for(let d=0;d<n.length;d++)if(lo(n[d],o)){c=n[d];break}c&&(u=c)}if(u)Ue(u);else{const c=this._captionsOrSubtitlesFromCharacteristics(o);u=this.createTextTrack(c,o.name,o.lang),u&&(u.mode="disabled")}u&&(u.groupId=o.groupId,this.textTracks.push(u))})}else if(this.tracks.length){const n=this.tracks.map(o=>({label:o.name,kind:o.type.toLowerCase(),default:o.default,subtitleTrack:o}));this.hls.trigger(g.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:n})}}}_captionsOrSubtitlesFromCharacteristics(e){if(e.attrs.CHARACTERISTICS){const t=/transcribes-spoken-dialog/gi.test(e.attrs.CHARACTERISTICS),i=/describes-music-and-sound/gi.test(e.attrs.CHARACTERISTICS);if(t&&i)return"captions"}return"subtitles"}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const s=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!s)return;const r=`textTrack${s[1]}`,n=this.captionsProperties[r];n&&(n.label=i.name,i.lang&&(n.languageCode=i.lang),n.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t==null?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){const{cea608Parser1:i,cea608Parser2:s,lastSn:r,lastPartIndex:n}=this;if(!(!this.enabled||!(i&&s))&&t.frag.type===U.MAIN){var o,l;const u=t.frag.sn,c=(o=t==null||(l=t.part)==null?void 0:l.index)!=null?o:-1;u===r+1||u===r&&c===n+1||(i.reset(),s.reset()),this.lastSn=u,this.lastPartIndex=c}}onFragLoaded(e,t){const{frag:i,payload:s}=t,{initPTS:r,unparsedVttFrags:n}=this;if(i.type===U.SUBTITLE)if(s.byteLength){if(!r[i.cc]){n.push(t),r.length&&this.hls.trigger(g.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Missing initial subtitle PTS")});return}const o=i.decryptdata,l="stats"in t;if(o==null||!o.encrypted||l){const u=this.tracks[i.level],c=this.vttCCs;c[i.cc]||(c[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),u&&u.textCodec===Ft?this._parseIMSC1(i,s):this._parseVTTs(i,s,c)}}else this.hls.trigger(g.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;Zi(t,this.initPTS[e.cc],s=>{this._appendCues(s,e.level),i.trigger(g.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},s=>{y.log(`Failed to parse IMSC1: ${s}`),i.trigger(g.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:s})})}_parseVTTs(e,t,i){var s;const r=this.hls,n=(s=e.initSegment)!=null&&s.data?Pe(e.initSegment.data,new Uint8Array(t)):t;to(n,this.initPTS[e.cc],i,e.cc,e.start,o=>{this._appendCues(o,e.level),r.trigger(g.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},o=>{this._fallbackToIMSC1(e,t),y.log(`Failed to parse VTT cue: ${o}`),r.trigger(g.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:o})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||Zi(t,this.initPTS[e.cc],()=>{i.textCodec=Ft,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const s=this.textTracks[t];if(!s||s.mode==="disabled")return;e.forEach(r=>As(s,r))}else{const s=this.tracks[t];if(!s)return;const r=s.default?"default":"subtitles"+t;i.trigger(g.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){const{frag:i}=t;if(i.type===U.SUBTITLE){if(!this.initPTS[i.cc]){this.unparsedVttFrags.push(t);return}this.onFragLoaded(g.FRAG_LOADED,t)}}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){const{cea608Parser1:i,cea608Parser2:s}=this;if(!this.enabled||!(i&&s))return;const{frag:r,samples:n}=t;if(!(r.type===U.MAIN&&this.closedCaptionsForLevel(r)==="NONE"))for(let o=0;o<n.length;o++){const l=n[o].bytes;if(l){const u=this.extractCea608Data(l);i.addData(n[o].pts,u[0]),s.addData(n[o].pts,u[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:s,type:r}){const{media:n}=this;if(!(!n||n.currentTime<i)){if(!r||r==="video"){const{captionsTracks:o}=this;Object.keys(o).forEach(l=>$t(o[l],t,i))}if(this.config.renderTextTracksNatively&&t===0&&s!==void 0){const{textTracks:o}=this;Object.keys(o).forEach(l=>$t(o[l],t,s))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let s=2;for(let r=0;r<i;r++){const n=e[s++],o=127&e[s++],l=127&e[s++];if(o===0&&l===0)continue;if((4&n)!==0){const c=3&n;(c===0||c===1)&&(t[c].push(o),t[c].push(l))}}return t}}function lo(a,e){return!!a&&a.label===e.name&&!(a.textTrack1||a.textTrack2)}function uo(a,e,t,i){return Math.min(e,i)-Math.max(a,t)}function is(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}class ui{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(g.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(g.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(g.MANIFEST_PARSED,this.onManifestParsed,this),e.on(g.BUFFER_CODECS,this.onBufferCodecs,this),e.on(g.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(g.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(g.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(g.MANIFEST_PARSED,this.onManifestParsed,this),e.off(g.BUFFER_CODECS,this.onBufferCodecs,this),e.off(g.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){const e=this.hls.levels;if(e.length){const t=this.hls;t.autoLevelCapping=this.getMaxLevel(e.length-1),t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((s,r)=>this.isLevelAllowed(s)&&r<=e);return this.clientRect=null,ui.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return e}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const s=(n,o)=>o?n.width!==o.width||n.height!==o.height:!0;let r=e.length-1;for(let n=0;n<e.length;n+=1){const o=e[n];if((o.width>=t||o.height>=i)&&s(o,e[n+1])){r=n;break}}return r}}class co{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(g.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(g.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const s=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=s,s&&typeof s.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,i){const s=performance.now();if(t){if(this.lastTime){const r=s-this.lastTime,n=i-this.lastDroppedFrames,o=t-this.lastDecodedFrames,l=1e3*n/r,u=this.hls;if(u.trigger(g.FPS_DROP,{currentDropped:n,currentDecoded:o,totalDroppedFrames:i}),l>0&&n>u.config.fpsDroppedMonitoringThreshold*o){let c=u.currentLevel;y.warn("drop FPS ratio greater than max allowed value for currentLevel: "+c),c>0&&(u.autoLevelCapping===-1||u.autoLevelCapping>=c)&&(c=c-1,u.trigger(g.FPS_DROP_LEVEL_CAPPING,{level:c,droppedLevel:u.currentLevel}),u.autoLevelCapping=c,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}const tt="[eme]";class Be{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=Be.CDMCleanupPromise?[Be.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=y.debug.bind(y,tt),this.log=y.log.bind(y,tt),this.warn=y.warn.bind(y,tt),this.error=y.error.bind(y,tt),this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(g.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(g.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(g.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(g.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(g.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(g.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(g.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(g.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,s=t[e];if(s)return s.licenseUrl;if(e===J.WIDEVINE&&i)return i;throw new Error(`no license server URL configured for key-system "${e}"`)}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(n,o,l)=>!!n&&l.indexOf(n)===o,s=t.map(n=>n.audioCodec).filter(i),r=t.map(n=>n.videoCodec).filter(i);return s.length+r.length===0&&r.push("avc1.42e01e"),new Promise((n,o)=>{const l=u=>{const c=u.shift();this.getMediaKeysPromise(c,s,r).then(d=>n({keySystem:c,mediaKeys:d})).catch(d=>{u.length?l(u):d instanceof he?o(d):o(new he({type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_NO_ACCESS,error:d,fatal:!0},d.message))})};l(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let s=`Configured requestMediaKeySystemAccess is not a function ${i}`;return cs===null&&self.location.protocol==="http:"&&(s=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(s))}return i(e,t)}getMediaKeysPromise(e,t,i){const s=Ar(e,t,i,this.config.drmSystemOptions),r=this.keySystemAccessPromises[e];let n=r==null?void 0:r.keySystemAccess;if(!n){this.log(`Requesting encrypted media "${e}" key-system access with config: ${JSON.stringify(s)}`),n=this.requestMediaKeySystemAccess(e,s);const o=this.keySystemAccessPromises[e]={keySystemAccess:n};return n.catch(l=>{this.log(`Failed to obtain access to key-system "${e}": ${l}`)}),n.then(l=>{this.log(`Access for key-system "${l.keySystem}" obtained`);const u=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),o.mediaKeys=l.createMediaKeys().then(c=>(this.log(`Media-keys created for "${e}"`),u.then(d=>d?this.setMediaKeysServerCertificate(c,e,d):c))),o.mediaKeys.catch(c=>{this.error(`Failed to create media-keys for "${e}"}: ${c}`)}),o.mediaKeys})}return n.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${ye.hexDump(e.keyId||[])}`);const s=i.createSession(),r={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:s,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),s=this.getKeyIdString(t),r="cenc";this.keyIdToKeySessionPromise[s]=this.generateRequestWithPreferredKeySession(i,r,t.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return ye.hexDump(e.keyId)}updateKeySession(e,t){var i;const s=e.mediaKeysSession;return this.log(`Updating key-session "${s.sessionId}" for keyID ${ye.hexDump(((i=e.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${t&&t.byteLength})`),s.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise((t,i)=>{const s=gt(this.config),r=e.map(fi).filter(n=>!!n&&s.indexOf(n)!==-1);return this.getKeySystemSelectionPromise(r).then(({keySystem:n})=>{const o=mi(n);o?t(o):i(new Error(`Unable to find format for key-system "${n}"`))}).catch(i)})}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),s=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${s}`);let r=this.keyIdToKeySessionPromise[i];return r||(r=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(t).then(({keySystem:n,mediaKeys:o})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${s}`),this.attemptSetMediaKeys(n,o).then(()=>{this.throwIfDestroyed();const l=this.createMediaKeySessionContext({keySystem:n,mediaKeys:o,decryptdata:t}),u="cenc";return this.generateRequestWithPreferredKeySession(l,u,t.pssh,"playlist-key")}))),r.catch(n=>this.handleError(n))),r}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof he?this.hls.trigger(g.ERROR,e.data):this.hls.trigger(g.ERROR,{type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const s=fi(e.keyFormat),r=s?[s]:gt(this.config);return this.attemptKeySystemAccess(r)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=gt(this.config)),e.length===0)throw new he({type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}_onMediaEncrypted(e){const{initDataType:t,initData:i}=e;if(this.debug(`"${e.type}" event: init data type: "${t}"`),i===null)return;let s,r;if(t==="sinf"&&this.config.drmSystems[J.FAIRPLAY]){const c=te(new Uint8Array(i));try{const d=Xt(JSON.parse(c).sinf),h=xs(new Uint8Array(d));if(!h)return;s=h.subarray(8,24),r=J.FAIRPLAY}catch{this.warn('Failed to parse sinf "encrypted" event message initData');return}}else{const c=Yr(i);if(c===null)return;c.version===0&&c.systemId===us.WIDEVINE&&c.data&&(s=c.data.subarray(8,24)),r=Sr(c.systemId)}if(!r||!s)return;const n=ye.hexDump(s),{keyIdToKeySessionPromise:o,mediaKeySessions:l}=this;let u=o[n];for(let c=0;c<l.length;c++){const d=l[c],h=d.decryptdata;if(h.pssh||!h.keyId)continue;const f=ye.hexDump(h.keyId);if(n===f||h.uri.replace(/-/g,"").indexOf(n)!==-1){u=o[f],delete o[f],h.pssh=new Uint8Array(i),h.keyId=s,u=o[n]=u.then(()=>this.generateRequestWithPreferredKeySession(d,t,i,"encrypted-event-key-match"));break}}u||(u=o[n]=this.getKeySystemSelectionPromise([r]).then(({keySystem:c,mediaKeys:d})=>{var h;this.throwIfDestroyed();const f=new Ke("ISO-23001-7",n,(h=mi(c))!=null?h:"");return f.pssh=new Uint8Array(i),f.keyId=s,this.attemptSetMediaKeys(c,d).then(()=>{this.throwIfDestroyed();const m=this.createMediaKeySessionContext({decryptdata:f,keySystem:c,mediaKeys:d});return this.generateRequestWithPreferredKeySession(m,t,i,"encrypted-event-no-match")})})),u.catch(c=>this.handleError(c))}_onWaitingForKey(e){this.log(`"${e.type}" event`)}attemptSetMediaKeys(e,t){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const s=Promise.all(i).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.setMediaKeysQueue.push(s),s.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(s),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(r=>i.indexOf(r)===-1)})}generateRequestWithPreferredKeySession(e,t,i,s){var r,n;const o=(r=this.config.drmSystems)==null||(n=r[e.keySystem])==null?void 0:n.generateRequest;if(o)try{const h=o.call(this.hls,t,i,e);if(!h)throw new Error("Invalid response from configured generateRequest filter");t=h.initDataType,i=e.decryptdata.pssh=h.initData?new Uint8Array(h.initData):null}catch(h){var l;if(this.warn(h.message),(l=this.hls)!=null&&l.config.debug)throw h}if(i===null)return this.log(`Skipping key-session request for "${s}" (no initData)`),Promise.resolve(e);const u=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${s}": ${u} (init data type: ${t} length: ${i?i.byteLength:null})`);const c=new ai;e.mediaKeysSession.onmessage=h=>{const f=e.mediaKeysSession;if(!f){c.emit("error",new Error("invalid state"));return}const{messageType:m,message:p}=h;this.log(`"${m}" message event for session "${f.sessionId}" message size: ${p.byteLength}`),m==="license-request"||m==="license-renewal"?this.renewLicense(e,p).catch(T=>{this.handleError(T),c.emit("error",T)}):m==="license-release"?e.keySystem===J.FAIRPLAY&&(this.updateKeySession(e,ls("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${m}"`)},e.mediaKeysSession.onkeystatuseschange=h=>{if(!e.mediaKeysSession){c.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(e);const m=e.keyStatus;c.emit("keyStatus",m),m==="expired"&&(this.warn(`${e.keySystem} expired for key ${u}`),this.renewKeySession(e))};const d=new Promise((h,f)=>{c.on("error",f),c.on("keyStatus",m=>{m.startsWith("usable")?h():m==="output-restricted"?f(new he({type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):m==="internal-error"?f(new he({type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${m}"`)):m==="expired"?f(new Error("key expired while generating request")):this.warn(`unhandled key status change "${m}"`)})});return e.mediaKeysSession.generateRequest(t,i).then(()=>{var h;this.log(`Request generated for key-session "${(h=e.mediaKeysSession)==null?void 0:h.sessionId}" keyId: ${u}`)}).catch(h=>{throw new he({type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_NO_SESSION,error:h,fatal:!1},`Error generating key-session request: ${h}`)}).then(()=>d).catch(h=>{throw c.removeAllListeners(),this.removeSession(e),h}).then(()=>(c.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,i)=>{this.log(`key status change "${t}" for keyStatuses keyId: ${ye.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${ye.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,i=t.loader,s=new i(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching serverCertificate for "${e}"`),new Promise((n,o)=>{const l={responseType:"arraybuffer",url:r},u=t.certLoadPolicy.default,c={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},d={onSuccess:(h,f,m,p)=>{n(h.data)},onError:(h,f,m,p)=>{o(new he({type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:ue({url:l.url,data:void 0},h)},`"${e}" certificate request failed (${r}). Status: ${h.code} (${h.text})`))},onTimeout:(h,f,m)=>{o(new he({type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(h,f,m)=>{o(new Error("aborted"))}};s.load(l,c,d)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((s,r)=>{e.setServerCertificate(i).then(n=>{this.log(`setServerCertificate ${n?"success":"not supported by CDM"} (${i==null?void 0:i.byteLength}) on "${t}"`),s(e)}).catch(n=>{r(new he({type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:n,fatal:!0},n.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(s=>{throw new he({type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:s,fatal:!0},s.message)}))}setupLicenseXHR(e,t,i,s){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return r.call(this.hls,e,t,i,s)}).catch(n=>{if(!i.decryptdata)throw n;return e.open("POST",t,!0),r.call(this.hls,e,t,i,s)}).then(n=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:n||s})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:s}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((s,r)=>{const n=this.getLicenseServerUrl(e.keySystem);this.log(`Sending license request to URL: ${n}`);const o=new XMLHttpRequest;o.responseType="arraybuffer",o.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return r(new Error("invalid state"));if(o.readyState===4)if(o.status===200){this._requestLicenseFailureCount=0;let l=o.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const u=this.config.licenseResponseCallback;if(u)try{l=u.call(this.hls,o,n,e)}catch(c){this.error(c)}s(l)}else{const l=i.errorRetry,u=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>u||o.status>=400&&o.status<500)r(new he({type:N.KEY_SYSTEM_ERROR,details:L.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:{url:n,data:void 0,code:o.status,text:o.statusText}},`License Request XHR failed (${n}). Status: ${o.status} (${o.statusText})`));else{const c=u-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${c} attempts left`),this.requestLicense(e,t).then(s,r)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=o,this.setupLicenseXHR(o,n,e,t).then(({xhr:l,licenseChallenge:u})=>{l.send(u)})})}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media,t=this.mediaKeySessions;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},Ke.clearKeyUriToKeyIdMap();const i=t.length;Be.CDMCleanupPromise=Promise.all(t.map(s=>this.removeSession(s)).concat(e==null?void 0:e.setMediaKeys(null).catch(s=>{this.log(`Could not clear media keys: ${s}. media.src: ${e==null?void 0:e.src}`)}))).then(()=>{i&&(this.log("finished closing key sessions and clearing media keys"),t.length=0)}).catch(s=>{this.log(`Could not close sessions and clear media keys: ${s}. media.src: ${e==null?void 0:e.src}`)})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((s,r)=>(s.indexOf(r.keyFormat)===-1&&s.push(r.keyFormat),s),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),t.onmessage=null,t.onkeystatuseschange=null,i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const s=this.mediaKeySessions.indexOf(e);return s>-1&&this.mediaKeySessions.splice(s,1),t.remove().catch(r=>{this.log(`Could not remove session: ${r}`)}).then(()=>t.close()).catch(r=>{this.log(`Could not close session: ${r}`)})}}}Be.CDMCleanupPromise=void 0;class he extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}const ho=1;var ne={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"};const fo="h";class be{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=s=>{try{this.apply(s,{ot:ne.MANIFEST,su:!this.initialized})}catch(r){y.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=s=>{try{const r=s.frag,n=this.hls.levels[r.level],o=this.getObjectType(r),l={d:r.duration*1e3,ot:o};(o===ne.VIDEO||o===ne.AUDIO||o==ne.MUXED)&&(l.br=n.bitrate/1e3,l.tb=this.getTopBandwidth(o)/1e3,l.bl=this.getBufferLength(o)),this.apply(s,l)}catch(r){y.warn("Could not generate segment CMCD data.",r)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||be.uuid(),this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.registerListeners())}registerListeners(){const e=this.hls;e.on(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(g.MEDIA_DETACHED,this.onMediaDetached,this),e.on(g.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(g.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(g.MEDIA_DETACHED,this.onMediaDetached,this),e.off(g.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,s;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(s=t.tracks.video)==null?void 0:s.buffer}createData(){var e;return{v:ho,sf:fo,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){ee(t,this.createData());const i=t.ot===ne.INIT||t.ot===ne.VIDEO||t.ot===ne.MUXED;if(this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering),this.useHeaders){const s=be.toHeaders(t);if(!Object.keys(s).length)return;e.headers||(e.headers={}),ee(e.headers,s)}else{const s=be.toQuery(t);if(!s)return;e.url=be.appendQueryToUri(e.url,s)}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return ne.TIMED_TEXT;if(e.sn==="initSegment")return ne.INIT;if(t==="audio")return ne.AUDIO;if(t==="main")return this.hls.audioTracks.length?ne.VIDEO:ne.MUXED}getTopBandwidth(e){let t=0,i;const s=this.hls;if(e===ne.AUDIO)i=s.audioTracks;else{const r=s.maxAutoLevel,n=r>-1?r+1:s.levels.length;i=s.levels.slice(0,n)}for(const r of i)r.bitrate>t&&(t=r.bitrate);return t>0?t:NaN}getBufferLength(e){const t=this.hls.media,i=e===ne.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:Y.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,n,o){t(r),this.loader.load(r,n,o)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,n,o){t(r),this.loader.load(r,n,o)}}}static uuid(){const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}static serialize(e){const t=[],i=u=>!Number.isNaN(u)&&u!=null&&u!==""&&u!==!1,s=u=>Math.round(u),r=u=>s(u/100)*100,o={br:s,d:s,bl:r,dl:r,mtp:r,nor:u=>encodeURIComponent(u),rtp:r,tb:s},l=Object.keys(e||{}).sort();for(const u of l){let c=e[u];if(!i(c)||u==="v"&&c===1||u=="pr"&&c===1)continue;const d=o[u];d&&(c=d(c));const h=typeof c;let f;u==="ot"||u==="sf"||u==="st"?f=`${u}=${c}`:h==="boolean"?f=u:h==="number"?f=`${u}=${c}`:f=`${u}=${JSON.stringify(c)}`,t.push(f)}return t.join(",")}static toHeaders(e){const t=Object.keys(e),i={},s=["Object","Request","Session","Status"],r=[{},{},{},{}],n={br:0,d:0,ot:0,tb:0,bl:1,dl:1,mtp:1,nor:1,nrr:1,su:1,cid:2,pr:2,sf:2,sid:2,st:2,v:2,bs:3,rtp:3};for(const o of t){const l=n[o]!=null?n[o]:1;r[l][o]=e[o]}for(let o=0;o<r.length;o++){const l=be.serialize(r[o]);l&&(i[`CMCD-${s[o]}`]=l)}return i}static toQuery(e){return`CMCD=${encodeURIComponent(be.serialize(e))}`}static appendQueryToUri(e,t){if(!t)return e;const i=e.includes("?")?"&":"?";return`${e}${i}${t}`}}const mo=3e5;class go{constructor(e){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.log=y.log.bind(y,"[content-steering]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(g.MANIFEST_LOADING,this.onManifestLoading,this),e.on(g.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(g.MANIFEST_PARSED,this.onManifestParsed,this),e.on(g.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(g.MANIFEST_LOADING,this.onManifestLoading,this),e.off(g.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(g.MANIFEST_PARSED,this.onManifestParsed,this),e.off(g.ERROR,this.onError,this))}startLoad(){if(this.started=!0,self.clearTimeout(this.reloadTimer),this.enabled&&this.uri)if(this.updated){const e=Math.max(this.timeToLoad*1e3-(performance.now()-this.updated),0);this.scheduleRefresh(this.uri,e)}else this.loadSteeringManifest(this.uri)}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),self.clearTimeout(this.reloadTimer)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((i==null?void 0:i.action)===oe.SendAlternateToPenaltyBox&&i.flags===ge.MoveAllAlternatesMatchingHost){let s=this.pathwayPriority;const r=this.pathwayId;this.penalizedPathways[r]||(this.penalizedPathways[r]=performance.now()),!s&&this.levels&&(s=this.levels.reduce((n,o)=>(n.indexOf(o.pathwayId)===-1&&n.push(o.pathwayId),n),[])),s&&s.length>1&&(this.updatePathwayPriority(s),i.resolved=this.pathwayId!==r)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length?(this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t):e}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this.pathwayPriority=e;let t;const i=this.penalizedPathways,s=performance.now();Object.keys(i).forEach(r=>{s-i[r]>mo&&delete i[r]});for(let r=0;r<e.length;r++){const n=e[r];if(i[n])continue;if(n===this.pathwayId)return;const o=this.hls.nextLoadLevel,l=this.hls.levels[o];if(t=this.getLevelsForPathway(n),t.length>0){this.log(`Setting Pathway to "${n}"`),this.pathwayId=n,this.hls.trigger(g.LEVELS_UPDATED,{levels:t});const u=this.hls.levels[o];l&&u&&this.levels&&(u.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&u.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${u.bitrate}`),this.hls.nextLoadLevel=o);break}}}clonePathways(e){const t=this.levels;if(!t)return;const i={},s={};e.forEach(r=>{const{ID:n,"BASE-ID":o,"URI-REPLACEMENT":l}=r;if(t.some(c=>c.pathwayId===n))return;const u=this.getLevelsForPathway(o).map(c=>{const d=ee({},c);d.details=void 0,d.url=tr(c.uri,c.attrs["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l);const h=new Q(c.attrs);h["PATHWAY-ID"]=n;const f=h.AUDIO&&`${h.AUDIO}_clone_${n}`,m=h.SUBTITLES&&`${h.SUBTITLES}_clone_${n}`;f&&(i[h.AUDIO]=f,h.AUDIO=f),m&&(s[h.SUBTITLES]=m,h.SUBTITLES=m),d.attrs=h;const p=new Ve(d);return lt(p,"audio",f),lt(p,"text",m),p});t.push(...u),ss(this.audioTracks,i,l,n),ss(this.subtitleTracks,s,l,n)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let s;try{s=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(s.protocol!=="data:"){const c=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;s.searchParams.set("_HLS_pathway",this.pathwayId),s.searchParams.set("_HLS_throughput",""+c)}const r={responseType:"json",url:s.href},n=t.steeringManifestLoadPolicy.default,o=n.errorRetry||n.timeoutRetry||{},l={loadPolicy:n,timeout:n.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},u={onSuccess:(c,d,h,f)=>{this.log(`Loaded steering manifest: "${s}"`);const m=c.data;if(m.VERSION!==1){this.log(`Steering VERSION ${m.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=m.TTL;const{"RELOAD-URI":p,"PATHWAY-CLONES":T,"PATHWAY-PRIORITY":x}=m;if(p)try{this.uri=new self.URL(p,s).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${p}`);return}this.scheduleRefresh(this.uri||h.url),T&&this.clonePathways(T),x&&this.updatePathwayPriority(x)},onError:(c,d,h,f)=>{if(this.log(`Error loading steering manifest: ${c.code} ${c.text} (${d.url})`),this.stopLoad(),c.code===410){this.enabled=!1,this.log(`Steering manifest ${d.url} no longer available`);return}let m=this.timeToLoad*1e3;if(c.code===429){const p=this.loader;if(typeof(p==null?void 0:p.getResponseHeader)=="function"){const T=p.getResponseHeader("Retry-After");T&&(m=parseFloat(T)*1e3)}this.log(`Steering manifest ${d.url} rate limited`);return}this.scheduleRefresh(this.uri||d.url,m)},onTimeout:(c,d,h)=>{this.log(`Timeout loading steering manifest (${d.url})`),this.scheduleRefresh(this.uri||d.url)}};this.log(`Requesting steering manifest: ${s}`),this.loader.load(r,l,u)}scheduleRefresh(e,t=this.timeToLoad*1e3){self.clearTimeout(this.reloadTimer),this.reloadTimer=self.setTimeout(()=>{this.loadSteeringManifest(e)},t)}}function ss(a,e,t,i){a&&Object.keys(e).forEach(s=>{const r=a.filter(n=>n.groupId===s).map(n=>{const o=ee({},n);return o.details=void 0,o.attrs=new Q(o.attrs),o.url=o.attrs.URI=tr(n.url,n.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),o.groupId=o.attrs["GROUP-ID"]=e[s],o.attrs["PATHWAY-ID"]=i,o});a.push(...r)})}function tr(a,e,t,i){const{HOST:s,PARAMS:r,[t]:n}=i;let o;e&&(o=n==null?void 0:n[e],o&&(a=o));const l=new self.URL(a);return s&&!o&&(l.host=s),r&&Object.keys(r).sort().forEach(u=>{u&&l.searchParams.set(u,r[u])}),l.href}const po=/^age:\s*[\d.]+\s*$/im;class ir{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new ct,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e)return;const i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!this.stats.aborted)return r(i,t.url)}).catch(n=>(i.open("GET",t.url,!0),r(i,t.url))).then(()=>{this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(n=>{this.callbacks.onError({code:i.status,text:n.message},t,i,s)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const s=this.context.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:n}=i.loadPolicy;if(s)for(const o in s)e.setRequestHeader(o,s[o]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&F(r)?r:n,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const s=t.readyState,r=this.config;if(!i.aborted&&s>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),s===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const n=t.status,o=t.responseType!=="text";if(n>=200&&n<300&&(o&&t.response||t.responseText!==null)){i.loading.end=Math.max(self.performance.now(),i.loading.first);const l=o?t.response:t.responseText,u=t.responseType==="arraybuffer"?l.byteLength:l.length;if(i.loaded=i.total=u,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first),!this.callbacks)return;const c=this.callbacks.onProgress;if(c&&c(i,e,l,t),!this.callbacks)return;const d={url:t.responseURL,data:l,code:n};this.callbacks.onSuccess(d,i,e,t)}else{const l=r.loadPolicy.errorRetry,u=i.retry;ot(l,u,!1,n)?this.retry(l):(y.error(`${n} while loading ${e.url}`),this.callbacks.onError({code:n,text:t.statusText},e,t,i))}}}loadtimeout(){var e;const t=(e=this.config)==null?void 0:e.loadPolicy.timeoutRetry,i=this.stats.retry;if(ot(t,i,!0))this.retry(t);else{y.warn(`timeout while loading ${this.context.url}`);const s=this.callbacks;s&&(this.abortInternal(),s.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=Qt(e,i.retry),i.retry++,y.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&po.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}function To(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const xo=/(\d+)-(\d+)\/(\d+)/;class rs{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||So,this.controller=new self.AbortController,this.stats=new ct}destroy(){this.loader=this.callbacks=null,this.abortInternal()}abortInternal(){const e=this.response;e!=null&&e.ok||(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();const r=yo(e,this.controller.signal),n=i.onProgress,o=e.responseType==="arraybuffer",l=o?"byteLength":"length",{maxTimeToFirstByteMs:u,maxLoadTimeMs:c}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),t.timeout=u&&F(u)?u:c,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(s,e,this.response)},t.timeout),self.fetch(this.request).then(d=>{this.response=this.loader=d;const h=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=c,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(s,e,this.response)},c-(h-s.loading.start)),!d.ok){const{status:f,statusText:m}=d;throw new Ao(m||"fetch, bad network response",f,d)}return s.loading.first=h,s.total=vo(d.headers)||s.total,n&&F(t.highWaterMark)?this.loadProgressively(d,s,e,t.highWaterMark,n):o?d.arrayBuffer():e.responseType==="json"?d.json():d.text()}).then(d=>{const{response:h}=this;self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);const f=d[l];f&&(s.loaded=s.total=f);const m={url:h.url,data:d,code:h.status};n&&!F(t.highWaterMark)&&n(s,e,d,h),i.onSuccess(m,s,e,h)}).catch(d=>{if(self.clearTimeout(this.requestTimeout),s.aborted)return;const h=d&&d.code||0,f=d?d.message:null;i.onError({code:h,text:f},e,d?d.details:null,s)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,s=0,r){const n=new Hs,o=e.body.getReader(),l=()=>o.read().then(u=>{if(u.done)return n.dataLength&&r(t,i,n.flush(),e),Promise.resolve(new ArrayBuffer(0));const c=u.value,d=c.length;return t.loaded+=d,d<s||n.dataLength?(n.push(c),n.dataLength>=s&&r(t,i,n.flush(),e)):r(t,i,c,e),l()}).catch(()=>Promise.reject());return l()}}function yo(a,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(ee({},a.headers))};return a.rangeEnd&&t.headers.set("Range","bytes="+a.rangeStart+"-"+String(a.rangeEnd-1)),t}function Eo(a){const e=xo.exec(a);if(e)return parseInt(e[2])-parseInt(e[1])+1}function vo(a){const e=a.get("Content-Range");if(e){const i=Eo(e);if(F(i))return i}const t=a.get("Content-Length");if(t)return parseInt(t)}function So(a,e){return new self.Request(a.url,e)}class Ao extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const Lo=/\s/,Ro={newCue(a,e,t,i){const s=[];let r,n,o,l,u;const c=self.VTTCue||self.TextTrackCue;for(let h=0;h<i.rows.length;h++)if(r=i.rows[h],o=!0,l=0,u="",!r.isEmpty()){var d;for(let p=0;p<r.chars.length;p++)Lo.test(r.chars[p].uchar)&&o?l++:(u+=r.chars[p].uchar,o=!1);r.cueStartTime=e,e===t&&(t+=1e-4),l>=16?l--:l++;const f=Qs(u.trim()),m=li(e,t,f);a!=null&&(d=a.cues)!=null&&d.getCueById(m)||(n=new c(e,t,f),n.id=m,n.line=h+1,n.align="left",n.position=10+Math.min(80,Math.floor(l*8/32)*10),s.push(n))}return a&&s.length&&(s.sort((h,f)=>h.line==="auto"||f.line==="auto"?0:h.line>8&&f.line>8?f.line-h.line:h.line-f.line),s.forEach(h=>As(a,h))),s}},Io={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},bo=ue(ue({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:ir,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:ka,bufferController:Ba,capLevelController:ui,errorController:Sn,fpsController:co,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:cs,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,certLoadPolicy:{default:Io},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},Do()),{},{subtitleStreamController:Oa,subtitleTrackController:Na,timelineController:oo,audioStreamController:wa,audioTrackController:Pa,emeController:Be,cmcdController:be,contentSteeringController:go});function Do(){return{cueHandler:Ro,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function Co(a,e){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const t=Yt(a),i=["manifest","level","frag"],s=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return i.forEach(r=>{const n=`${r==="level"?"playlist":r}LoadPolicy`,o=e[n]===void 0,l=[];s.forEach(u=>{const c=`${r}Loading${u}`,d=e[c];if(d!==void 0&&o){l.push(c);const h=t[n].default;switch(e[n]={default:h},u){case"TimeOut":h.maxLoadTimeMs=d,h.maxTimeToFirstByteMs=d;break;case"MaxRetry":h.errorRetry.maxNumRetry=d,h.timeoutRetry.maxNumRetry=d;break;case"RetryDelay":h.errorRetry.retryDelayMs=d,h.timeoutRetry.retryDelayMs=d;break;case"MaxRetryTimeout":h.errorRetry.maxRetryDelayMs=d,h.timeoutRetry.maxRetryDelayMs=d;break}}}),l.length&&y.warn(`hls.js config: "${l.join('", "')}" setting(s) are deprecated, use "${n}": ${JSON.stringify(e[n])}`)}),ue(ue({},t),e)}function Yt(a){return a&&typeof a=="object"?Array.isArray(a)?a.map(Yt):Object.keys(a).reduce((e,t)=>(e[t]=Yt(a[t]),e),{}):a}function ko(a){const e=a.loader;e!==rs&&e!==ir?(y.log("[config]: Custom loader detected, cannot enable progressive streaming"),a.progressive=!1):To()&&(a.loader=rs,a.progressive=!0,a.enableSoftwareAES=!0,y.log("[config]: Progressive streaming enabled, using FetchLoader"))}class De{static get version(){return"1.4.5"}static isSupported(){return Gn()}static get Events(){return g}static get ErrorTypes(){return N}static get ErrorDetails(){return L}static get DefaultConfig(){return De.defaultConfig?De.defaultConfig:bo}static set DefaultConfig(e){De.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new ai,this._autoLevelCapping=void 0,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,hr(e.debug||!1,"Hls instance");const t=this.config=Co(De.DefaultConfig,e);this.userConfig=e,this._autoLevelCapping=-1,t.progressive&&ko(t);const{abrController:i,bufferController:s,capLevelController:r,errorController:n,fpsController:o}=t,l=new n(this),u=this.abrController=new i(this),c=this.bufferController=new s(this),d=this.capLevelController=new r(this),h=new o(this),f=new sn(this),m=new ln(this),p=t.contentSteeringController,T=p?new p(this):null,x=this.levelController=new Ln(this,T),v=new Rn(this),E=new bn(this.config),R=this.streamController=new Da(this,v,E);d.setStreamController(R),h.setStreamController(R);const A=[f,x,R];T&&A.splice(1,0,T),this.networkControllers=A;const k=[u,c,d,h,m,v];this.audioTrackController=this.createController(t.audioTrackController,A);const D=t.audioStreamController;D&&A.push(new D(this,v,E)),this.subtitleTrackController=this.createController(t.subtitleTrackController,A);const C=t.subtitleStreamController;C&&A.push(new C(this,v,E)),this.createController(t.timelineController,k),E.emeController=this.emeController=this.createController(t.emeController,k),this.cmcdController=this.createController(t.cmcdController,k),this.latencyController=this.createController(un,k),this.coreComponents=k,A.push(l);const _=l.onErrorOut;typeof _=="function"&&this.on(g.ERROR,_,l)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,s){this._emitter.off(e,t,i,s)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){y.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),this.trigger(g.ERROR,{type:N.OTHER_ERROR,details:L.INTERNAL_EXCEPTION,fatal:!1,event:e,error:i})}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){y.log("destroy"),this.trigger(g.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){y.log("attachMedia"),this._media=e,this.trigger(g.MEDIA_ATTACHING,{media:e})}detachMedia(){y.log("detachMedia"),this.trigger(g.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();const t=this.media,i=this.url,s=this.url=jt.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});y.log(`loadSource:${s}`),t&&i&&(i!==s||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(g.MANIFEST_LOADING,{url:e})}startLoad(e=-1){y.log(`startLoad(${e})`),this.networkControllers.forEach(t=>{t.startLoad(e)})}stopLoad(){y.log("stopLoad"),this.networkControllers.forEach(e=>{e.stopLoad()})}swapAudioCodec(){y.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){y.log("recoverMediaError");const e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e,t=0){this.levelController.removeLevel(e,t)}get levels(){const e=this.levelController.levels;return e||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){y.log(`set currentLevel:${e}`),this.loadLevel=e,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){y.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){y.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){y.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){return this.levelController.startLevel}set startLevel(e){y.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(y.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e)}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){qt.indexOf(e)>-1&&(this._maxHdcpLevel=e)}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let s=0;s<i;s++)if(e[s].maxBitrate>=t)return s;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let s;if(t===-1&&e&&e.length?s=e.length-1:s=t,i)for(let r=s;r--;){const n=e[r].attrs["HDCP-LEVEL"];if(n&&n<=i)return r}return s}get nextAutoLevel(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)}set nextAutoLevel(e){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,e)}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}De.defaultConfig=void 0;const _o={class:"player-page"},wo={class:"player"},Po=it("p",null," Lorem ipsum dolor sit amet consectetur adipisicing elit. Voluptatum neque nobis alias dicta nostrum similique iusto quod doloribus minima odit ex, eum corporis nisi fugiat, saepe, obcaecati eaque quaerat. Mollitia? Ut dolores voluptates perspiciatis porro non reprehenderit officia, dolorem hic eius. Temporibus illum corporis hic deleniti exercitationem, iure vitae similique tenetur minima eveniet laboriosam cum quisquam expedita commodi maxime iste! Amet saepe ex odit? Cupiditate voluptate impedit praesentium dolorem quidem reprehenderit ipsa harum ex eos itaque magnam perferendis temporibus molestias libero alias excepturi delectus, ullam expedita necessitatibus exercitationem, ea nam. Sit beatae officiis expedita voluptas doloremque ratione et maxime, laborum eligendi eos nostrum magnam. Nulla amet iste perspiciatis pariatur eaque? Architecto ex reiciendis sint. Error officia dicta deleniti officiis distinctio? Recusandae laboriosam veritatis placeat! Necessitatibus facilis natus a repellat. Dolor, illo! A, beatae. Expedita amet iste deserunt. Sint accusamus accusantium, at vel suscipit quidem tempore reprehenderit molestias laudantium culpa autem. Qui in perferendis atque dicta odit consequuntur doloribus rerum temporibus rem placeat? Fugiat, perferendis? Laborum dolor praesentium ipsum, modi velit ex rerum expedita harum quidem neque quis nisi laudantium nihil! Vitae non earum aperiam deleniti expedita incidunt perspiciatis sed dolorem temporibus. Voluptatum optio perferendis aut sint vitae dicta magni vero, ea dolorem nihil excepturi dolorum rerum quis id obcaecati culpa? Molestiae distinctio quisquam, quasi, quae dolorem, error ducimus dignissimos ea atque voluptatibus tenetur. Adipisci suscipit ipsa cum velit dolore sequi ducimus aperiam ullam, reprehenderit a nobis aspernatur at, voluptas consectetur. Modi eum atque aut velit, vel ipsa sapiente perspiciatis nesciunt totam, voluptate dicta doloremque qui nemo rem quisquam assumenda repellat in fugit, ad facere! Aut eaque nemo facere et explicabo. Asperiores amet maiores saepe cumque culpa obcaecati blanditiis. Neque voluptatem veritatis id deserunt consequuntur a harum accusantium eos corporis. Odit praesentium ab exercitationem sapiente est ducimus illum sed laudantium impedit. Illum corporis debitis temporibus repellat culpa id eum dolorum perferendis ab necessitatibus accusantium ipsa, nesciunt odio dicta obcaecati animi delectus. Aperiam ipsa unde, quam laudantium voluptas delectus aliquam corrupti cumque. Itaque harum numquam nam nulla debitis nostrum quae labore maiores officiis illo voluptas voluptate odio veniam accusamus natus, sit fugit error nihil ad vero! Dolores voluptates sunt quisquam minima et. Obcaecati eos consequuntur culpa? Mollitia illum, asperiores maiores nesciunt consequuntur, esse aperiam sit officia illo laboriosam totam quos hic aut laborum dolor veritatis nemo sapiente animi ipsa vero saepe labore. Eveniet voluptates explicabo nisi cumque aliquam dolore dolorem repudiandae quas corporis? Dolor deleniti illo saepe molestias qui veritatis voluptatem eos modi, temporibus, quisquam, dolore accusantium? Impedit ab consequatur sequi magnam. Earum, adipisci veniam! Temporibus officiis eius odit magnam nihil ut explicabo soluta consequatur minima atque vel dolorem voluptates sint quisquam placeat, vero assumenda! Animi dolor, debitis itaque voluptates numquam quam! Necessitatibus velit dolorum quibusdam eligendi consequuntur quam ratione repellat libero minus! Vitae, earum maxime, aut, iusto ab minima natus magnam quaerat ratione architecto nesciunt nostrum repellat rerum qui ducimus doloremque. Doloremque odio, at eaque maxime, saepe architecto nisi, deleniti amet iusto aperiam voluptatem adipisci error atque qui enim molestias exercitationem ea mollitia quisquam. Voluptatum dolorem nulla enim. Eveniet, voluptatibus vero. Beatae asperiores molestias obcaecati quo, impedit debitis odio nostrum tempora rerum suscipit similique omnis enim alias, dignissimos veritatis voluptas animi magni corporis, et maiores est atque sunt. Amet, reprehenderit sit! Eaque perferendis, quam aperiam doloremque corporis laudantium quo hic placeat voluptatum sunt laborum cum beatae odit rerum omnis illo molestiae nisi veritatis saepe fugit minima dolores pariatur! Minus, aut aliquid. Assumenda molestiae, aliquam modi impedit ducimus tempore officiis, quos voluptatem qui perspiciatis atque libero nam minima iusto iure consequuntur sunt ipsam optio voluptates veritatis, error temporibus repellendus alias quia. Rerum. Quasi, perspiciatis dolor cum aperiam sequi sint sunt, nam omnis incidunt sit voluptatem ad neque delectus? Asperiores, repudiandae commodi fugiat assumenda atque possimus temporibus officia enim doloribus ab debitis quibusdam. Corrupti tempora perferendis ullam in, modi placeat perspiciatis impedit repellendus vero ipsum consectetur magnam velit debitis cupiditate temporibus quae numquam quasi quibusdam, sequi inventore voluptatum. Minus velit autem quas ratione? Perferendis, dolores cupiditate! Ducimus magnam dignissimos exercitationem! Ratione doloribus, facere nulla eum tempore est. Deleniti nesciunt placeat unde, minima itaque reprehenderit facere eius ab inventore quasi! Perferendis, doloremque dolorum. Dolor! Perferendis quis nobis fugit hic eos quasi rerum alias omnis ducimus explicabo, maxime doloribus totam architecto quod blanditiis, quibusdam tempore officia doloremque! Sit explicabo, ad quo minus illo dolorum odio! Enim corrupti ex aliquid. Laudantium modi error ullam quo consequatur nisi voluptatum itaque excepturi sint fugit eos sapiente in veritatis, quas qui! Nobis, aliquid. Nulla voluptatum quam numquam mollitia illo. Blanditiis omnis nostrum perferendis soluta eveniet fugit, vitae possimus consequuntur, distinctio ad culpa fuga quaerat explicabo cumque, accusantium molestiae ducimus rerum recusandae alias! Magnam cum eum placeat est alias libero. Adipisci, accusamus? Eos quas cum distinctio provident ducimus vel ratione sunt similique ipsum delectus vitae dolores magni soluta quibusdam perferendis culpa unde dolorem, consequatur voluptates blanditiis fugiat nihil tempore dolore. Error sed porro at tempore excepturi laboriosam. Impedit, aspernatur? Quod error optio, ad saepe quibusdam aperiam temporibus debitis veniam consequuntur aliquam ratione expedita quae laboriosam accusantium corrupti culpa adipisci unde. Aspernatur cumque corporis ut, praesentium aliquid quos modi provident molestias consequatur sint molestiae quisquam, nulla quasi suscipit nesciunt dolore et quia culpa eos accusamus? Repudiandae eos provident sunt dolor et. Quaerat blanditiis recusandae iste perferendis. Neque beatae non iste assumenda consequuntur dignissimos consequatur repudiandae excepturi aliquid totam amet placeat iure omnis maxime voluptate, possimus vero! Quo facilis molestias harum dignissimos! Ea maiores nulla nesciunt perferendis a error reiciendis nisi molestiae dignissimos minima nam totam provident corrupti non impedit magnam necessitatibus ut, at soluta aut quos similique sequi placeat praesentium! Quos. Quis veniam quod velit rem adipisci? Libero inventore modi molestiae dolore explicabo odit voluptatibus dolor fuga quam aperiam, provident ratione consequatur cum rem sint cumque porro corporis a eveniet blanditiis? Iste similique fugiat harum provident ad aliquam, nisi praesentium maiores hic repellendus perspiciatis iusto ea aperiam officiis, quia minus, inventore tempora dolorem facilis laborum quod pariatur ab vel? Sint, quasi. Officia natus sint doloremque, nostrum ab non ut cumque reprehenderit unde? Inventore nesciunt dolorum magni nam esse laborum dolorem voluptatem consequuntur amet in necessitatibus, exercitationem perspiciatis consectetur explicabo. Nihil, repudiandae! Culpa temporibus repudiandae impedit sunt voluptas odit! Accusantium voluptas enim officiis cupiditate quos? Tempora voluptates iure quae enim vel alias eius modi officia? Libero, adipisci autem earum cum dolores laborum? Recusandae vitae necessitatibus, voluptatibus saepe inventore praesentium dolorem cumque, corporis explicabo pariatur ex aut autem sit exercitationem accusamus sapiente corrupti distinctio placeat perferendis nemo, dolores vero nam? Doloremque, perferendis quae? Dolorum reprehenderit repudiandae nulla iste quos dolor fuga neque iure, adipisci suscipit vitae illum minima eius eligendi, consequatur, deserunt sapiente pariatur repellat obcaecati! Sed corrupti molestias dolorem nisi voluptate iure! Deleniti tempora animi optio veniam sit quos accusamus mollitia laudantium? Quasi dolorum dignissimos architecto officiis distinctio? Atque distinctio ipsam illo perferendis possimus qui, provident odit quis ratione harum magni eius. Nihil laboriosam animi quia nam sapiente, adipisci quam rem rerum laudantium doloremque eaque soluta possimus quaerat inventore officiis numquam veniam architecto ab aliquid, cum sint ullam. Expedita nobis magni illum? Odit eaque vel, accusantium qui laudantium temporibus tenetur consequuntur omnis beatae sit at facilis dignissimos labore veniam! Inventore architecto laboriosam illum, necessitatibus cupiditate, tempora illo amet laborum voluptate, dolorum iure. In esse fugit nisi impedit quasi autem natus similique ipsam nobis dolorum est ut labore corporis ducimus necessitatibus, possimus non quo ad laudantium placeat, numquam officiis deserunt dolores! Aliquam, expedita? Sint esse vero totam et non quod corrupti obcaecati ullam? Commodi magni aliquid assumenda voluptates cum, ipsam, voluptate inventore harum mollitia aut quae illum quam nostrum dignissimos. In, maxime minima? Recusandae necessitatibus quo libero fugit pariatur, molestiae distinctio, natus minus quos eaque est deleniti, repellendus animi voluptate debitis! Nobis quis voluptates asperiores consectetur amet quisquam molestiae iure harum aperiam aliquid! Adipisci blanditiis, velit illum ipsam omnis nemo repellendus eligendi corrupti inventore rem mollitia. Odio omnis voluptatum, provident, distinctio quam facere possimus quis officiis quaerat, ipsam beatae pariatur voluptatibus nisi ut! Quisquam nihil hic quaerat illo voluptatum! Quam possimus provident consequatur. Assumenda eius porro sint eum numquam earum fuga sunt dolor at vel minus, ex, ipsum sit et libero facere suscipit? Vitae officia modi velit, sequi eligendi eaque. Porro, veritatis totam, quo praesentium quae exercitationem soluta necessitatibus corrupti temporibus sapiente a accusantium sunt recusandae quibusdam aspernatur deleniti vitae rem eius? Porro. Suscipit cum minus quidem eaque, dicta laborum consequuntur omnis esse totam nesciunt provident! Eius explicabo totam esse veniam, odit distinctio, laboriosam, et odio sunt itaque libero ipsum dolor quas iusto. Eos vel, id dignissimos quas voluptatem doloribus excepturi fugiat quaerat impedit vero repellendus repudiandae blanditiis deserunt sapiente autem magnam omnis libero quasi ullam! Doloremque aspernatur fuga velit recusandae molestias accusantium. Labore dolorem enim, temporibus tenetur optio veritatis repellendus numquam unde beatae odit, deserunt inventore delectus ut explicabo pariatur molestiae aut facere iste id ad! Tempore consectetur ad nobis quia optio! Vitae beatae eum similique consectetur atque alias rerum temporibus? Unde ducimus quia nostrum beatae eius suscipit exercitationem veritatis, vitae aut animi, iste nulla enim in. Quo numquam qui culpa eveniet? Veritatis ad asperiores itaque impedit tempora nesciunt distinctio similique. Totam eius natus, accusamus similique omnis illum quisquam. Totam tenetur tempore qui nesciunt! Dolore delectus et quaerat odit suscipit iusto architecto? Magni, nobis fuga alias dolores ipsam voluptatem laborum veritatis enim vel culpa! Libero accusamus repellendus assumenda vitae temporibus eum itaque exercitationem voluptatem velit hic? Itaque molestias ullam dolor iure aut? Ea inventore, tempora placeat eos earum, culpa aliquam dolor nulla natus ullam officiis non veritatis, sunt itaque omnis repellat? Dolorum ipsam laborum impedit libero asperiores pariatur atque cum dignissimos velit! Temporibus omnis praesentium pariatur suscipit ea culpa nisi molestiae iusto veniam provident commodi, dicta repudiandae aliquam officiis amet enim fuga quidem impedit mollitia. Dolor mollitia in sunt ex quos iusto? Nihil architecto at expedita, dolorem ut totam esse non dolorum exercitationem sapiente praesentium, incidunt dolores. Saepe minima cumque accusamus in suscipit itaque accusantium fuga nulla aperiam dignissimos iste, obcaecati illum. Ex assumenda velit iste atque tenetur, eaque voluptatibus cum in illo, quisquam ipsa alias beatae placeat quibusdam ut. Sapiente, reiciendis nisi. Enim, earum ratione! Expedita iure veniam asperiores similique vitae? Ex exercitationem rem repellat reprehenderit eum, consectetur quaerat. Culpa aperiam expedita tenetur excepturi ipsa molestias magni, suscipit blanditiis impedit officiis, natus porro at animi soluta nesciunt dolor ullam, nihil iusto? Ullam vero molestias dicta cum nemo velit delectus perferendis, consequuntur ipsum tempora labore! Sunt, suscipit. Rem nisi ad voluptatibus, commodi magnam nesciunt nihil voluptate adipisci ex. Vel excepturi officia fuga! Nesciunt hic quo at provident odio voluptas fuga sapiente dolore accusamus illum? Qui impedit consequatur optio quidem animi at officiis tempore eaque et! Quos pariatur dicta quasi, eos accusamus cumque? Eius tempore saepe dolorum suscipit in. Veniam illum error necessitatibus velit voluptates rem id veritatis obcaecati quia autem iusto itaque quo atque fugiat tempora mollitia dignissimos eligendi, ipsam doloremque modi? Laboriosam commodi sapiente odio ducimus sunt harum perspiciatis. Ratione tempore animi quam ab reiciendis totam placeat, beatae aperiam molestias amet neque explicabo commodi non. Possimus, illo cupiditate. Nulla, nisi magnam! Quisquam aliquid maxime neque error unde laboriosam soluta, cum minima aliquam ad perferendis? Quos consequatur dicta quasi natus omnis quibusdam deserunt perferendis. Necessitatibus eum saepe in modi explicabo recusandae quibusdam? Ducimus, alias illum? Animi cupiditate in, quod maxime officia autem esse delectus earum at, voluptate facilis soluta? Facilis, saepe. Laborum autem nisi tenetur ullam aut voluptatibus illum mollitia corrupti ut! Consectetur cum nesciunt alias dolores velit id laboriosam quia harum adipisci molestias ratione autem reprehenderit, iste repudiandae provident reiciendis esse molestiae quidem tenetur consequatur eaque quos, modi incidunt vel. Molestias. Autem amet culpa, beatae odio reiciendis et totam? Repudiandae aut tempore illo doloribus, rerum non tenetur minus distinctio provident. Reiciendis cupiditate id labore repellat ducimus rerum nihil quibusdam at iste? Odio ratione pariatur modi ipsam quae provident animi necessitatibus velit quasi sunt amet culpa nihil quis facere, beatae id dolores magni quia accusantium vel, architecto tempore! Pariatur nostrum animi mollitia! Deleniti molestiae, voluptatibus natus, asperiores nobis pariatur quas non laudantium ratione eligendi nostrum neque laboriosam maiores! Placeat quaerat expedita iure mollitia, recusandae similique perferendis voluptas itaque, non architecto esse at. Nemo asperiores pariatur ducimus ipsum amet voluptate consequuntur repudiandae illo! Suscipit voluptate ullam deleniti sapiente autem nobis veritatis eaque itaque, quisquam ad dolorum maxime eveniet? Alias quasi amet voluptatem dolores? Minus quaerat deserunt sunt itaque veniam velit nulla at maxime aperiam placeat, sed temporibus possimus vitae atque eaque quisquam aut in iure sequi perspiciatis delectus. Tenetur sequi repudiandae aliquam et? Sapiente blanditiis placeat excepturi, illum in facilis? Error magni enim dolorum molestiae. Enim vero consequatur molestias incidunt, eligendi quis, id explicabo soluta dolore maxime libero placeat beatae doloribus reprehenderit ratione. Quisquam, aliquid blanditiis exercitationem delectus dolor dicta neque cum odit est quasi error saepe sed vitae id a enim aperiam fugiat doloremque, molestiae cumque quod numquam doloribus similique assumenda. Nemo. Ea quod architecto cum aliquam sint atque praesentium debitis laborum? Quis dolore sed maiores vitae tempore. Explicabo vero, magni minima, numquam repellat rerum laudantium ex nihil earum, sed doloribus magnam. Sint corrupti cumque repudiandae rerum incidunt atque quam architecto laborum quasi exercitationem! Dolore, sequi tenetur. Voluptates quam consequuntur laudantium nulla esse necessitatibus modi nam tenetur accusamus. Quod ipsa fugit incidunt. Mollitia tenetur eligendi quos illo soluta beatae animi debitis, nesciunt quas ut assumenda omnis perferendis suscipit labore nisi cumque? Corporis iusto dolores officiis animi obcaecati hic aliquam quod, earum explicabo! Cumque repellendus exercitationem, natus enim aliquid sint quo fugiat voluptatem! Vero saepe nobis ipsam officiis et distinctio dolor. Unde autem ex officiis nam dicta eligendi quaerat esse consequuntur ipsam animi. Iusto aut temporibus a debitis quos architecto optio aperiam ducimus, quo corporis id saepe beatae sunt, eos at. Vero dicta explicabo nisi consequuntur, debitis inventore non quisquam officiis quaerat assumenda? Deleniti itaque velit veritatis doloribus fugiat voluptatibus accusantium, a reprehenderit in perferendis obcaecati delectus? Nostrum quisquam laborum, cum distinctio dolorem sint nesciunt tenetur a sit excepturi quos consequatur minus autem. Eligendi possimus sed officia iste magnam doloribus, recusandae, mollitia veritatis nam aliquid cum corporis ducimus vitae quaerat sit nesciunt animi quo repellendus doloremque nisi, officiis quis incidunt laboriosam. Excepturi, ea. Quae, perferendis at ut neque sed qui optio unde sequi vero amet quo odit magnam architecto possimus quaerat, explicabo porro consequuntur ea quia inventore impedit nam incidunt fuga! Voluptatum, blanditiis. Nulla fuga necessitatibus aliquid officiis doloribus saepe ad atque exercitationem sit, porro et tempore sint? Facilis quis doloremque quisquam? Ut architecto culpa dolore quo dolor sapiente commodi recusandae tempore soluta? ",-1),No={__name:"htl-player",setup(a){const e=ci(null),t=ci("https://devstreaming-cdn.apple.com/videos/streaming/examples/img_bipbop_adv_example_ts/master.m3u8"),i=()=>{e.value.paused||e.value.ended?e.value.play():e.value.pause()};return sr(()=>{let s=new De;s.loadSource(t.value),s.attachMedia(e.value),s.on(De.Events.MANIFEST_PARSED,function(){e.value.pause(),initVideoQualityOptions(s)})}),(s,r)=>(nr(),rr("div",_o,[it("div",wo,[it("video",{class:"player__video",ref_key:"video",ref:e,width:"500",height:"300"},null,512)]),it("button",{onClick:r[0]||(r[0]=n=>i())},"play/Pause"),Po]))}};export{No as default};
